<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MECCHTAR Responder App - Pager Webapp v3.1.0</title>
    
    <!-- PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="MECCHTAR">
    <meta name="application-name" content="MECCHTAR Responder">
    <meta name="theme-color" content="#dc2626">
    <meta name="msapplication-TileColor" content="#dc2626">
    <meta name="msapplication-navbutton-color" content="#dc2626">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIk1FQ0NIVEFSIFJlc3BvbmRlciIsCiAgInNob3J0X25hbWUiOiAiUmVzcG9uZGVyIiwKICAiZGVzY3JpcHRpb24iOiAiTUVDQ0hUQVIgRW1lcmdlbmN5IE1lZGljYWwgUmVzcG9uc2UgQXBwbGljYXRpb24iLAogICJzdGFydF91cmwiOiAiLiIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgIm9yaWVudGF0aW9uIjogInBvcnRyYWl0IiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjMWUyOTNiIiwKICAidGhlbWVfY29sb3IiOiAiI2RjMjYyNiIsCiAgImljb25zIjogWwogICAgewogICAgICAic3JjIjogImh0dHBzOi8vY2RuLWljb25zLXBuZy5mbGF0aWNvbi5jb20vNTEyLzI5NjYvMjk2NjMyNy5wbmciLAogICAgICAic2l6ZXMiOiAiMTkyeDE5MiIsCiAgICAgICJ0eXBlIjogImltYWdlL3BuZyIsCiAgICAgICJwdXJwb3NlIjogImFueSBtYXNrYWJsZSIKICAgIH0sCiAgICB7CiAgICAgICJzcmMiOiAiaHR0cHM6Ly9jZG4taWNvbnMtcG5nLmZsYXRpY29uLmNvbS81MTIvMjk2Ni8yOTY2MzI3LnBuZyIsCiAgICAgICJzaXplcyI6ICI1MTJ4NTEyIiwKICAgICAgInR5cGUiOiAiaW1hZ2UvcG5nIiwKICAgICAgInB1cnBvc2UiOiAiYW55IG1hc2thYmxlIgogICAgfQogIF0sCiAgImNhdGVnb3JpZXMiOiBbIm1lZGljYWwiLCAidXRpbGl0aWVzIl0sCiAgImxhbmciOiAibXMtTVkiCn0=">
    
    <!-- iOS Icons -->
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2966/2966327.png">
    <link rel="apple-touch-icon" sizes="152x152" href="https://cdn-icons-png.flaticon.com/512/2966/2966327.png">
    <link rel="apple-touch-icon" sizes="180x180" href="https://cdn-icons-png.flaticon.com/512/2966/2966327.png">
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" sizes="32x32" href="https://cdn-icons-png.flaticon.com/512/2966/2966327.png">
    
    <style>
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           PART 1: FOUNDATION - CSS Variables & Reset
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg: #f3f6fb;
            --card: #ffffff;
            --accent: #1f4b8f;
            --accent-2: #2b6fb5;
            --muted: #6b7280;
            --success: #16a34a;
            --danger: #dc2626;
            --warning: #f59e0b;
            --info: #3b82f6;
            --purple: #8b5cf6;
            --text-primary: #0f172a;
            --border: #e5e7eb;
            --shadow-sm: 0 3px 10px rgba(0,0,0,0.05);
            --shadow-md: 0 6px 20px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 30px rgba(0,0,0,0.15);
            --radius: 12px;
        }

        body {
            font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, sans-serif;
            background: var(--bg);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
        }

        .hidden { display: none !important; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           HEADER STYLES
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .header {
            background: linear-gradient(135deg, var(--accent), var(--accent-2));
            color: white;
            padding: 14px 20px;
            box-shadow: var(--shadow-md);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
            gap: 15px;
            flex-wrap: wrap;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .logo {
            width: 48px;
            height: 48px;
            background: rgba(255,255,255,0.2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .header-title {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .header-subtitle {
            font-size: 0.75rem;
            opacity: 0.9;
        }

        .mode-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            margin-left: 10px;
        }

        .mode-badge.demo { background: var(--warning); }
        .mode-badge.live { background: var(--success); }

        .live-clock {
            display: flex;
            flex-direction: column;
            font-family: 'Courier New', monospace;
            text-align: right;
        }

        .clock-time {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .clock-date {
            font-size: 0.7rem;
            opacity: 0.9;
        }

        .unit-badge {
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 8px;
            text-align: center;
        }

        .unit-id {
            font-size: 1.3rem;
            font-weight: 800;
            display: block;
        }

        .unit-crew {
            font-size: 0.7rem;
            opacity: 0.9;
        }

        .status-indicator {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .status-available { background: var(--success); }
        .status-active { background: var(--warning); animation: pulse-status 2s infinite; }
        .status-busy { background: var(--danger); }

        @keyframes pulse-status {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           FORM STYLES
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .form-group { margin-bottom: 20px; }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .required { color: var(--danger); }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 10px;
            font-size: 1rem;
            background: white;
            transition: all 0.3s;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            border-color: var(--accent);
            outline: none;
            box-shadow: 0 0 0 3px rgba(31, 75, 143, 0.1);
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           BUTTON STYLES
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .btn:active { transform: translateY(0); }
        
        .btn-primary { background: linear-gradient(135deg, var(--accent), var(--accent-2)); color: white; }
        .btn-success { background: linear-gradient(135deg, var(--success), #22c55e); color: white; }
        .btn-danger { background: linear-gradient(135deg, var(--danger), #ef4444); color: white; }
        .btn-warning { background: linear-gradient(135deg, var(--warning), #fbbf24); color: white; }
        .btn-info { background: linear-gradient(135deg, var(--info), #60a5fa); color: white; }
        .btn-purple { background: linear-gradient(135deg, var(--purple), #a78bfa); color: white; }
        .btn-outline { background: transparent; border: 2px solid var(--border); color: var(--text-primary); }
        .btn-outline:hover { background: var(--bg); }
        
        .btn-sm { padding: 8px 16px; font-size: 0.85rem; }
        .btn-lg { padding: 16px 32px; font-size: 1.1rem; }
        .btn-block { width: 100%; }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           CARD STYLES
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .card {
            background: var(--card);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--bg);
        }
        
        .card-title {
            font-size: 1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            font-weight: 800;
            font-size: 17px;
            padding: 12px 16px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--accent), var(--accent-2));
            color: #fff;
            box-shadow: 0 4px 12px rgba(31, 75, 143, 0.2);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           TOAST NOTIFICATION SYSTEM
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            padding: 14px 20px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 280px;
            max-width: 380px;
            box-shadow: var(--shadow-lg);
            animation: slideIn 0.3s ease, fadeOut 0.3s ease 2.7s;
            font-weight: 600;
            font-size: 0.9rem;
            color: white;
        }

        .toast.success { background: linear-gradient(135deg, var(--success), #22c55e); }
        .toast.warning { background: linear-gradient(135deg, var(--warning), #fbbf24); }
        .toast.error { background: linear-gradient(135deg, var(--danger), #ef4444); }
        .toast.info { background: linear-gradient(135deg, var(--info), #60a5fa); }

        .toast-icon { font-size: 22px; }
        .toast-content { flex: 1; }
        .toast-title { font-weight: 700; font-size: 0.95rem; }
        .toast-message { font-size: 0.85rem; opacity: 0.95; }

        @keyframes slideIn {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeOut {
            to { opacity: 0; transform: translateX(100px); }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           MODAL STYLES
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius);
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            transform: scale(0.9);
            transition: transform 0.3s;
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        .modal-header {
            padding: 20px;
            border-radius: var(--radius) var(--radius) 0 0;
            font-weight: 700;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
            color: white;
            background: linear-gradient(135deg, var(--accent), var(--accent-2));
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 15px 20px;
            border-top: 2px solid var(--bg);
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           LOGIN SCREEN STYLES
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .login-screen {
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 50%, #1f4b8f 100%);
        }

        .login-card {
            background: white;
            border-radius: 16px;
            padding: 40px;
            width: 100%;
            max-width: 450px;
            box-shadow: var(--shadow-lg);
        }

        .login-logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--accent), var(--accent-2));
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 36px;
            color: white;
            margin: 0 auto 20px;
        }

        .login-title {
            text-align: center;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--accent);
        }

        .login-subtitle {
            text-align: center;
            color: var(--muted);
            font-size: 0.9rem;
            margin-bottom: 30px;
        }

        .login-options {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .login-option {
            flex: 1;
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .login-option:hover {
            border-color: var(--accent);
            background: var(--bg);
        }

        .login-option.active {
            border-color: var(--accent);
            background: linear-gradient(135deg, rgba(31, 75, 143, 0.1), rgba(43, 111, 181, 0.1));
        }

        .login-option-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .login-option-label {
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           MAIN CONTAINER & LAYOUT
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 900px) {
            .grid-2 { grid-template-columns: 1fr; }
            .header-content { flex-direction: column; gap: 10px; }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           INITIAL MENU (AFTER LOGIN)
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .initial-menu {
            padding: 30px 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        .menu-card {
            background: white;
            border-radius: var(--radius);
            padding: 25px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: var(--shadow-sm);
            border: 3px solid transparent;
            margin-bottom: 15px;
        }

        .menu-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
        }

        .menu-card.waiting {
            border-color: var(--warning);
            background: linear-gradient(135deg, #fffbeb, #fef3c7);
        }

        .menu-card.waiting:hover {
            border-color: #d97706;
        }

        .menu-card-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .menu-card-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .menu-card-subtitle {
            font-size: 0.85rem;
            color: var(--muted);
        }

        .pending-badge {
            display: inline-block;
            background: var(--danger);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            margin-top: 10px;
            animation: pulse-badge 2s infinite;
        }

        @keyframes pulse-badge {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           TIMER DISPLAYS
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .timer-display {
            font-family: 'Courier New', monospace;
            font-size: 2rem;
            font-weight: 700;
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            background: var(--bg);
        }

        .timer-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            margin-bottom: 5px;
            color: var(--muted);
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           INFO DISPLAY GRID
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }

        .info-item {
            background: var(--bg);
            padding: 12px;
            border-radius: 8px;
        }

        .info-label {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--muted);
            margin-bottom: 4px;
        }

        .info-value {
            font-size: 0.95rem;
            font-weight: 600;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           MESSAGING MENU STYLES
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .messaging-container {
            position: relative;
        }

        .messaging-button {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
        }

        .messaging-button:hover {
            background: rgba(255,255,255,0.3);
        }

        .messaging-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border-radius: 10px;
            box-shadow: var(--shadow-lg);
            width: 220px;
            margin-top: 8px;
            z-index: 1001;
            display: none;
        }

        .messaging-dropdown.active {
            display: block;
        }

        .messaging-option {
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: background 0.2s;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        .messaging-option:first-child {
            border-radius: 10px 10px 0 0;
        }

        .messaging-option:last-child {
            border-radius: 0 0 10px 10px;
        }

        .messaging-option:hover {
            background: var(--bg);
        }

        .messaging-icon {
            font-size: 20px;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           PHASE TRACKER STYLES
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .phase-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 8px;
            transition: all 0.3s;
            background: var(--bg);
            border: 2px solid transparent;
        }

        .phase-item.completed {
            background: linear-gradient(135deg, #ecfdf5, #d1fae5);
            border-color: var(--success);
        }

        .phase-item.active {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border-color: var(--warning);
            animation: phase-pulse 2s infinite;
        }

        .phase-item.pending {
            background: var(--bg);
            opacity: 0.6;
        }

        .phase-item.overridden {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
            border-color: var(--danger);
        }

        @keyframes phase-pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(245, 158, 11, 0); }
        }

        .phase-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-right: 12px;
            background: white;
            box-shadow: var(--shadow-sm);
        }

        .phase-item.completed .phase-icon {
            background: var(--success);
            color: white;
        }

        .phase-item.active .phase-icon {
            background: var(--warning);
            color: white;
        }

        .phase-info {
            flex: 1;
        }

        .phase-name {
            font-weight: 700;
            font-size: 0.95rem;
        }

        .phase-time {
            font-size: 0.8rem;
            color: var(--muted);
        }

        .phase-duration {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 10px;
            background: rgba(0,0,0,0.1);
        }

        .phase-duration.on-target {
            background: var(--success);
            color: white;
        }

        .phase-duration.over-target {
            background: var(--danger);
            color: white;
        }

        .phase-action {
            margin-left: 10px;
        }

        .override-badge {
            font-size: 0.65rem;
            background: var(--danger);
            color: white;
            padding: 2px 6px;
            border-radius: 8px;
            font-weight: 700;
            margin-left: 8px;
        }

        /* Target time indicator */
        .target-indicator {
            font-size: 0.7rem;
            color: var(--muted);
            margin-top: 2px;
        }

        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           OVERRIDE REASON OPTION STYLES
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        .override-reason-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            background: var(--bg);
            border-radius: 10px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .override-reason-option:hover {
            border-color: var(--accent);
            background: white;
        }

        .override-reason-option input[type="radio"] {
            width: 18px;
            height: 18px;
        }

        .override-reason-option input[type="radio"]:checked ~ * {
            color: var(--accent);
        }

        .override-reason-icon {
            font-size: 24px;
        }

        .override-reason-title {
            font-weight: 700;
            font-size: 0.95rem;
        }

        .override-reason-desc {
            font-size: 0.8rem;
            color: var(--muted);
        }
    </style>
</head>
<body>
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         TOAST CONTAINER
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         LOGIN SCREEN
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="loginScreen" class="login-screen">
        <div class="login-card">
            <div class="login-logo">ğŸš‘</div>
            <h1 class="login-title">MECCHTAR Responder</h1>
            <p class="login-subtitle">Pager Webapp untuk Krew Ambulans<br>Ambulance Crew Pager Webapp</p>

            <!-- Mode Selection -->
            <div class="login-options" id="modeOptions">
                <div class="login-option active" data-mode="demo" onclick="selectMode('demo')">
                    <div class="login-option-icon">ğŸ§ª</div>
                    <div class="login-option-label">Demo Mode</div>
                </div>
                <div class="login-option" data-mode="live" onclick="selectMode('live')">
                    <div class="login-option-icon">ğŸ“¡</div>
                    <div class="login-option-label">Live Mode</div>
                </div>
            </div>

            <form onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label">ğŸš‘ Unit ID <span class="required">*</span></label>
                    <select id="loginUnitId" class="form-select" required>
                        <option value="">-- Pilih Unit / Select Unit --</option>
                        <optgroup label="ğŸ¥ HTAR Ambulances">
                            <option value="HTAR1">HTAR1</option>
                            <option value="HTAR2">HTAR2</option>
                            <option value="HTAR3">HTAR3</option>
                            <option value="HTAR4">HTAR4</option>
                            <option value="HTAR5">HTAR5</option>
                        </optgroup>
                        <optgroup label="ğŸ¥ Hospital Shah Alam">
                            <option value="HSAS1">HSAS1</option>
                            <option value="HSAS2">HSAS2</option>
                            <option value="HSAS3">HSAS3</option>
                            <option value="HSAS4">HSAS4</option>
                        </optgroup>
                        <optgroup label="ğŸ¥ Hospital Banting">
                            <option value="HBanting1">HBanting1</option>
                            <option value="HBanting2">HBanting2</option>
                            <option value="HBanting3">HBanting3</option>
                        </optgroup>
                        <optgroup label="ğŸª Klinik Kesihatan">
                            <option value="KKKapar">KK Kapar</option>
                            <option value="KKMeru">KK Meru</option>
                            <option value="KKPIndah">KK P.Indah</option>
                            <option value="KKPelabuhan">KK Pelabuhan</option>
                            <option value="KKBBotani">KK B.Botani</option>
                            <option value="KKRPanjang">KK R.Panjang</option>
                            <option value="KKPandamaran">KK Pandamaran</option>
                            <option value="KKAnika">KK Anika</option>
                            <option value="KKBKuda">KK B.Kuda</option>
                            <option value="KKBNaga">KK B.Naga</option>
                            <option value="KKTSepat">KK Tanjung Sepat</option>
                            <option value="KKBandar">KK Bandar</option>
                            <option value="KKBCanggang">KK B.Canggang</option>
                            <option value="KKJenjarom">KK Jenjarom</option>
                            <option value="TPGarang">TP Garang</option>
                        </optgroup>
                        <optgroup label="ğŸš‘ SJAM">
                            <option value="SJAM1">SJAM1</option>
                        </optgroup>
                        <optgroup label="â­ Special Teams">
                            <option value="CPERT">CPERT</option>
                        </optgroup>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">ğŸ‘¤ Staff ID <span class="required">*</span></label>
                    <input type="text" id="loginStaffId" class="form-input" placeholder="e.g., HTAR1, HSAS1, KKMeru" required>
                    <small style="color: var(--muted); font-size: 0.75rem;">Staff ID usually matches Unit ID</small>
                </div>

                <div class="form-group">
                    <label class="form-label">ğŸ”‘ Password <span class="required">*</span></label>
                    <input type="password" id="loginPassword" class="form-input" placeholder="Enter password" required>
                </div>

                <div class="form-group">
                    <label class="form-label">ğŸ‘¥ Crew Name / Nama Krew <span class="required">*</span></label>
                    <input type="text" id="loginCrewName" class="form-input" placeholder="e.g., Ahmad & Siti" required>
                </div>

                <div class="form-group">
                    <label class="form-label">â° Shift</label>
                    <select id="loginShift" class="form-select">
                        <option value="AM">Pagi / Morning (0700-1400)</option>
                        <option value="PM">Petang / Evening (1400-2100)</option>
                        <option value="NIGHT">Malam / Night (2100-0700)</option>
                    </select>
                </div>

                <button type="submit" class="btn btn-primary btn-block btn-lg">
                    ğŸ” Log Masuk / Login
                </button>
            </form>

            <!-- Quick Demo Login -->
            <div style="margin-top: 15px;">
                <button type="button" onclick="quickDemoLogin()" class="btn btn-warning btn-block" style="font-size: 0.9rem;">
                    âš¡ Quick Demo Login (Auto-fill)
                </button>
            </div>

            <div style="margin-top: 15px; text-align: center;">
                <p style="font-size: 0.8rem; color: var(--muted);">
                    Demo Mode: Gunakan sebarang kredensial untuk login<br>
                    <em>Use any credentials to login in Demo Mode</em>
                </p>
                <p style="font-size: 0.75rem; color: var(--danger); margin-top: 8px;">
                    âš ï¸ Jika masalah login, klik butang di bawah untuk reset:<br>
                    <button onclick="clearLocalStorage()" style="margin-top: 5px; padding: 5px 10px; font-size: 0.75rem; cursor: pointer;">
                        ğŸ—‘ï¸ Clear Session Data
                    </button>
                </p>
                
                <!-- Install App Link -->
                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border);">
                    <button onclick="installApp()" style="background: none; border: none; color: var(--accent); cursor: pointer; font-size: 0.85rem; text-decoration: underline;">
                        ğŸ“² Install App ke Home Screen
                    </button>
                </div>
                
                <!-- Version Badge -->
                <div id="loginVersionBadge" style="margin-top: 15px; font-size: 0.7rem; color: var(--muted);">
                    Loading version...
                </div>
            </div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         MAIN APP (HEADER + CONTENT)
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="mainApp" class="hidden">
        <!-- HEADER -->
        <header class="header">
            <div class="header-content">
                <div class="header-left">
                    <div class="logo">ğŸš‘</div>
                    <div>
                        <div class="header-title">
                            MECCHTAR Responder
                            <span id="modeBadge" class="mode-badge demo">DEMO</span>
                        </div>
                        <div class="header-subtitle" id="headerVersion">Pager Webapp v3.1.0</div>
                    </div>
                </div>

                <div class="live-clock">
                    <div id="liveClock" class="clock-time">--:--:--</div>
                    <div id="liveDate" class="clock-date">--- -- ---</div>
                </div>

                <div class="unit-badge">
                    <span id="unitDisplay" class="unit-id">---</span>
                    <span id="crewDisplay" class="unit-crew">---</span>
                </div>

                <span id="statusIndicator" class="status-indicator status-available">AVAILABLE</span>

                <!-- Messaging Menu -->
                <div class="messaging-container">
                    <button class="messaging-button" onclick="toggleMessagingMenu()">
                        ğŸ’¬ Mesej
                        <span style="font-size: 12px;">â–¼</span>
                    </button>
                    <div id="messagingDropdown" class="messaging-dropdown" style="min-width: 220px;">
                        <!-- Quick WhatsApp Contacts -->
                        <div style="padding: 6px 10px; font-size: 0.7rem; color: var(--muted); border-bottom: 1px solid var(--border); font-weight: 600;">
                            ğŸ“² WhatsApp Terus / Direct
                        </div>
                        <div class="messaging-option" onclick="quickWhatsApp('601162621386', 'MECC Dispatcher 1')">
                            <span class="messaging-icon">ğŸ“¡</span>
                            <span>MECC Dispatcher 1</span>
                            <span style="margin-left: auto; color: #25D366;">ğŸ’¬</span>
                        </div>
                        <div class="messaging-option" onclick="quickWhatsApp('601162621390', 'MECC Dispatcher 2')">
                            <span class="messaging-icon">ğŸ“¡</span>
                            <span>MECC Dispatcher 2</span>
                            <span style="margin-left: auto; color: #25D366;">ğŸ’¬</span>
                        </div>
                        <div class="messaging-option" onclick="quickWhatsApp('60109219391', 'Supervisor PHCAS')">
                            <span class="messaging-icon">ğŸ‘”</span>
                            <span>Supervisor PHCAS</span>
                            <span style="margin-left: auto; color: #25D366;">ğŸ’¬</span>
                        </div>
                        <div class="messaging-option" onclick="quickWhatsApp('60109209391', 'Supervisor ED')">
                            <span class="messaging-icon">ğŸ‘”</span>
                            <span>Supervisor ED</span>
                            <span style="margin-left: auto; color: #25D366;">ğŸ’¬</span>
                        </div>
                        <div class="messaging-option" onclick="quickWhatsApp('60109229391', 'CPERT')">
                            <span class="messaging-icon">â­</span>
                            <span>CPERT Team</span>
                            <span style="margin-left: auto; color: #25D366;">ğŸ’¬</span>
                        </div>
                        <div class="messaging-option" onclick="quickWhatsApp('60163119391', 'Dr Tajuddin')">
                            <span class="messaging-icon">ğŸ‘¨â€âš•ï¸</span>
                            <span>Dr Ahmad Tajuddin (JKT)</span>
                            <span style="margin-left: auto; color: #25D366;">ğŸ’¬</span>
                        </div>
                        
                        <!-- Divider -->
                        <div style="padding: 6px 10px; font-size: 0.7rem; color: var(--muted); border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); font-weight: 600; margin-top: 4px;">
                            âœ‰ï¸ Mesej Penuh / Full Message
                        </div>
                        <div class="messaging-option" onclick="openMessaging('dispatcher')">
                            <span class="messaging-icon">ğŸ“¡</span>
                            <span>Compose to Dispatcher</span>
                        </div>
                        <div class="messaging-option" onclick="openMessaging('hospital')">
                            <span class="messaging-icon">ğŸ¥</span>
                            <span>Compose to Hospital</span>
                        </div>
                        
                        <!-- Divider -->
                        <div style="padding: 6px 10px; font-size: 0.7rem; color: var(--muted); border-top: 1px solid var(--border); border-bottom: 1px solid var(--border); font-weight: 600; margin-top: 4px;">
                            ğŸ“ Lain-lain / Other
                        </div>
                        <div class="messaging-option" onclick="manualPingLocation()">
                            <span class="messaging-icon">ğŸ“</span>
                            <span>Ping Location Now</span>
                        </div>
                        <div class="messaging-option" onclick="openContactsDirectory(); closeMessagingMenu();">
                            <span class="messaging-icon">ğŸ“</span>
                            <span>Full Directory</span>
                        </div>
                    </div>
                </div>

                <!-- Navigation Buttons -->
                <div style="display: flex; gap: 6px;">
                    <button onclick="backToMenu()" title="Menu Utama" style="background: rgba(255,255,255,0.2); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 600;">
                        ğŸ  Menu
                    </button>
                    <button onclick="handleLogout()" title="Log Keluar" style="background: rgba(220, 38, 38, 0.8); color: white; border: none; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 600;">
                        ğŸšª Keluar
                    </button>
                </div>
            </div>
        </header>

        <!-- MAIN CONTENT AREA -->
        <div class="main-container">
            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                 INITIAL MENU (AFTER LOGIN)
                 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div id="initialMenu" class="initial-menu">
                <div class="section-title">
                    <span>ğŸ“‹</span>
                    <span>Menu Utama / Main Menu</span>
                </div>

                <!-- Pending Dispatch Alert -->
                <div id="pendingDispatchAlert" class="menu-card waiting hidden" onclick="viewPendingDispatch()">
                    <div class="menu-card-icon">ğŸš¨</div>
                    <div class="menu-card-title">Dispatch Menunggu!</div>
                    <div class="menu-card-subtitle">Incoming Dispatch Awaiting Response</div>
                    <div class="pending-badge">âš¡ LIHAT SEKARANG / VIEW NOW</div>
                </div>

                <!-- Demo Mode: Load Test Case -->
                <div id="testCaseMenu" class="menu-card" onclick="openTestCaseSelector()">
                    <div class="menu-card-icon">ğŸ§ª</div>
                    <div class="menu-card-title">Muat Kes Ujian</div>
                    <div class="menu-card-subtitle">Load Test Case (Demo Mode)</div>
                </div>

                <!-- Live Mode: Wait for Dispatch -->
                <div id="waitingForDispatchCard" class="menu-card hidden">
                    <div class="menu-card-icon">ğŸ“¡</div>
                    <div class="menu-card-title">Menunggu Dispatch...</div>
                    <div class="menu-card-subtitle">Waiting for dispatch from MECC</div>
                    <div style="margin-top: 15px;">
                        <div class="timer-label">Masa Menunggu / Wait Time</div>
                        <div id="waitingTimer" class="timer-display" style="font-size: 1.5rem;">00:00:00</div>
                    </div>
                </div>

                <!-- Import Dispatch Manual (Fallback when system is down) -->
                <div id="importDispatchCard" class="menu-card" onclick="openImportDispatch()">
                    <div class="menu-card-icon">ğŸ“¥</div>
                    <div class="menu-card-title">Import Manual</div>
                    <div class="menu-card-subtitle">Enter dispatch via WhatsApp/SMS</div>
                </div>

                <!-- Case History -->
                <div class="menu-card" onclick="openCaseHistory()">
                    <div class="menu-card-icon">ğŸ“œ</div>
                    <div class="menu-card-title">Sejarah Kes</div>
                    <div class="menu-card-subtitle">View Case History</div>
                </div>

                <!-- Contacts Directory -->
                <div class="menu-card" onclick="openContactsDirectory()">
                    <div class="menu-card-icon">ğŸ“</div>
                    <div class="menu-card-title">Direktori Kontak</div>
                    <div class="menu-card-subtitle">Contacts Directory</div>
                </div>

                <!-- Settings -->
                <div class="menu-card" onclick="openSettings()">
                    <div class="menu-card-icon">âš™ï¸</div>
                    <div class="menu-card-title">Tetapan</div>
                    <div class="menu-card-subtitle">Settings & Preferences</div>
                </div>
            </div>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                 DISPATCH ALERT SCREEN (Placeholder - Part 2)
                 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div id="dispatchAlert" class="hidden">
                <!-- Will be populated in Part 2 -->
            </div>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                 ACTIVE MISSION SCREEN
                 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div id="activeMission" class="hidden">
                <div class="grid-2">
                    <!-- LEFT COLUMN: Case Info & Phases -->
                    <div>
                        <!-- Case Summary Card -->
                        <div class="card" id="caseSummaryCard">
                            <div class="section-title" style="background: linear-gradient(135deg, var(--warning), #fbbf24);">
                                <span>ğŸš‘</span>
                                <span>MISI AKTIF / ACTIVE MISSION</span>
                            </div>
                            <div id="activeCaseSummary">
                                <!-- Populated dynamically -->
                            </div>
                        </div>

                        <!-- Phase Tracker Card -->
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">ğŸ“Š Mission Phases</div>
                                <button class="btn btn-danger btn-sm" onclick="openOverrideModal()">
                                    âš¡ Override
                                </button>
                            </div>
                            <div id="phaseTrackerContainer">
                                <!-- Phase items rendered here -->
                            </div>
                        </div>
                    </div>

                    <!-- RIGHT COLUMN: Timers & Actions -->
                    <div>
                        <!-- Timer Card -->
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">â±ï¸ Timers</div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <div class="timer-label">Mission Time</div>
                                    <div id="missionTimer" class="timer-display" style="background: linear-gradient(135deg, #fef3c7, #fde68a); color: #92400e;">00:00:00</div>
                                </div>
                                <div>
                                    <div class="timer-label">Current Phase</div>
                                    <div id="ongoingPhaseTimer" class="timer-display" style="background: linear-gradient(135deg, #dbeafe, #bfdbfe); color: #1e40af;">00:00</div>
                                </div>
                            </div>
                            <div style="margin-top: 15px;">
                                <div class="timer-label">Current Phase</div>
                                <div id="currentPhaseDisplay" style="font-size: 1.2rem; font-weight: 700; text-align: center; padding: 10px; background: var(--bg); border-radius: 8px;">
                                    ğŸ“± Acknowledge
                                </div>
                            </div>
                        </div>

                        <!-- Destination Card -->
                        <div class="card" id="destinationCard">
                            <div class="card-header">
                                <div class="card-title">ğŸ¥ Destination Hospital</div>
                            </div>
                            <div id="destinationDisplay" style="background: #ecfdf5; padding: 15px; border-radius: 10px; border: 2px solid var(--success);">
                                <div style="font-weight: 600;" id="currentDestination">-</div>
                                <div style="font-size: 0.85rem; color: var(--muted); margin-top: 5px;" id="destinationStatus">
                                    â³ Pending confirmation before transport
                                </div>
                            </div>
                            <div style="margin-top: 10px;" id="destinationActions">
                                <button class="btn btn-outline btn-sm btn-block" onclick="openDestinationModal()">
                                    ğŸ”„ Change Destination
                                </button>
                            </div>
                        </div>

                        <!-- Quick Actions Card -->
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">âš¡ Quick Actions</div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                <button class="btn btn-info" onclick="manualPingLocation()">
                                    ğŸ“ Ping GPS
                                </button>
                                <button class="btn btn-purple" onclick="openNotesModal()">
                                    ğŸ“ Notes
                                </button>
                            </div>
                        </div>
                        
                        <!-- Navigation Card -->
                        <div class="card">
                            <div class="card-header">
                                <div class="card-title">ğŸ§­ Navigation</div>
                            </div>
                            <div style="display: flex; flex-direction: column; gap: 8px;">
                                <button class="btn btn-success btn-block" onclick="openMesejDropdown()">
                                    ğŸ’¬ Mesej / Messaging
                                </button>
                                <div id="pendingDispatchBtnContainer">
                                    <button class="btn btn-warning btn-block" onclick="checkPendingDispatchesNav()">
                                        ğŸš¨ Check Pending Dispatches
                                        <span id="pendingDispatchCount" class="badge" style="background: var(--danger); color: white; margin-left: 8px; display: none;">0</span>
                                    </button>
                                </div>
                                <button class="btn btn-outline btn-block" onclick="openContactsDirectory()">
                                    ğŸ“ Contacts Directory
                                </button>
                                <button class="btn btn-outline btn-block" onclick="returnToMenuTemporary()">
                                    ğŸ  Main Menu (Keep Case)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                 MISSION COMPLETE SCREEN (Placeholder - Part 6)
                 â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
            <div id="missionComplete" class="hidden" style="padding: 15px; overflow-y: auto; max-height: calc(100vh - 120px);">
                <!-- Will be populated dynamically -->
            </div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         MODALS (Placeholder for various modals)
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

    <!-- Test Case Selector Modal -->
    <div id="testCaseSelectorModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 550px;">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--warning), #fbbf24);">
                ğŸ§ª Pilih Kes Ujian / Select Test Case
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px; color: var(--muted); font-size: 0.9rem;">
                    Pilih satu kes ujian untuk simulasi dispatch:<br>
                    <em>Select a test case to simulate dispatch:</em>
                </p>
                <div id="testCaseList">
                    <!-- Test cases will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('testCaseSelectorModal')">Batal / Cancel</button>
            </div>
        </div>
    </div>

    <!-- Messaging Modal -->
    <div id="messagingModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header" id="messagingModalHeader">
                ğŸ’¬ Hantar Mesej / Send Message
            </div>
            <div class="modal-body">
                <div id="messagingRecipientInfo" style="background: var(--bg); padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                    <!-- Recipient info -->
                </div>

                <!-- Quick Message Templates -->
                <div style="margin-bottom: 15px;">
                    <div style="font-size: 0.85rem; color: var(--muted); margin-bottom: 8px;">âš¡ Quick Messages:</div>
                    <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                        <button class="btn btn-outline btn-sm" onclick="insertQuickMessage('arrived')" style="font-size: 0.75rem;">âœ… Arrived</button>
                        <button class="btn btn-outline btn-sm" onclick="insertQuickMessage('enroute')" style="font-size: 0.75rem;">ğŸš¨ Enroute</button>
                        <button class="btn btn-outline btn-sm" onclick="insertQuickMessage('transport')" style="font-size: 0.75rem;">ğŸš— Transport</button>
                        <button class="btn btn-outline btn-sm" onclick="insertQuickMessage('handover')" style="font-size: 0.75rem;">ğŸ¤ Handover</button>
                        <button class="btn btn-outline btn-sm" onclick="insertQuickMessage('delay')" style="font-size: 0.75rem;">â° Delay</button>
                        <button class="btn btn-outline btn-sm" onclick="insertQuickMessage('assistance')" style="font-size: 0.75rem;">ğŸ†˜ Help</button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">ğŸ“ Mesej / Message</label>
                    <textarea id="messagingContent" class="form-textarea" rows="4" placeholder="Taip mesej anda..."></textarea>
                </div>

                <!-- Location Sharing -->
                <div style="background: #ecfdf5; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                    <div style="font-size: 0.85rem; font-weight: 600; color: #065f46; margin-bottom: 8px;">ğŸ“ Share Location</div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="btn btn-success btn-sm" onclick="shareCurrentLocationWhatsApp()">
                            ğŸ’¬ WhatsApp + Location
                        </button>
                        <button class="btn btn-info btn-sm" onclick="shareCurrentLocationTelegram()">
                            âœˆï¸ Telegram + Location
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">ğŸ“± Hantar Via / Send Via</label>
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn btn-success btn-sm" onclick="sendViaWhatsApp()">
                            ğŸ’¬ WhatsApp
                        </button>
                        <button class="btn btn-info btn-sm" onclick="sendViaTelegram()">
                            âœˆï¸ Telegram
                        </button>
                        <button class="btn btn-purple btn-sm" onclick="sendInApp()">
                            ğŸ“¡ In-App
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('messagingModal')">Tutup / Close</button>
            </div>
        </div>
    </div>

    <!-- Case History Modal -->
    <div id="caseHistoryModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #6366f1, #818cf8);">
                ğŸ“œ Sejarah Kes / Case History
            </div>
            <div class="modal-body">
                <div id="caseHistoryList">
                    <p style="text-align: center; color: var(--muted); padding: 30px;">
                        Tiada sejarah kes<br><em>No case history</em>
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('caseHistoryModal')">Tutup / Close</button>
            </div>
        </div>
    </div>

    <!-- Contacts Directory Modal -->
    <div id="contactsModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh;">
            <div class="modal-header" style="background: linear-gradient(135deg, #0ea5e9, #06b6d4);">
                ğŸ“ Direktori Kontak / Contacts Directory
            </div>
            <div class="modal-body" style="padding: 0;">
                <!-- Category Filter -->
                <div style="padding: 15px; background: var(--bg); border-bottom: 1px solid var(--border);">
                    <select id="contactCategoryFilter" class="form-select" onchange="filterContacts()">
                        <option value="all">ğŸ“‹ Semua / All Contacts (75+)</option>
                        <optgroup label="Hospital HTAR">
                            <option value="Hospital HTAR">ğŸ¥ Hospital HTAR (All Staff)</option>
                            <option value="Kakitangan PHCAS HTAR">ğŸ‘¥ Kakitangan PHCAS HTAR (27)</option>
                            <option value="Kakitangan JKT">ğŸ‘¨â€âš•ï¸ Kakitangan JKT (Doctors)</option>
                        </optgroup>
                        <optgroup label="Other Hospitals">
                            <option value="Hospital Shah Alam">ğŸ¥ Hospital Shah Alam</option>
                            <option value="Hospital Banting">ğŸ¥ Hospital Banting</option>
                        </optgroup>
                        <optgroup label="Klinik Kesihatan">
                            <option value="Kesihatan Klang">ğŸª Kesihatan Klang (10 KK)</option>
                            <option value="Kesihatan Kuala Langat">ğŸª Kesihatan Kuala Langat (5 KK)</option>
                        </optgroup>
                        <optgroup label="Agencies & External">
                            <option value="Agensi Lain">ğŸš’ Agensi Lain (SJAM, Bomba, Polis)</option>
                            <option value="Sumber Luar MECC">ğŸ¥ Sumber Luar MECC (External)</option>
                        </optgroup>
                    </select>
                </div>
                
                <!-- Contacts List -->
                <div id="contactsList" style="max-height: 60vh; overflow-y: auto; padding: 15px;">
                    <p style="text-align: center; color: var(--muted); padding: 30px;">
                        Loading contacts...
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-info" onclick="refreshContacts()">ğŸ”„ Refresh</button>
                <button class="btn btn-outline" onclick="closeModal('contactsModal')">Tutup / Close</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #64748b, #475569);">
                âš™ï¸ Tetapan / Settings
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">ğŸ”” Notification Sound</label>
                    <select id="settingNotificationSound" class="form-select">
                        <option value="default">Default</option>
                        <option value="siren">Siren</option>
                        <option value="bell">Bell</option>
                        <option value="none">None</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">ğŸ“ Auto GPS Tracking</label>
                    <select id="settingAutoGPS" class="form-select">
                        <option value="on">On - Auto ping at each phase</option>
                        <option value="off">Off - Manual ping only</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">ğŸŒ Backend URL (Live Mode)</label>
                    <input type="text" id="settingBackendUrl" class="form-input" placeholder="https://script.google.com/...">
                    <button type="button" class="btn btn-info btn-sm" onclick="testBackendFromSettings()" style="margin-top: 8px;">
                        ğŸ”Œ Test Connection
                    </button>
                    <div id="backendTestResult" style="margin-top: 8px; font-size: 0.85rem;"></div>
                </div>
                
                <!-- Install App Section -->
                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border);">
                    <div class="form-group">
                        <label class="form-label">ğŸ“² Install as Mobile App</label>
                        <p style="font-size: 0.8rem; color: var(--muted); margin-bottom: 10px;">
                            Install MECCHTAR Responder on your home screen for quick access
                        </p>
                        <button type="button" class="btn btn-success" onclick="installApp()" style="width: 100%;">
                            ğŸ“² Install App / Pasang Aplikasi
                        </button>
                    </div>
                </div>
                
                <!-- Version Info -->
                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border); text-align: center;">
                    <div style="font-size: 0.8rem; color: var(--muted);">
                        <strong>MECCHTAR ResponderApp</strong>
                    </div>
                    <div id="versionDisplay" style="font-size: 0.75rem; color: var(--muted); margin-top: 4px;">
                        Version loading...
                    </div>
                    <button type="button" class="btn btn-sm" onclick="checkForUpdates()" style="margin-top: 10px; font-size: 0.75rem; padding: 6px 12px; background: var(--info); color: white;">
                        ğŸ”„ Check for Updates
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('settingsModal')">Tutup / Close</button>
                <button class="btn btn-primary" onclick="saveSettings()">ğŸ’¾ Simpan / Save</button>
            </div>
        </div>
    </div>

    <!-- Import Dispatch Manual Modal -->
    <div id="importDispatchModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 520px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
                ğŸ“¥ Import Dispatch Manual
            </div>
            <div class="modal-body">
                <p style="font-size: 0.85rem; color: var(--muted); margin-bottom: 15px; padding: 10px; background: #fef3c7; border-radius: 8px; border-left: 4px solid var(--warning);">
                    âš ï¸ <strong>Fallback Mode:</strong> Use when system is down. Paste WhatsApp message below and click Parse.
                </p>
                
                <!-- Quick Paste from WhatsApp - MOVED TO TOP -->
                <div style="margin-bottom: 15px; padding: 12px; background: var(--glass); border-radius: 10px; border: 2px dashed var(--accent);">
                    <label class="form-label" style="color: var(--accent); font-weight: 700;">ğŸ“‹ Paste MECCHTAR Message Here</label>
                    <textarea id="manualQuickPaste" class="form-input" rows="4" placeholder="Paste entire dispatch message from CallTaking/Dispatching WhatsApp here..." style="font-size: 0.8rem; font-family: monospace;"></textarea>
                    <button type="button" class="btn btn-info" onclick="parseQuickPaste()" style="margin-top: 8px; width: 100%;">
                        ğŸ” Parse Message & Auto-Fill Fields
                    </button>
                </div>
                
                <div style="border-top: 2px solid var(--border); padding-top: 15px; margin-top: 10px;">
                    <div style="font-size: 0.75rem; color: var(--muted); margin-bottom: 10px; text-align: center;">
                        â”€â”€â”€ Parsed Fields (Edit if needed) â”€â”€â”€
                    </div>
                </div>
                
                <!-- Call Card & Priority -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="form-group">
                        <label class="form-label">ğŸ« Call Card</label>
                        <input type="text" id="manualCallCard" class="form-input" placeholder="e.g., KL1002-20251201" style="font-family: monospace; font-size: 0.85rem;">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ğŸš¨ Priority *</label>
                        <select id="manualPriority" class="form-select" required>
                            <option value="P1">P1 - Echo/Delta (Critical)</option>
                            <option value="P2" selected>P2 - Charlie (Moderate)</option>
                            <option value="P3">P3 - Bravo (Minor)</option>
                            <option value="P4">P4 - Alpha (Non-urgent)</option>
                        </select>
                    </div>
                </div>
                
                <!-- MPDS & Chief Complaint -->
                <div style="display: grid; grid-template-columns: 100px 1fr; gap: 10px;">
                    <div class="form-group">
                        <label class="form-label">ğŸ“‹ Code</label>
                        <input type="text" id="manualMpdsCode" class="form-input" placeholder="29-C-1" style="font-family: monospace;">
                    </div>
                    <div class="form-group">
                        <label class="form-label">âš ï¸ Chief Complaint *</label>
                        <input type="text" id="manualChiefComplaint" class="form-input" placeholder="e.g., MVA skidded, Jatuh, Chest pain" required>
                    </div>
                </div>
                
                <!-- Patient Info -->
                <div style="display: grid; grid-template-columns: 2fr 70px 90px; gap: 10px;">
                    <div class="form-group">
                        <label class="form-label">ğŸ‘¤ Patient Name</label>
                        <input type="text" id="manualPatientName" class="form-input" placeholder="Nama pesakit">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ğŸ‚ Age</label>
                        <input type="text" id="manualPatientAge" class="form-input" placeholder="45">
                    </div>
                    <div class="form-group">
                        <label class="form-label">âš§ Gender</label>
                        <select id="manualPatientGender" class="form-select">
                            <option value="">-</option>
                            <option value="Male">Lelaki</option>
                            <option value="Female">Perempuan</option>
                        </select>
                    </div>
                </div>
                
                <!-- Location -->
                <div class="form-group">
                    <label class="form-label">ğŸ“ Location / Address *</label>
                    <textarea id="manualLocation" class="form-input" rows="2" placeholder="Full address including area/town" required></textarea>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="form-group">
                        <label class="form-label">ğŸ¢ Landmark</label>
                        <input type="text" id="manualLandmark" class="form-input" placeholder="e.g., Petronas, 7-Eleven">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ğŸ—ºï¸ Maps Link</label>
                        <input type="url" id="manualMapsLink" class="form-input" placeholder="Google Maps URL" style="font-size: 0.75rem;">
                    </div>
                </div>
                
                <!-- Caller Info -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="form-group">
                        <label class="form-label">ğŸ“ Caller Name</label>
                        <input type="text" id="manualCallerName" class="form-input" placeholder="Nama pemanggil">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ğŸ“± Caller Phone</label>
                        <input type="tel" id="manualCallerPhone" class="form-input" placeholder="0123456789">
                    </div>
                </div>
                
                <!-- Condition Details -->
                <div class="form-group">
                    <label class="form-label">ğŸ¥ Condition Details</label>
                    <textarea id="manualCondition" class="form-input" rows="2" placeholder="ğŸ‘ï¸ Conscious? ğŸ« Breathing? Other details..."></textarea>
                </div>
                
                <!-- CallTaker & Dispatcher Info -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="form-group">
                        <label class="form-label">ğŸ‘¤ Call Taker</label>
                        <input type="text" id="manualCallTaker" class="form-input" placeholder="CallTaker name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ğŸ“¡ Dispatcher</label>
                        <input type="text" id="manualDispatcher" class="form-input" placeholder="Dispatcher name">
                    </div>
                </div>
                
                <!-- Destination & PDF -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div class="form-group">
                        <label class="form-label">ğŸ¥ Destination</label>
                        <select id="manualDestination" class="form-select">
                            <option value="Hospital Tengku Ampuan Rahimah">HTAR</option>
                            <option value="Hospital Shah Alam">H. Shah Alam</option>
                            <option value="Hospital Banting">H. Banting</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ğŸ“„ PDF Link</label>
                        <input type="url" id="manualPdfLink" class="form-input" placeholder="PDF/Drive link" style="font-size: 0.75rem;">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('importDispatchModal')">âŒ Batal / Cancel</button>
                <button class="btn btn-success" onclick="submitManualDispatch()">âœ… Start Mission</button>
            </div>
        </div>
    </div>

    <!-- Dispatch List Modal (Multiple Dispatches) -->
    <div id="dispatchListModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px; max-height: 85vh; overflow-y: auto;">
            <div class="modal-header" style="background: linear-gradient(135deg, #dc2626, #ef4444);">
                ğŸš¨ <span id="dispatchListCount">Multiple Pending Dispatches</span>
            </div>
            <div class="modal-body" style="padding: 10px;">
                <p style="font-size: 0.85rem; color: var(--muted); margin-bottom: 15px; padding: 10px; background: #fef3c7; border-radius: 8px;">
                    âš ï¸ Multiple cases assigned. Select one to respond, hold others for later, or reject with reason.
                </p>
                <div id="dispatchListContent">
                    <!-- Populated dynamically -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('dispatchListModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Phase Confirmation Modal -->
    <div id="phaseConfirmModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header" id="phaseConfirmTitle" style="background: linear-gradient(135deg, var(--success), #22c55e);">
                âœ… Confirm Phase
            </div>
            <div class="modal-body" style="text-align: center;">
                <p id="phaseConfirmMessage" style="font-size: 1.1rem; margin-bottom: 20px;">Mark this phase as completed?</p>
                <div style="display: flex; gap: 10px; flex-direction: column;">
                    <button class="btn btn-success btn-block" onclick="confirmPhaseUpdate(false)">
                        âœ… Confirm
                    </button>
                    <button class="btn btn-info btn-block" onclick="confirmPhaseUpdate(true)">
                        â­ï¸ Confirm & Skip Future Confirmations
                    </button>
                    <button class="btn btn-outline btn-block" onclick="closePhaseConfirmModal()">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Destination Confirmation Modal -->
    <div id="destinationModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #0891b2, #06b6d4);">
                ğŸ¥ Determine Destination Hospital
            </div>
            <div class="modal-body">
                <div style="background: var(--bg); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                    <div style="font-size: 0.85rem; color: var(--muted); margin-bottom: 5px;">Current Preset Destination:</div>
                    <div id="modalCurrentDestination" style="font-size: 1.1rem; font-weight: 700; color: var(--accent);">-</div>
                </div>

                <div class="form-group">
                    <label class="form-label">ğŸ“ Action</label>
                    <div style="display: flex; flex-direction: column; gap: 10px;">
                        <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--bg); border-radius: 8px; cursor: pointer; border: 2px solid transparent;" onclick="selectDestinationOption('follow')">
                            <input type="radio" name="destOption" value="follow" checked>
                            <span>âœ… Follow preset destination</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 10px; padding: 12px; background: var(--bg); border-radius: 8px; cursor: pointer; border: 2px solid transparent;" onclick="selectDestinationOption('change')">
                            <input type="radio" name="destOption" value="change">
                            <span>ğŸ”„ Change destination</span>
                        </label>
                    </div>
                </div>

                <div id="changeDestinationFields" class="hidden">
                    <div class="form-group">
                        <label class="form-label">ğŸ¥ New Destination <span class="required">*</span></label>
                        <select id="newDestinationSelect" class="form-select">
                            <option value="">-- Select Hospital --</option>
                            <option value="Hospital Tengku Ampuan Rahimah">Hospital Tengku Ampuan Rahimah (HTAR)</option>
                            <option value="Hospital Shah Alam">Hospital Shah Alam</option>
                            <option value="Hospital Sungai Buloh">Hospital Sungai Buloh</option>
                            <option value="Hospital Selayang">Hospital Selayang</option>
                            <option value="Hospital Kuala Lumpur">Hospital Kuala Lumpur (HKL)</option>
                            <option value="KPJ Klang">KPJ Klang</option>
                            <option value="Columbia Asia">Columbia Asia</option>
                            <option value="Other">Other (specify)</option>
                        </select>
                    </div>
                    <div class="form-group" id="otherDestinationGroup" style="display: none;">
                        <label class="form-label">ğŸ“ Specify Hospital</label>
                        <input type="text" id="otherDestinationInput" class="form-input" placeholder="Enter hospital name">
                    </div>
                    <div class="form-group">
                        <label class="form-label">ğŸ“‹ Reason for Change <span class="required">*</span></label>
                        <select id="destChangeReason" class="form-select">
                            <option value="">-- Select Reason --</option>
                            <option value="Closer facility">Closer facility</option>
                            <option value="Specialty care needed">Specialty care needed</option>
                            <option value="Patient/family request">Patient/family request</option>
                            <option value="Original destination full">Original destination full</option>
                            <option value="Bypass protocol">Bypass protocol</option>
                            <option value="Other">Other (specify)</option>
                        </select>
                    </div>
                    <div class="form-group" id="otherReasonGroup" style="display: none;">
                        <label class="form-label">ğŸ“ Specify Reason</label>
                        <input type="text" id="otherReasonInput" class="form-input" placeholder="Enter reason">
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('destinationModal')">Cancel</button>
                <button class="btn btn-success" onclick="confirmDestination()">âœ… Confirm Destination</button>
            </div>
        </div>
    </div>

    <!-- Notes Modal -->
    <div id="notesModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--purple), #a78bfa);">
                ğŸ“ Mission Notes
            </div>
            <div class="modal-body">
                <!-- Auto Notes -->
                <div style="margin-bottom: 20px;">
                    <div style="font-weight: 700; margin-bottom: 10px;">ğŸ“‹ Auto-Generated Notes</div>
                    <div id="autoNotesDisplay" style="background: var(--bg); padding: 12px; border-radius: 8px; max-height: 200px; overflow-y: auto; font-size: 0.85rem; font-family: monospace;">
                        No notes yet
                    </div>
                </div>

                <!-- Free Text Notes -->
                <div class="form-group">
                    <label class="form-label">âœï¸ Additional Notes / Free Text</label>
                    <textarea id="freeTextNotes" class="form-textarea" rows="4" placeholder="Enter additional notes here..."></textarea>
                </div>

                <!-- Export Options -->
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button class="btn btn-info btn-sm" onclick="copyNotesToClipboard()">ğŸ“‹ Copy All</button>
                    <button class="btn btn-success btn-sm" onclick="downloadNotes()">ğŸ’¾ Download</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('notesModal')">Close</button>
                <button class="btn btn-primary" onclick="saveNotes()">ğŸ’¾ Save Notes</button>
            </div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         OVERRIDE SYSTEM MODALS (6-Step Workflow)
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

    <!-- Step 1: Initial Override Confirmation -->
    <div id="overrideStep1Modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--danger), #ef4444);">
                âš¡ Override Mission Phases
            </div>
            <div class="modal-body" style="text-align: center;">
                <div style="font-size: 48px; margin-bottom: 15px;">âš ï¸</div>
                <p style="font-size: 1.1rem; margin-bottom: 15px;">
                    <strong>Current Phase:</strong>
                </p>
                <p id="overrideCurrentPhase" style="font-size: 1.3rem; font-weight: 700; color: var(--danger); margin-bottom: 20px;">
                    ğŸ“± Acknowledge
                </p>
                <div style="background: #fef3c7; padding: 15px; border-radius: 10px; margin-bottom: 20px; text-align: left;">
                    <p style="margin: 0; font-size: 0.9rem; color: #92400e;">
                        â„¹ï¸ <strong>Note:</strong> Override allows you to skip remaining phases and end the mission early. 
                        This should only be used in special circumstances such as:
                    </p>
                    <ul style="margin: 10px 0 0 20px; font-size: 0.85rem; color: #92400e;">
                        <li>Patient refusal</li>
                        <li>Standdown by MECC</li>
                        <li>Other exceptional situations</li>
                    </ul>
                </div>
                <p style="color: var(--muted); font-size: 0.9rem;">
                    Are you sure you want to proceed with override?
                </p>
            </div>
            <div class="modal-footer" style="justify-content: center;">
                <button class="btn btn-outline" onclick="closeOverrideWorkflow()">Cancel</button>
                <button class="btn btn-danger" onclick="overrideStep2()">âš¡ Continue Override</button>
            </div>
        </div>
    </div>

    <!-- Step 2: Override Reason Selection -->
    <div id="overrideStep2Modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--warning), #fbbf24);">
                ğŸ“‹ Step 2: Select Override Reason
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px; color: var(--muted);">
                    Please select the reason for override:
                </p>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <label class="override-reason-option" onclick="selectOverrideReason('Standdown')">
                        <input type="radio" name="overrideReason" value="Standdown">
                        <span class="override-reason-icon">ğŸ›‘</span>
                        <div>
                            <div class="override-reason-title">Standdown</div>
                            <div class="override-reason-desc">Mission cancelled by MECC/Dispatcher</div>
                        </div>
                    </label>
                    <label class="override-reason-option" onclick="selectOverrideReason('Refusal')">
                        <input type="radio" name="overrideReason" value="Refusal">
                        <span class="override-reason-icon">ğŸš«</span>
                        <div>
                            <div class="override-reason-title">Patient Refusal</div>
                            <div class="override-reason-desc">Patient refused treatment or transport</div>
                        </div>
                    </label>
                    <label class="override-reason-option" onclick="selectOverrideReason('Other')">
                        <input type="radio" name="overrideReason" value="Other">
                        <span class="override-reason-icon">ğŸ“</span>
                        <div>
                            <div class="override-reason-title">Other</div>
                            <div class="override-reason-desc">Specify reason below</div>
                        </div>
                    </label>
                </div>
                <div id="overrideOtherReasonField" class="hidden" style="margin-top: 15px;">
                    <label class="form-label">ğŸ“ Specify Reason <span class="required">*</span></label>
                    <input type="text" id="overrideOtherReasonInput" class="form-input" placeholder="Enter reason...">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="overrideGoBack(1)">â† Back</button>
                <button class="btn btn-warning" onclick="overrideStep3()">Continue â†’</button>
            </div>
        </div>
    </div>

    <!-- Step 3: Select Destination Phase -->
    <div id="overrideStep3Modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 450px;">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--info), #60a5fa);">
                ğŸ¯ Step 3: Select Destination Phase
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px; color: var(--muted);">
                    Select which phase to jump to:
                </p>
                <select id="overrideDestinationPhase" class="form-select" onchange="updateSkippedPhasesList()">
                    <!-- Populated dynamically -->
                </select>
                <div id="skippedPhasesPreview" class="hidden" style="margin-top: 20px; background: #fef3c7; padding: 15px; border-radius: 10px; border-left: 4px solid var(--warning);">
                    <div style="font-weight: 700; margin-bottom: 8px; color: #92400e;">â­ï¸ Phases to be skipped:</div>
                    <div id="skippedPhasesList" style="color: #92400e; font-size: 0.9rem;"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="overrideGoBack(2)">â† Back</button>
                <button class="btn btn-info" onclick="overrideStep4()">Continue â†’</button>
            </div>
        </div>
    </div>

    <!-- Step 4: Preview & Confirm -->
    <div id="overrideStep4Modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--purple), #a78bfa);">
                ğŸ‘ï¸ Step 4: Preview Override
            </div>
            <div class="modal-body">
                <div style="background: var(--bg); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <span style="color: var(--muted);">Override Reason:</span>
                        <span id="previewOverrideReason" style="font-weight: 700;"></span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--muted);">Jump to Phase:</span>
                        <span id="previewDestinationPhase" style="font-weight: 700;"></span>
                    </div>
                </div>

                <div style="background: #fee2e2; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                    <div style="font-weight: 700; margin-bottom: 8px; color: #dc2626;">
                        âš ï¸ The following phases will be marked as OVERRIDE:
                    </div>
                    <div id="finalSkippedPhasesList" style="color: #dc2626; font-size: 0.9rem;"></div>
                </div>

                <div style="background: #fef3c7; padding: 12px; border-radius: 8px; font-size: 0.85rem; color: #92400e;">
                    âš ï¸ This action cannot be undone. All skipped phases will be marked as "OVERRIDE" in your mission report.
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="overrideGoBack(3)">â† Back</button>
                <button class="btn btn-danger" onclick="executeOverride()">âš¡ Execute Override</button>
            </div>
        </div>
    </div>

    <!-- Performance Review Modal -->
    <div id="performanceReviewModal" class="modal-overlay">
        <div class="modal-content" style="max-width: 650px;">
            <div class="modal-header" style="background: linear-gradient(135deg, #6366f1, #818cf8);">
                ğŸ“Š Performance Review
            </div>
            <div class="modal-body">
                <div id="performanceReviewContent">
                    <!-- Populated dynamically -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" onclick="closeModal('performanceReviewModal')">Close</button>
                <button class="btn btn-info" onclick="exportPerformanceReport()">ğŸ“¥ Export Report</button>
            </div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         JAVASCRIPT - PART 1: FOUNDATION
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <script>
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // APP VERSION & UPDATE SYSTEM
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const APP_VERSION = '3.1.0';
        const APP_BUILD_DATE = '2025-12-02';
        const APP_VERSION_KEY = 'mecchtar-app-version';
        
        // Check for version update on load
        function checkVersionUpdate() {
            const storedVersion = localStorage.getItem(APP_VERSION_KEY);
            if (storedVersion && storedVersion !== APP_VERSION) {
                console.log(`ğŸ”„ App updated: ${storedVersion} â†’ ${APP_VERSION}`);
                showUpdateNotification(storedVersion, APP_VERSION);
            }
            localStorage.setItem(APP_VERSION_KEY, APP_VERSION);
        }
        
        // Show update notification
        function showUpdateNotification(oldVer, newVer) {
            setTimeout(() => {
                const banner = document.createElement('div');
                banner.id = 'update-banner';
                banner.innerHTML = `
                    <div style="
                        position: fixed;
                        top: 0;
                        left: 0;
                        right: 0;
                        background: linear-gradient(135deg, #16a34a, #22c55e);
                        color: white;
                        padding: 12px 20px;
                        z-index: 10001;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                    ">
                        <div>
                            <strong>ğŸ‰ App Updated!</strong>
                            <span style="opacity: 0.9; margin-left: 10px;">v${oldVer} â†’ v${newVer}</span>
                        </div>
                        <button onclick="dismissUpdateBanner()" style="
                            background: rgba(255,255,255,0.2);
                            border: none;
                            color: white;
                            padding: 6px 12px;
                            border-radius: 6px;
                            cursor: pointer;
                            font-weight: 600;
                        ">OK</button>
                    </div>
                `;
                document.body.appendChild(banner);
            }, 1000);
        }
        
        function dismissUpdateBanner() {
            const banner = document.getElementById('update-banner');
            if (banner) banner.remove();
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // BACKEND CONFIGURATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const BACKEND_CONFIG = {
            // âš ï¸ UPDATE THESE WITH YOUR ACTUAL URLS
            RESPONDER_BACKEND_URL: 'https://script.google.com/macros/s/AKfycbyM2Qo3Cxhe9mJpi5mTiX70BjlQR3WZ-Iayb-Mo4R-Ot4HQYK4BcAHZ9vNNIs7tSsm6yA/exec', // Backend #3 - ResponderApp
            DISPATCH_BACKEND_URL: '',  // Backend #1 - CallTaking/Dispatching (for reference)
            
            // Polling interval for new dispatches (milliseconds)
            POLL_INTERVAL: 10000, // 10 seconds (faster response)
            
            // Request timeout
            REQUEST_TIMEOUT: 15000 // 15 seconds
        };

        // Polling timer reference
        let dispatchPollInterval = null;
        let backendConnected = false;

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // APPLICATION STATE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const appState = {
            // Session
            mode: 'demo', // 'demo' or 'live'
            isLoggedIn: false,
            sessionId: null,      // Backend session ID
            missionId: null,      // Current mission ID from backend
            unitId: '',
            staffId: '',
            crewName: '',
            shift: 'AM',
            loginTime: null,

            // Current Case
            currentCase: null,
            destination: '',
            destinationConfirmed: false,
            destinationChangeReason: '',

            // 10 Phases with targets (seconds)
            phases: [
                { name: 'Acknowledge', icon: 'ğŸ“±', completed: false, time: null, duration: null, target: 60, overridden: false, gps: null },
                { name: 'Rolling', icon: 'ğŸš€', completed: false, time: null, duration: null, target: 120, overridden: false, gps: null },
                { name: 'Enroute', icon: 'ğŸš¨', completed: false, time: null, duration: null, target: 600, overridden: false, gps: null },
                { name: 'At Scene', icon: 'ğŸ ', completed: false, time: null, duration: null, target: 60, overridden: false, gps: null },
                { name: 'By Patient', icon: 'ğŸ‘¤', completed: false, time: null, duration: null, target: 300, overridden: false, gps: null },
                { name: 'Transporting', icon: 'ğŸš—', completed: false, time: null, duration: null, target: 600, overridden: false, gps: null },
                { name: 'At Destination', icon: 'ğŸ¥', completed: false, time: null, duration: null, target: 60, overridden: false, gps: null },
                { name: 'Handover', icon: 'ğŸ¤', completed: false, time: null, duration: null, target: 300, overridden: false, gps: null },
                { name: 'Readying', icon: 'ğŸ“‹', completed: false, time: null, duration: null, target: 300, overridden: false, gps: null },
                { name: 'Clear', icon: 'âœ…', completed: false, time: null, duration: null, target: 300, overridden: false, gps: null }
            ],

            // Mission tracking
            missionStartTime: null,
            missionEndTime: null,
            autoNotes: [],
            freeTextNotes: '',

            // Override tracking
            overrideUsed: false,
            overrideReason: null,
            skippedPhases: [],

            // Confirmation skips
            skipConfirmations: {},
            skipAllConfirmations: false, // Global flag to skip ALL remaining confirmations
            
            // Multiple pending dispatches
            pendingDispatches: [],

            // History
            completedCases: [],

            // Settings
            settings: {
                notificationSound: 'default',
                autoGPS: 'on',
                backendUrl: ''
            },

            // Pending dispatch (for Live Mode)
            pendingDispatch: null,

            // GPS
            currentGPS: null
        };

        // Timers
        let clockInterval = null;
        let missionTimerInterval = null;
        let ongoingPhaseTimerInterval = null;
        let waitingTimerInterval = null;
        let waitingStartTime = null;

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // TEST CASES (FOR DEMO MODE) - Matches actual MECCHTAR Dispatch format
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const testCases = [
            {
                // Identifiers (from DispatchQueue)
                id: 'Q-2024-120201-0001',
                queueId: 'Q-2024-120201-0001',
                recordId: 'R-2024-120201-001234',
                callCardNo: 'HTAR-20251202-08:30:15-AM-0001',
                assignmentId: 'ASGN-2024-120201-0001',
                
                // Call Taker Info
                callTaker: 'Nurul Huda (CT001)',
                callTakerId: 'CT001',
                
                // Priority & MPDS
                priority: 'P1',
                dispatchCode: '31-D-2',
                mpdsCode: '31',
                mpdsDisplayText: 'Tidak Sedarkan Diri / Unconscious',
                mpds: '31 - Tidak Sedarkan Diri / Unconscious',
                triage: 'critical-immediate',
                
                // Patient Info
                patientName: 'Siti binti Ahmad',
                patientAge: 45,
                patientGender: 'Female',
                patientCount: '1',
                
                // Caller Info
                callerName: 'Ahmad bin Ibrahim',
                callerPhone: '012-3456789',
                callerRelation: 'Suami / Husband',
                
                // Location (matches CallTaking format)
                location: 'No. 23, Jalan Merdeka, Taman Sentosa, 40000 Shah Alam, Selangor',
                locationSummary: 'No. 23, Jalan Merdeka, Taman Sentosa, 40000 Shah Alam, Selangor',
                locationDetails: 'Rumah Teres 2 Tingkat, Pintu Warna Biru',
                landmark: 'Bersebelahan Kedai Runcit Pak Ali',
                buildingType: 'Rumah Teres',
                floor: 'Tingkat Bawah',
                lift: 'Tiada',
                latitude: 3.0738,
                longitude: 101.5183,
                gpsCoords: { lat: 3.0738, lng: 101.5183 },
                mapLink: 'https://maps.google.com/?q=3.0738,101.5183',
                
                // Clinical Info
                chiefComplaint: 'Pengsan di rumah, tidak sedar diri sejak 10 minit',
                condition: 'Pengsan di rumah, tidak sedar diri sejak 10 minit',
                conscious: 'Tidak Sedar',
                breathing: 'Bernafas',
                medHistory: 'Diabetes, Darah Tinggi',
                allergies: 'Tiada yang diketahui',
                
                // Pre-Arrival Instructions
                preArrivalInstructions: 'Pastikan pesakit berbaring. Jangan beri makan/minum. Longgarkan pakaian ketat.',
                paiGiven: true,
                
                // Full Summary (as sent by Dispatcher - ACTUAL FORMAT)
                fullCallSummary: `ğŸš‘ MECCHTAR DISPATCH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ Call Card: HTAR-20251202-08:30:15-AM-0001
ğŸ”´ Priority: P1
ğŸ“Ÿ Code: 31-D-2
ğŸ¥ MPDS: 31 - Tidak Sedarkan Diri / Unconscious
ğŸ‘¤ Patient: Siti binti Ahmad
ğŸ‘¥ Count: 1
ğŸ©º Condition: Pengsan di rumah, tidak sedar diri sejak 10 minit. Diabetes, Darah Tinggi. Caller: Ahmad (Suami) 012-3456789
ğŸ“ Location:
No. 23, Jalan Merdeka, Taman Sentosa, 40000 Shah Alam, Selangor. Landmark: Bersebelahan Kedai Runcit Pak Ali
ğŸ—ºï¸ Google Maps:
https://www.google.com/maps/search/?api=1&query=3.0738,101.5183
ğŸš’ Resources: HTAR1
ğŸ“„ PDF Link:
https://drive.google.com/file/d/mock-pdf-1234/view
ğŸ“ Notes: PAI diberikan - Pastikan pesakit berbaring. Jangan beri makan/minum. Longgarkan pakaian ketat.
ğŸ‘¨â€ğŸ’¼ Dispatcher: Dispatcher Ahmad (D001)
â° Time: 2025-12-02 08:31:45
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`,

                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // DISPATCH ASSIGNMENT INFO (Filled by Dispatcher)
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                presetDestination: 'Hospital Tengku Ampuan Rahimah (HTAR)',
                resourceCallSign: 'HTAR1',           // Assigned unit
                resourceName: 'Ambulans HTAR Unit 1',
                resourcePhone: '03-33776151',
                resourceCategory: 'hospital',        // hospital, klinik, agensi, luar
                dispatchMethod: 'WhatsApp',          // WhatsApp, Telegram, Radio, Phone
                teamType: 'ALS',                     // BLS, ALS, FR
                jobAssignment: '999',                // Job code
                
                // Dispatcher Info
                dispatcherName: 'Dispatcher Ahmad',
                dispatcherId: 'D001',
                dispatcherShift: 'AM',
                caseManagementDuration: '00:01:45',  // Time from received to dispatch
                
                // Timestamps
                receivedTime: new Date(Date.now() - 180000).toISOString().slice(0, 19).replace('T', ' '),
                dispatcherAckTime: new Date(Date.now() - 150000).toISOString().slice(0, 19).replace('T', ' '),
                dispatcherAckBy: 'Dispatcher Ahmad',
                dispatchedTime: new Date(Date.now() - 60000).toISOString().slice(0, 19).replace('T', ' '),
                dispatchedBy: 'Dispatcher Ahmad',
                
                // Status
                queueStatus: 'Dispatched',
                isTestCase: true,
                
                // PDF Link (mock)
                pdfHyperlink: 'https://drive.google.com/file/d/mock-pdf-1234'
            },
            {
                // Identifiers
                id: 'Q-2024-120201-0002',
                queueId: 'Q-2024-120201-0002',
                recordId: 'R-2024-120201-001235',
                callCardNo: 'HTAR-20251202-08:25:00-AM-0002',
                assignmentId: 'ASGN-2024-120201-0002',
                
                // Call Taker Info
                callTaker: 'Azman bin Yusof (CT002)',
                callTakerId: 'CT002',
                
                // Priority & MPDS
                priority: 'P2',
                dispatchCode: '17-A-1',
                mpdsCode: '17',
                mpdsDisplayText: 'Jatuh / Falls',
                mpds: '17 - Jatuh / Falls',
                triage: 'stable',
                
                // Patient Info
                patientName: 'Tan Ah Kow',
                patientAge: 72,
                patientGender: 'Male',
                patientCount: '1',
                
                // Caller Info
                callerName: 'Lim Wei Ming',
                callerPhone: '016-9876543',
                callerRelation: 'Rakan Sekerja / Colleague',
                
                // Location
                location: 'Lot 45, Jalan Perusahaan, Kawasan Industri Shah Alam, 40300 Shah Alam',
                locationSummary: 'Lot 45, Jalan Perusahaan, Kawasan Industri Shah Alam',
                locationDetails: 'Kilang Besi ABC, Pintu Masuk Utama, Bahagian Pengeluaran',
                landmark: 'Berhadapan Stesen Minyak Shell',
                buildingType: 'Kilang',
                floor: 'Tingkat 1',
                lift: 'Ada',
                latitude: 3.0856,
                longitude: 101.5291,
                gpsCoords: { lat: 3.0856, lng: 101.5291 },
                mapLink: 'https://maps.google.com/?q=3.0856,101.5291',
                
                // Clinical Info
                chiefComplaint: 'Jatuh dari tangga di kilang, sakit kaki kanan, tidak boleh berjalan',
                condition: 'Jatuh dari tangga di kilang, sakit kaki kanan',
                conscious: 'Sedar Sepenuhnya',
                breathing: 'Normal',
                medHistory: 'Tiada',
                allergies: 'Penisilin',
                
                // Pre-Arrival Instructions
                preArrivalInstructions: 'Jangan gerakkan pesakit. Immobilize kaki yang cedera.',
                paiGiven: true,
                
                // Full Summary (as sent by Dispatcher - ACTUAL FORMAT)
                fullCallSummary: `ğŸš‘ MECCHTAR DISPATCH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ Call Card: HTAR-20251202-08:25:00-AM-0002
ğŸŸ  Priority: P2
ğŸ“Ÿ Code: 17-A-1
ğŸ¥ MPDS: 17 - Jatuh / Falls
ğŸ‘¤ Patient: Tan Ah Kow
ğŸ‘¥ Count: 1
ğŸ©º Condition: Jatuh dari tangga di kilang, sakit kaki kanan, tidak boleh berjalan. Allergies: Penisilin. Caller: Lim Wei Ming (Rakan Sekerja) 016-9876543
ğŸ“ Location:
Lot 45, Jalan Perusahaan, Kawasan Industri Shah Alam, 40300 Shah Alam. Kilang Besi ABC, Pintu Masuk Utama. Landmark: Berhadapan Stesen Minyak Shell
ğŸ—ºï¸ Google Maps:
https://www.google.com/maps/search/?api=1&query=3.0856,101.5291
ğŸš’ Resources: HTAR2
ğŸ“„ PDF Link:
https://drive.google.com/file/d/mock-pdf-1235/view
ğŸ“ Notes: PAI - Jangan gerakkan pesakit. Immobilize kaki yang cedera.
ğŸ‘¨â€ğŸ’¼ Dispatcher: Dispatcher Fatimah (D002)
â° Time: 2025-12-02 08:27:30
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`,

                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // DISPATCH ASSIGNMENT INFO
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                presetDestination: 'Hospital Shah Alam',
                resourceCallSign: 'HTAR2',
                resourceName: 'Ambulans HTAR Unit 2',
                resourcePhone: '03-33776152',
                resourceCategory: 'hospital',
                dispatchMethod: 'Telegram',
                teamType: 'BLS',
                jobAssignment: '999',
                
                dispatcherName: 'Dispatcher Fatimah',
                dispatcherId: 'D002',
                dispatcherShift: 'AM',
                caseManagementDuration: '00:02:30',
                
                // Timestamps
                receivedTime: new Date(Date.now() - 300000).toISOString().slice(0, 19).replace('T', ' '),
                dispatcherAckTime: new Date(Date.now() - 270000).toISOString().slice(0, 19).replace('T', ' '),
                dispatcherAckBy: 'Dispatcher Fatimah',
                dispatchedTime: new Date(Date.now() - 90000).toISOString().slice(0, 19).replace('T', ' '),
                dispatchedBy: 'Dispatcher Fatimah',
                
                // Status
                queueStatus: 'Dispatched',
                isTestCase: true,
                pdfHyperlink: 'https://drive.google.com/file/d/mock-pdf-1235'
            },
            {
                // Identifiers
                id: 'Q-2024-120201-0003',
                queueId: 'Q-2024-120201-0003',
                recordId: 'R-2024-120201-001236',
                callCardNo: 'HTAR-20251202-08:32:00-AM-0003',
                assignmentId: 'ASGN-2024-120201-0003',
                
                // Call Taker Info
                callTaker: 'Salmah binti Omar (CT003)',
                callTakerId: 'CT003',
                
                // Priority & MPDS
                priority: 'P1',
                dispatchCode: '10-D-1',
                mpdsCode: '10',
                mpdsDisplayText: 'Sakit Dada / Chest Pain',
                mpds: '10 - Sakit Dada / Chest Pain',
                triage: 'critical-immediate',
                
                // Patient Info
                patientName: 'Mohd Razak bin Abdullah',
                patientAge: 58,
                patientGender: 'Male',
                patientCount: '1',
                
                // Caller Info
                callerName: 'Fatimah binti Hassan',
                callerPhone: '019-1112233',
                callerRelation: 'Isteri / Wife',
                
                // Location
                location: 'Surau Al-Hidayah, Jalan Kebun, Seksyen 7, 40000 Shah Alam',
                locationSummary: 'Surau Al-Hidayah, Jalan Kebun, Seksyen 7, Shah Alam',
                locationDetails: 'Dalam surau, berhampiran pintu keluar belakang',
                landmark: 'Sebelah Pasar Malam Seksyen 7',
                buildingType: 'Surau/Masjid',
                floor: 'Aras Bawah',
                lift: 'Tiada',
                latitude: 3.0642,
                longitude: 101.5089,
                gpsCoords: { lat: 3.0642, lng: 101.5089 },
                mapLink: 'https://maps.google.com/?q=3.0642,101.5089',
                
                // Clinical Info
                chiefComplaint: 'Sakit dada teruk merebak ke lengan kiri, sesak nafas, berpeluh sejuk',
                condition: 'Sakit dada teruk, sesak nafas, berpeluh',
                conscious: 'Sedar Tetapi Lemah',
                breathing: 'Sesak Nafas',
                medHistory: 'Serangan jantung 2019, stent, ubat jantung',
                allergies: 'Tiada',
                
                // Pre-Arrival Instructions
                preArrivalInstructions: 'Dudukkan pesakit. Beri Aspirin jika ada. Longgarkan pakaian. Sediakan untuk CPR.',
                paiGiven: true,
                
                // Full Summary (as sent by Dispatcher - ACTUAL FORMAT)
                fullCallSummary: `ğŸš‘ MECCHTAR DISPATCH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ Call Card: HTAR-20251202-08:32:00-AM-0003
ğŸ”´ Priority: P1
ğŸ“Ÿ Code: 10-D-1
ğŸ¥ MPDS: 10 - Sakit Dada / Chest Pain
ğŸ‘¤ Patient: Mohd Razak bin Abdullah
ğŸ‘¥ Count: 1
ğŸ©º Condition: Sakit dada teruk merebak ke lengan kiri, sesak nafas, berpeluh sejuk. CARDIAC HISTORY - Serangan jantung 2019, stent. Ubat: Aspirin, Plavix, Statin. Caller: Fatimah (Isteri) 019-1112233
ğŸ“ Location:
Surau Al-Hidayah, Jalan Kebun, Seksyen 7, 40000 Shah Alam. Dalam surau, berhampiran pintu keluar belakang. Landmark: Sebelah Pasar Malam Seksyen 7
ğŸ—ºï¸ Google Maps:
https://www.google.com/maps/search/?api=1&query=3.0642,101.5089
ğŸš’ Resources: HTAR3
ğŸ“„ PDF Link:
https://drive.google.com/file/d/mock-pdf-1236/view
ğŸ“ Notes: âš ï¸ HIGH PRIORITY - CARDIAC HISTORY. PAI - Dudukkan pesakit. Aspirin diberikan oleh isteri. Sediakan untuk CPR.
ğŸ‘¨â€ğŸ’¼ Dispatcher: Dispatcher Ahmad (D001)
â° Time: 2025-12-02 08:33:00
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`,

                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // DISPATCH ASSIGNMENT INFO
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                presetDestination: 'Hospital Tengku Ampuan Rahimah (HTAR)',
                resourceCallSign: 'HTAR3',
                resourceName: 'Ambulans HTAR Unit 3 (ALS)',
                resourcePhone: '03-33776153',
                resourceCategory: 'hospital',
                dispatchMethod: 'Radio',
                teamType: 'ALS',
                jobAssignment: '999',
                
                dispatcherName: 'Dispatcher Ahmad',
                dispatcherId: 'D001',
                dispatcherShift: 'AM',
                caseManagementDuration: '00:00:55',
                
                // Timestamps
                receivedTime: new Date(Date.now() - 120000).toISOString().slice(0, 19).replace('T', ' '),
                dispatcherAckTime: new Date(Date.now() - 100000).toISOString().slice(0, 19).replace('T', ' '),
                dispatcherAckBy: 'Dispatcher Ahmad',
                dispatchedTime: new Date(Date.now() - 30000).toISOString().slice(0, 19).replace('T', ' '),
                dispatchedBy: 'Dispatcher Ahmad',
                
                // Status
                queueStatus: 'Dispatched',
                isTestCase: true,
                pdfHyperlink: 'https://drive.google.com/file/d/mock-pdf-1236'
            },
            {
                // Identifiers
                id: 'Q-2024-120201-0004',
                queueId: 'Q-2024-120201-0004',
                recordId: 'R-2024-120201-001237',
                callCardNo: 'HTAR-20251202-08:20:00-AM-0004',
                assignmentId: 'ASGN-2024-120201-0004',
                
                // Call Taker Info
                callTaker: 'Hafiz bin Hashim (CT004)',
                callTakerId: 'CT004',
                
                // Priority & MPDS
                priority: 'P3',
                dispatchCode: '26-A-2',
                mpdsCode: '26',
                mpdsDisplayText: 'Sakit / Sick Person',
                mpds: '26 - Sakit / Sick Person',
                triage: 'stable',
                
                // Patient Info
                patientName: 'Priya a/p Rajan',
                patientAge: 34,
                patientGender: 'Female',
                patientCount: '1',
                
                // Caller Info
                callerName: 'Raj a/l Kumar',
                callerPhone: '017-4445566',
                callerRelation: 'Suami / Husband',
                
                // Location
                location: 'Flat Sri Angkasa, Blok C, Unit 12-5, Jalan Angkasa, 40000 Shah Alam',
                locationSummary: 'Flat Sri Angkasa, Blok C, Unit 12-5, Shah Alam',
                locationDetails: 'Tingkat 12, âš ï¸ Lif sedang rosak - guna tangga',
                landmark: 'Berhampiran Pasar Pagi Sri Angkasa',
                buildingType: 'Flat/Apartment',
                floor: 'Tingkat 12',
                lift: 'Rosak',
                latitude: 3.0789,
                longitude: 101.5456,
                gpsCoords: { lat: 3.0789, lng: 101.5456 },
                mapLink: 'https://maps.google.com/?q=3.0789,101.5456',
                
                // Clinical Info
                chiefComplaint: 'Demam tinggi 3 hari (39.5Â°C), lemah badan, tidak makan',
                condition: 'Demam tinggi 3 hari, lemah badan',
                conscious: 'Sedar',
                breathing: 'Normal',
                medHistory: 'Tiada',
                allergies: 'Seafood',
                
                // Pre-Arrival Instructions
                preArrivalInstructions: 'Beri air kosong. Turunkan suhu dengan tuala basah.',
                paiGiven: true,
                
                // Full Summary (as sent by Dispatcher - ACTUAL FORMAT)
                fullCallSummary: `ğŸš‘ MECCHTAR DISPATCH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ Call Card: HTAR-20251202-08:20:00-AM-0004
ğŸŸ¢ Priority: P3
ğŸ“Ÿ Code: 26-A-2
ğŸ¥ MPDS: 26 - Sakit / Sick Person
ğŸ‘¤ Patient: Priya a/p Rajan
ğŸ‘¥ Count: 1
ğŸ©º Condition: Demam tinggi 3 hari (39.5Â°C), lemah badan, tidak makan. Allergies: Seafood. Caller: Raj (Suami) 017-4445566
ğŸ“ Location:
Flat Sri Angkasa, Blok C, Unit 12-5, Jalan Angkasa, 40000 Shah Alam. âš ï¸ TINGKAT 12 - LIF ROSAK, GUNA TANGGA. Landmark: Berhampiran Pasar Pagi Sri Angkasa
ğŸ—ºï¸ Google Maps:
https://www.google.com/maps/search/?api=1&query=3.0789,101.5456
ğŸš’ Resources: HTAR4
ğŸ“„ PDF Link:
https://drive.google.com/file/d/mock-pdf-1237/view
ğŸ“ Notes: âš ï¸ Lif rosak - perlu naik tangga tingkat 12. PAI - Beri air kosong. Turunkan suhu dengan tuala basah.
ğŸ‘¨â€ğŸ’¼ Dispatcher: Dispatcher Razak (D003)
â° Time: 2025-12-02 08:23:20
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`,

                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // DISPATCH ASSIGNMENT INFO
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                presetDestination: 'Hospital Shah Alam',
                resourceCallSign: 'HTAR4',
                resourceName: 'Ambulans HTAR Unit 4',
                resourcePhone: '03-33776154',
                resourceCategory: 'hospital',
                dispatchMethod: 'WhatsApp',
                teamType: 'BLS',
                jobAssignment: '999',
                
                dispatcherName: 'Dispatcher Razak',
                dispatcherId: 'D003',
                dispatcherShift: 'AM',
                caseManagementDuration: '00:04:20',
                
                // Timestamps
                receivedTime: new Date(Date.now() - 600000).toISOString().slice(0, 19).replace('T', ' '),
                dispatcherAckTime: new Date(Date.now() - 540000).toISOString().slice(0, 19).replace('T', ' '),
                dispatcherAckBy: 'Dispatcher Razak',
                dispatchedTime: new Date(Date.now() - 180000).toISOString().slice(0, 19).replace('T', ' '),
                dispatchedBy: 'Dispatcher Razak',
                
                // Status
                queueStatus: 'Dispatched',
                isTestCase: true,
                pdfHyperlink: 'https://drive.google.com/file/d/mock-pdf-1237'
            },
            {
                // Identifiers - MVA case with multiple patients
                id: 'Q-2024-120201-0005',
                queueId: 'Q-2024-120201-0005',
                recordId: 'R-2024-120201-001238',
                callCardNo: 'HTAR-20251202-08:34:00-AM-0005',
                assignmentId: 'ASGN-2024-120201-0005',
                
                // Call Taker Info
                callTaker: 'Aminah binti Zainal (CT001)',
                callTakerId: 'CT001',
                
                // Priority & MPDS
                priority: 'P1',
                dispatchCode: '29-D-2',
                mpdsCode: '29',
                mpdsDisplayText: 'Kemalangan Jalan Raya / Traffic Accident',
                mpds: '29 - Kemalangan Jalan Raya / Traffic Accident',
                triage: 'critical-immediate',
                
                // Patient Info
                patientName: 'Pelbagai Mangsa / Multiple Victims',
                patientAge: null,
                patientGender: 'Mixed',
                patientCount: '3',
                
                // Caller Info
                callerName: 'Orang Awam / Bystander',
                callerPhone: '013-7778899',
                callerRelation: 'Saksi / Witness',
                
                // Location
                location: 'Lebuhraya NKVE, KM 23.5, Arah Shah Alam, berhampiran Exit Subang',
                locationSummary: 'NKVE KM 23.5, Arah Shah Alam',
                locationDetails: 'Lorong Kecemasan, kemalangan berbilang kenderaan (3 kereta)',
                landmark: 'Sebelum Exit Subang, papan tanda KM 23',
                buildingType: 'Lebuhraya',
                floor: '',
                lift: '',
                latitude: 3.1024,
                longitude: 101.5678,
                gpsCoords: { lat: 3.1024, lng: 101.5678 },
                mapLink: 'https://maps.google.com/?q=3.1024,101.5678',
                
                // Clinical Info
                chiefComplaint: 'Kemalangan 3 kereta, 3 mangsa terperangkap, 1 tidak sedar',
                condition: 'MVA - Multiple victims, entrapment',
                conscious: 'Campuran',
                breathing: 'Tidak Pasti',
                medHistory: 'Tidak Diketahui',
                allergies: 'Tidak Diketahui',
                
                // Pre-Arrival Instructions
                preArrivalInstructions: 'Jangan alihkan mangsa. Matikan enjin kenderaan. Jauhkan orang ramai. Tunggu pasukan kecemasan.',
                paiGiven: true,
                
                // Full Summary (as sent by Dispatcher - ACTUAL FORMAT)
                fullCallSummary: `ğŸš‘ MECCHTAR DISPATCH
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“‹ Call Card: HTAR-20251202-08:34:00-AM-0005
ğŸ”´ Priority: P1
ğŸ“Ÿ Code: 29-D-2
ğŸ¥ MPDS: 29 - Kemalangan Jalan Raya / Traffic Accident
ğŸ‘¤ Patient: Pelbagai Mangsa / Multiple Victims
ğŸ‘¥ Count: 3
ğŸ©º Condition: âš ï¸ MVA - 3 kereta terlibat. 3 mangsa (1 tidak sedar, terperangkap). Kemungkinan perlukan EMRS/Bomba. Caller: Orang Awam (Saksi) 013-7778899
ğŸ“ Location:
Lebuhraya NKVE, KM 23.5, Arah Shah Alam, Lorong Kecemasan. Landmark: Sebelum Exit Subang, papan tanda KM 23
ğŸ—ºï¸ Google Maps:
https://www.google.com/maps/search/?api=1&query=3.1024,101.5678
ğŸš’ Resources: HTAR5
ğŸ“„ PDF Link:
https://drive.google.com/file/d/mock-pdf-1238/view
ğŸ“ Notes: âš ï¸âš ï¸ MULTI-CASUALTY INCIDENT. Perlu koordinasi: Polis Trafik, Bomba (extrication), Backup ambulans. PAI - Jangan alihkan mangsa. Matikan enjin kenderaan. Jauhkan orang ramai.
ğŸ‘¨â€ğŸ’¼ Dispatcher: Dispatcher Ahmad (D001)
â° Time: 2025-12-02 08:34:45
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`,

                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                // DISPATCH ASSIGNMENT INFO
                // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
                presetDestination: 'Hospital Tengku Ampuan Rahimah (HTAR)',
                resourceCallSign: 'HTAR5',
                resourceName: 'Ambulans HTAR Unit 5 (ALS)',
                resourcePhone: '03-33776155',
                resourceCategory: 'hospital',
                dispatchMethod: 'Radio',
                teamType: 'ALS',
                jobAssignment: '999',
                
                dispatcherName: 'Dispatcher Ahmad',
                dispatcherId: 'D001',
                dispatcherShift: 'AM',
                caseManagementDuration: '00:00:45',
                
                // Timestamps - Very recent (urgent case)
                receivedTime: new Date(Date.now() - 60000).toISOString().slice(0, 19).replace('T', ' '),
                dispatcherAckTime: new Date(Date.now() - 50000).toISOString().slice(0, 19).replace('T', ' '),
                dispatcherAckBy: 'Dispatcher Ahmad',
                dispatchedTime: new Date(Date.now() - 15000).toISOString().slice(0, 19).replace('T', ' '),
                dispatchedBy: 'Dispatcher Ahmad',
                
                // Status
                queueStatus: 'Dispatched',
                isTestCase: true,
                pdfHyperlink: 'https://drive.google.com/file/d/mock-pdf-1238'
            }
        ];

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // INITIALIZATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ DOM Content Loaded');
            
            // Check for version updates
            checkVersionUpdate();
            updateVersionDisplay();
            console.log(`âœ… App Version: ${APP_VERSION} (${APP_BUILD_DATE})`);
            
            // Start clock
            updateClock();
            clockInterval = setInterval(updateClock, 1000);
            console.log('âœ… Clock started');

            // Load settings from localStorage
            loadSettings();
            console.log('âœ… Settings loaded');

            // Load case history from localStorage
            loadCaseHistory();
            console.log('âœ… Case history loaded');

            // Check for pending session
            checkPendingSession();
            console.log('âœ… Session check complete');

            console.log('ğŸš‘ MECCHTAR Responder App initialized - Ready for login!');
            
            // Debug: List key elements
            console.log('ğŸ” Key elements check:', {
                loginScreen: !!document.getElementById('loginScreen'),
                mainApp: !!document.getElementById('mainApp'),
                loginUnitId: !!document.getElementById('loginUnitId'),
                quickDemoBtn: !!document.querySelector('[onclick="quickDemoLogin()"]')
            });
        });
        
        // Update version display in settings, login, and header
        function updateVersionDisplay() {
            const pwaStatus = isInstalledPWA() ? 'ğŸ“± Installed' : 'ğŸŒ Browser';
            const versionText = `v${APP_VERSION} â€¢ ${APP_BUILD_DATE} â€¢ ${pwaStatus}`;
            
            // Settings modal version
            const versionEl = document.getElementById('versionDisplay');
            if (versionEl) {
                versionEl.innerHTML = versionText;
            }
            
            // Login screen version badge
            const loginBadge = document.getElementById('loginVersionBadge');
            if (loginBadge) {
                loginBadge.innerHTML = `MECCHTAR ResponderApp ${versionText}`;
            }
            
            // Header subtitle
            const headerVersion = document.getElementById('headerVersion');
            if (headerVersion) {
                headerVersion.innerHTML = `Pager Webapp v${APP_VERSION}`;
            }
        }
        
        // Check for updates (force refresh)
        function checkForUpdates() {
            showToast('info', 'ğŸ”„ Checking...', 'Looking for updates');
            
            // Clear service worker cache and reload
            if ('serviceWorker' in navigator && 'caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => caches.delete(name));
                }).then(() => {
                    // Unregister service worker
                    navigator.serviceWorker.getRegistrations().then(registrations => {
                        registrations.forEach(registration => {
                            registration.unregister();
                        });
                    }).then(() => {
                        // Force reload from server
                        setTimeout(() => {
                            window.location.reload(true);
                        }, 500);
                    });
                });
            } else {
                // Simple reload for browsers without SW
                window.location.reload(true);
            }
        }
        
        // Check if running as installed PWA
        function isInstalledPWA() {
            return window.matchMedia('(display-mode: standalone)').matches || 
                   window.navigator.standalone === true;
        }

        function updateClock() {
            const now = new Date();
            const time = now.toLocaleTimeString('en-MY', { 
                hour: '2-digit', 
                minute: '2-digit', 
                second: '2-digit', 
                hour12: false 
            });
            const date = now.toLocaleDateString('en-MY', { 
                weekday: 'short', 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });

            const clockEl = document.getElementById('liveClock');
            const dateEl = document.getElementById('liveDate');
            if (clockEl) clockEl.textContent = time;
            if (dateEl) dateEl.textContent = date;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // MODE SELECTION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function selectMode(mode) {
            appState.mode = mode;

            // Update UI
            document.querySelectorAll('.login-option').forEach(el => {
                el.classList.remove('active');
                if (el.dataset.mode === mode) {
                    el.classList.add('active');
                }
            });
        }

        // Quick Demo Login - auto-fills and submits
        function quickDemoLogin() {
            console.log('âš¡ quickDemoLogin called');
            
            appState.mode = 'demo';
            document.getElementById('loginUnitId').value = 'HTAR1';
            document.getElementById('loginStaffId').value = 'R001';
            document.getElementById('loginPassword').value = 'demo123';
            document.getElementById('loginCrewName').value = 'Ahmad & Siti';
            document.getElementById('loginShift').value = 'AM';

            // Directly complete login
            completeLogin('HTAR1', 'R001', 'Ahmad & Siti', 'AM');
        }

        // Clear localStorage for troubleshooting
        function clearLocalStorage() {
            localStorage.removeItem('responderSession');
            localStorage.removeItem('responderSettings');
            localStorage.removeItem('responderCaseHistory');
            alert('Session data cleared! Please refresh the page.');
            location.reload();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // LOGIN HANDLING
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function handleLogin(event) {
            event.preventDefault();

            const unitId = document.getElementById('loginUnitId').value.trim();
            const staffId = document.getElementById('loginStaffId').value.trim();
            const password = document.getElementById('loginPassword').value;
            const crewName = document.getElementById('loginCrewName').value.trim();
            const shift = document.getElementById('loginShift').value;

            if (!unitId || !staffId || !password || !crewName) {
                showToast('warning', 'Maklumat Tidak Lengkap', 'Sila isi semua ruangan yang diperlukan');
                return;
            }

            // In demo mode, accept any credentials
            if (appState.mode === 'demo') {
                completeLogin(unitId, staffId, crewName, shift);
            } else {
                // Live mode - validate against backend
                validateLiveLogin(unitId, staffId, password, crewName, shift);
            }
        }

        async function validateLiveLogin(unitId, staffId, password, crewName, shift) {
            showToast('info', 'ğŸ”„ Validating...', 'Checking credentials with backend...');
            
            // First test connection
            const pingResult = await testBackendConnection();
            if (!pingResult.success) {
                showToast('error', 'âŒ Connection Failed', 'Cannot connect to backend. Check URL in settings.');
                return;
            }

            // Validate credentials
            const result = await backendRequest('validateCredentials', {
                unitId: unitId,
                staffId: staffId,
                password: password
            });

            if (!result.success) {
                showToast('error', 'âŒ Login Failed', result.error || 'Invalid credentials');
                return;
            }

            // Complete login
            completeLogin(unitId, staffId, crewName, shift);

            // Login to backend (create session)
            const loginResult = await loginToBackend();
            if (loginResult.success) {
                showToast('success', 'âœ… Connected', 'Backend session established');
            }
        }

        function completeLogin(unitId, staffId, crewName, shift) {
            console.log('ğŸ” completeLogin called with:', { unitId, staffId, crewName, shift });
            
            try {
                appState.isLoggedIn = true;
                appState.unitId = unitId;
                appState.staffId = staffId;
                appState.crewName = crewName;
                appState.shift = shift;
                appState.loginTime = new Date().toISOString();
                console.log('âœ… appState updated');

                // Update UI
                const unitDisplay = document.getElementById('unitDisplay');
                const crewDisplay = document.getElementById('crewDisplay');
                const modeBadge = document.getElementById('modeBadge');
                
                console.log('ğŸ” Elements found:', { unitDisplay: !!unitDisplay, crewDisplay: !!crewDisplay, modeBadge: !!modeBadge });
                
                if (unitDisplay) unitDisplay.textContent = unitId;
                if (crewDisplay) crewDisplay.textContent = crewName;
                if (modeBadge) {
                    modeBadge.textContent = appState.mode === 'demo' ? 'DEMO' : 'LIVE';
                    modeBadge.className = 'mode-badge ' + appState.mode;
                }
                console.log('âœ… Header UI updated');

                // Show/hide appropriate menu items
                const testCaseMenu = document.getElementById('testCaseMenu');
                const waitingCard = document.getElementById('waitingForDispatchCard');
                const importCard = document.getElementById('importDispatchCard');
                
                console.log('ğŸ” Menu elements:', { testCaseMenu: !!testCaseMenu, waitingCard: !!waitingCard, importCard: !!importCard });
                
                if (appState.mode === 'demo') {
                    if (testCaseMenu) testCaseMenu.classList.remove('hidden');
                    if (waitingCard) waitingCard.classList.add('hidden');
                    if (importCard) importCard.classList.add('hidden');
                } else {
                    if (testCaseMenu) testCaseMenu.classList.add('hidden');
                    if (waitingCard) waitingCard.classList.remove('hidden');
                    if (importCard) importCard.classList.remove('hidden');
                    startWaitingTimer();
                    startDispatchPolling();
                }
                console.log('âœ… Menu items configured');

                // Switch screens
                const loginScreen = document.getElementById('loginScreen');
                const mainApp = document.getElementById('mainApp');
                
                console.log('ğŸ” Screen elements:', { loginScreen: !!loginScreen, mainApp: !!mainApp });
                
                if (loginScreen) {
                    loginScreen.classList.add('hidden');
                    console.log('âœ… Login screen hidden');
                }
                if (mainApp) {
                    mainApp.classList.remove('hidden');
                    console.log('âœ… Main app shown');
                }

                // Save session
                saveSession();
                console.log('âœ… Session saved');

                showToast('success', 'Login Berjaya', `Selamat datang, ${crewName}!`);
                addAutoNote(`Login: ${unitId} - ${crewName} (${shift})`);
                
                console.log('ğŸ‰ Login complete!');
            } catch (error) {
                console.error('âŒ Login error:', error);
                alert('Login error: ' + error.message);
            }
        }

        async function handleLogout() {
            if (appState.currentCase) {
                showToast('warning', 'Misi Aktif', 'Sila selesaikan misi semasa sebelum log keluar');
                return;
            }

            if (confirm('Adakah anda pasti untuk log keluar?\nAre you sure you want to logout?')) {
                // Stop polling
                stopDispatchPolling();

                // Logout from backend (if in live mode)
                if (appState.mode === 'live' && appState.sessionId) {
                    await logoutFromBackend();
                }

                clearSession();
                resetAppState();

                document.getElementById('mainApp').classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');

                showToast('info', 'Log Keluar', 'Anda telah log keluar');
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SESSION MANAGEMENT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function saveSession() {
            const session = {
                mode: appState.mode,
                unitId: appState.unitId,
                staffId: appState.staffId,
                crewName: appState.crewName,
                shift: appState.shift,
                loginTime: appState.loginTime,
                sessionId: appState.sessionId,
                missionId: appState.missionId
            };
            localStorage.setItem('responderSession', JSON.stringify(session));
        }

        function clearSession() {
            localStorage.removeItem('responderSession');
        }

        function checkPendingSession() {
            console.log('ğŸ” Checking for pending session...');
            const saved = localStorage.getItem('responderSession');
            if (saved) {
                console.log('ğŸ“¦ Found saved session');
                try {
                    const session = JSON.parse(saved);
                    
                    // Validate session has required fields
                    if (!session.unitId || !session.staffId || !session.crewName) {
                        console.log('âš ï¸ Session missing required fields, clearing...');
                        clearSession();
                        return;
                    }
                    
                    // Check if session is less than 12 hours old
                    const loginTime = new Date(session.loginTime);
                    const now = new Date();
                    const hoursDiff = (now - loginTime) / (1000 * 60 * 60);
                    
                    console.log('â° Session age:', hoursDiff.toFixed(2), 'hours');

                    if (hoursDiff < 12) {
                        // Auto-restore session
                        console.log('âœ… Restoring valid session...');
                        appState.mode = session.mode || 'demo';
                        appState.sessionId = session.sessionId || null;
                        appState.missionId = session.missionId || null;
                        
                        // If live mode, always try to connect to backend
                        if (appState.mode === 'live') {
                            backendConnected = true; // Assume connected, will fail gracefully if not
                            console.log('ğŸ“¡ Live mode - backend connection enabled');
                        }
                        
                        completeLogin(session.unitId, session.staffId, session.crewName, session.shift || 'AM');
                        showToast('info', 'Sesi Dipulihkan', 'Session restored from previous login');
                    } else {
                        console.log('â° Session expired, clearing...');
                        clearSession();
                    }
                } catch (e) {
                    console.error('âŒ Error parsing session:', e);
                    clearSession();
                }
            } else {
                console.log('â„¹ï¸ No saved session found - showing login screen');
            }
        }

        function resetAppState() {
            appState.isLoggedIn = false;
            appState.unitId = '';
            appState.staffId = '';
            appState.crewName = '';
            appState.sessionId = null;
            appState.missionId = null;
            appState.currentCase = null;
            appState.destination = '';
            appState.destinationConfirmed = false;
            appState.missionStartTime = null;
            appState.missionEndTime = null;
            appState.autoNotes = [];
            appState.freeTextNotes = '';
            appState.overrideUsed = false;
            appState.overrideReason = null;
            appState.skippedPhases = [];
            appState.skipConfirmations = {};
            appState.skipAllConfirmations = false;
            appState.pendingDispatch = null;
            appState.pendingDispatches = [];
            
            // Clear backend connection
            backendConnected = false;

            // Reset phases
            appState.phases.forEach(phase => {
                phase.completed = false;
                phase.time = null;
                phase.duration = null;
                phase.overridden = false;
                phase.gps = null;
            });

            // Clear timers
            if (missionTimerInterval) clearInterval(missionTimerInterval);
            if (ongoingPhaseTimerInterval) clearInterval(ongoingPhaseTimerInterval);
            if (waitingTimerInterval) clearInterval(waitingTimerInterval);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SETTINGS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function loadSettings() {
            const saved = localStorage.getItem('responderSettings');
            if (saved) {
                try {
                    appState.settings = { ...appState.settings, ...JSON.parse(saved) };
                    
                    // Restore backend URL to config
                    if (appState.settings.backendUrl) {
                        BACKEND_CONFIG.RESPONDER_BACKEND_URL = appState.settings.backendUrl;
                        console.log('âœ… Backend URL restored from settings:', appState.settings.backendUrl);
                    }
                } catch (e) {
                    console.error('Error loading settings:', e);
                }
            }
        }

        function saveSettings() {
            appState.settings.notificationSound = document.getElementById('settingNotificationSound').value;
            appState.settings.autoGPS = document.getElementById('settingAutoGPS').value;
            appState.settings.backendUrl = document.getElementById('settingBackendUrl').value.trim();

            // Sync to BACKEND_CONFIG for immediate effect
            if (appState.settings.backendUrl) {
                BACKEND_CONFIG.RESPONDER_BACKEND_URL = appState.settings.backendUrl;
            }

            localStorage.setItem('responderSettings', JSON.stringify(appState.settings));
            closeModal('settingsModal');
            showToast('success', 'Tetapan Disimpan', 'Settings saved successfully');
            
            // If in live mode and URL was updated, test connection
            if (appState.mode === 'live' && appState.settings.backendUrl) {
                testBackendConnection();
            }
        }

        // Settings password (same as Supervisor module)
        const SETTINGS_PASSWORD = 'Supervisor@999';

        function openSettings() {
            // Prompt for password
            const password = prompt('ğŸ”’ Enter Settings Password:\n(Contact supervisor for access)');
            
            if (!password) {
                return; // Cancelled
            }
            
            if (password !== SETTINGS_PASSWORD) {
                showToast('error', 'âŒ Access Denied', 'Invalid password');
                return;
            }
            
            // Password correct - open settings
            document.getElementById('settingNotificationSound').value = appState.settings.notificationSound;
            document.getElementById('settingAutoGPS').value = appState.settings.autoGPS;
            document.getElementById('settingBackendUrl').value = appState.settings.backendUrl || BACKEND_CONFIG.RESPONDER_BACKEND_URL || '';
            document.getElementById('backendTestResult').innerHTML = ''; // Clear previous test result
            openModal('settingsModal');
            showToast('success', 'ğŸ”“ Access Granted', 'Settings unlocked');
        }

        async function testBackendFromSettings() {
            const urlInput = document.getElementById('settingBackendUrl');
            const resultDiv = document.getElementById('backendTestResult');
            const url = urlInput.value.trim();
            
            if (!url) {
                resultDiv.innerHTML = '<span style="color: var(--warning);">âš ï¸ Please enter a URL first</span>';
                return;
            }
            
            resultDiv.innerHTML = '<span style="color: var(--info);">ğŸ”„ Testing connection...</span>';
            
            try {
                const response = await fetch(`${url}?action=ping`);
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.innerHTML = `<span style="color: var(--success);">âœ… Connected! ${result.message || ''}</span>`;
                    showToast('success', 'âœ… Connection OK', result.message || 'Backend is reachable');
                } else {
                    resultDiv.innerHTML = `<span style="color: var(--danger);">âŒ Error: ${result.error || 'Unknown error'}</span>`;
                    showToast('error', 'âŒ Connection Failed', result.error || 'Backend returned an error');
                }
            } catch (error) {
                resultDiv.innerHTML = `<span style="color: var(--danger);">âŒ Failed: ${error.message}</span>`;
                showToast('error', 'âŒ Connection Failed', error.message);
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CASE HISTORY
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function loadCaseHistory() {
            const saved = localStorage.getItem('responderCaseHistory');
            if (saved) {
                try {
                    appState.completedCases = JSON.parse(saved);
                } catch (e) {
                    appState.completedCases = [];
                }
            }
        }

        function saveCaseHistory() {
            // Keep only last 50 cases
            if (appState.completedCases.length > 50) {
                appState.completedCases = appState.completedCases.slice(-50);
            }
            localStorage.setItem('responderCaseHistory', JSON.stringify(appState.completedCases));
        }

        function openCaseHistory() {
            const container = document.getElementById('caseHistoryList');

            if (appState.completedCases.length === 0) {
                container.innerHTML = `
                    <p style="text-align: center; color: var(--muted); padding: 30px;">
                        Tiada sejarah kes<br><em>No case history</em>
                    </p>
                `;
            } else {
                container.innerHTML = appState.completedCases.map((c, idx) => `
                    <div style="background: var(--bg); padding: 12px; border-radius: 8px; margin-bottom: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <strong style="color: var(--accent);">${c.callCardNo || 'N/A'}</strong>
                            <span style="background: ${c.priority === 'P1' ? 'var(--danger)' : c.priority === 'P2' ? 'var(--warning)' : 'var(--info)'}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; font-weight: 700;">${c.priority || 'N/A'}</span>
                        </div>
                        <div style="font-size: 0.85rem; color: var(--muted);">
                            ${c.patientName || 'Unknown'} | ${c.chiefComplaint || 'N/A'}
                        </div>
                        <div style="font-size: 0.8rem; color: var(--muted); margin-top: 4px;">
                            ğŸ“… ${c.completedAt || 'N/A'} | â±ï¸ ${c.totalTime || 'N/A'}
                        </div>
                    </div>
                `).join('');
            }

            openModal('caseHistoryModal');
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CONTACTS DIRECTORY
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        // Local contacts cache
        let contactsCache = [];
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // MECCHTAR MASTER DIRECTORY v2.0 - Based on Responder_Directory Google Sheets
        // Last Updated: 2025-12-02
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const builtInContacts = [
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // HOSPITAL HTAR - Responders (Ambulances)
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            { id: 'HTAR1', name: 'Responder 1 (HTAR1)', role: 'Responder', category: 'Hospital HTAR', phone: '601162621439', password: 'Htar@1231' },
            { id: 'HTAR2', name: 'Responder 2 (HTAR2)', role: 'Responder', category: 'Hospital HTAR', phone: '601162621432', password: 'Htar@1232' },
            { id: 'HTAR3', name: 'Responder 3 (HTAR3)', role: 'Responder', category: 'Hospital HTAR', phone: '601162621451', password: 'Htar@1233' },
            { id: 'HTAR4', name: 'Responder 4 (HTAR4)', role: 'Responder', category: 'Hospital HTAR', phone: '601162619400', password: 'Htar@1234' },
            { id: 'HTAR5', name: 'Responder 5 (HTAR5)', role: 'Responder', category: 'Hospital HTAR', phone: '601162621274', password: 'Htar@1235' },
            { id: 'CPERT', name: 'CPERT', role: 'CPERT', category: 'Hospital HTAR', phone: '60109229391', password: 'Cpert@1231' },
            
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // HOSPITAL HTAR - MECC Dispatchers
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            { id: 'MECC1', name: 'MECC1', role: 'Dispatcher', category: 'Hospital HTAR', phone: '601162621386', password: 'Mecc@1231' },
            { id: 'MECC2', name: 'MECC2', role: 'Dispatcher', category: 'Hospital HTAR', phone: '601162621390', password: 'Mecc@1232' },
            { id: 'MECC3', name: 'MECC3', role: 'Dispatcher', category: 'Hospital HTAR', phone: '601162621423', password: 'Mecc@1233' },
            { id: 'MECC4', name: 'MECC4', role: 'Dispatcher', category: 'Hospital HTAR', phone: '601162621453', password: 'Mecc@1234' },
            { id: 'MECC5', name: 'MECC5', role: 'Dispatcher', category: 'Hospital HTAR', phone: '601162621326', password: 'Mecc@1235' },
            { id: 'MECCDL', name: 'MECC Direct Line', role: 'Direct Line', category: 'Hospital HTAR', phone: '60333717989' },
            
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // HOSPITAL HTAR - Supervisors & Key Contacts
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            { id: 'SuperPHCAS', name: 'Supervisor PHCAS', role: 'Supervisor', category: 'Hospital HTAR', phone: '60109219391', password: 'Supphcas@1231' },
            { id: 'SuperED', name: 'Supervisor ED', role: 'Supervisor', category: 'Hospital HTAR', phone: '60109209391', password: 'Suped@1231' },
            { id: 'EP', name: 'EP (Emergency Physician)', role: 'EP', category: 'Hospital HTAR', phone: '60162619393', password: 'Ep@1231' },
            { id: 'SisED', name: 'Sister ED', role: 'Sister', category: 'Hospital HTAR', phone: '60163599391', password: 'Sis@1231' },
            { id: 'PHCASEP', name: 'PHCAS EP Oncall', role: 'EP Oncall', category: 'Hospital HTAR', phone: '', password: 'Phcasep@1231' },
            { id: 'Telephonist', name: 'Telephonist (Operator)', role: 'Operator', category: 'Hospital HTAR', phone: '60333757000' },
            { id: 'EDHTAR', name: 'ED HTAR', role: 'ED', category: 'Hospital HTAR', phone: '', password: 'Edhtar@1231' },
            
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // HOSPITAL SHAH ALAM
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            { id: 'EDSHALAM', name: 'ED Shah Alam', role: 'ED', category: 'Hospital Shah Alam', phone: '', password: 'Edshas@1231' },
            { id: 'HSAS1', name: 'Ambulans HS.Alam 1', role: 'Ambulance', category: 'Hospital Shah Alam', phone: '601162623151', password: 'Hsas@1231' },
            { id: 'HSAS2', name: 'Ambulans HS.Alam 2', role: 'Ambulance', category: 'Hospital Shah Alam', phone: '601162623191', password: 'Hsas@1232' },
            { id: 'HSAS3', name: 'Ambulans HS.Alam 3', role: 'Ambulance', category: 'Hospital Shah Alam', phone: '601162623545', password: 'Hsas@1233' },
            { id: 'HSAS4', name: 'Ambulans HS.Alam 4', role: 'Ambulance', category: 'Hospital Shah Alam', phone: '', password: 'Hsas@1234' },
            
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // HOSPITAL BANTING
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            { id: 'EDBANTING', name: 'ED Banting', role: 'ED', category: 'Hospital Banting', phone: '', password: 'Edbanting@1232' },
            { id: 'HBT1', name: 'Ambulans HBanting 1', role: 'Ambulance', category: 'Hospital Banting', phone: '601162621573', password: 'Hb@1231' },
            { id: 'HBT2', name: 'Ambulans HBanting 2', role: 'Ambulance', category: 'Hospital Banting', phone: '601162621714', password: 'Hb@1232' },
            { id: 'HBT3', name: 'Ambulans HBanting 3', role: 'Ambulance', category: 'Hospital Banting', phone: '', password: 'Hb@1233' },
            
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // KESIHATAN KLANG (10 KK)
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            { id: 'KKKapar', name: 'Ambulans KK Kapar', role: 'Ambulance', category: 'Kesihatan Klang', phone: '601162619655', password: 'Kkkapar@1231' },
            { id: 'KKMeru', name: 'Ambulans KK Meru', role: 'Ambulance', category: 'Kesihatan Klang', phone: '601162620457', password: 'Kkmeru@1231' },
            { id: 'KKPIndah', name: 'Ambulans KK P.Indah', role: 'Ambulance', category: 'Kesihatan Klang', phone: '601162616949', password: 'Kkpindah@1231' },
            { id: 'KKPelabuhan', name: 'Ambulans KK Pelabuhan', role: 'Ambulance', category: 'Kesihatan Klang', phone: '601162616944', password: 'Kkpelabuhan@1231' },
            { id: 'KKBBotani', name: 'Ambulans KK B.Botani', role: 'Ambulance', category: 'Kesihatan Klang', phone: '601162619511', password: 'Kkbbotani@1231' },
            { id: 'KKRPanjang', name: 'Ambulans KK R.Panjang', role: 'Ambulance', category: 'Kesihatan Klang', phone: '601162616971', password: 'Kkrpanjang@1231' },
            { id: 'KKPandamaran', name: 'Ambulans KK Pandamaran', role: 'Ambulance', category: 'Kesihatan Klang', phone: '601162621865', password: 'Kkpandamaran@1231' },
            { id: 'KKAnika', name: 'Ambulans KK Anika', role: 'Ambulance', category: 'Kesihatan Klang', phone: '601162619500', password: 'Kkanika@1231' },
            { id: 'KKBKuda', name: 'Ambulans KK B.Kuda', role: 'Ambulance', category: 'Kesihatan Klang', phone: '601162619522', password: 'Kkbkuda@1231' },
            { id: 'KKBNaga', name: 'Ambulans KK B.Naga', role: 'Ambulance', category: 'Kesihatan Klang', phone: '601162619544', password: 'Kkbnaga@1231' },
            
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // KESIHATAN KUALA LANGAT (5 KK)
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            { id: 'KKTSepat', name: 'Ambulans KK Tanjung Sepat', role: 'Ambulance', category: 'Kesihatan Kuala Langat', phone: '601162619544', password: 'Kktsepat@1231' },
            { id: 'KKBandar', name: 'Ambulans KK Bandar', role: 'Ambulance', category: 'Kesihatan Kuala Langat', phone: '601162619544', password: 'Kkbandar@1231' },
            { id: 'KKBCanggang', name: 'Ambulans KK B.Canggang', role: 'Ambulance', category: 'Kesihatan Kuala Langat', phone: '601162619544', password: 'Kkbcanggang@1231' },
            { id: 'KKJenjarom', name: 'Ambulans KK Jenjarom', role: 'Ambulance', category: 'Kesihatan Kuala Langat', phone: '601162619544', password: 'Kkbjenjarom@1231' },
            { id: 'TPGarang', name: 'Ambulans TP Garang', role: 'Ambulance', category: 'Kesihatan Kuala Langat', phone: '', password: 'Kktpgarang@1231' },
            
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // AGENSI LAIN
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            { id: 'SJAM1', name: 'Ambulans SJAM1', role: 'Ambulance', category: 'Agensi Lain', phone: '601162619488', password: 'Sjam1@1231' },
            { id: 'SJAMSDE', name: 'SJAM Selangor', role: 'Agency HQ', category: 'Agensi Lain', phone: '60333715005' },
            { id: 'SJAMNHQ', name: 'SJAM Ibupejabat', role: 'Agency HQ', category: 'Agensi Lain', phone: '60392851576' },
            { id: 'JBPM', name: 'Jabatan Bomba dan Penyelamat', role: 'Agency', category: 'Agensi Lain', phone: '60355145222' },
            { id: 'PDRM', name: 'PDRM Kontijen Selangor', role: 'Agency', category: 'Agensi Lain', phone: '6033710820' },
            { id: 'APMM', name: 'Angkatan Pertahanan Awam (APM)', role: 'Agency', category: 'Agensi Lain', phone: '60333710820' },
            
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // SUMBER LUAR MECC / EXTERNAL RESOURCES
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            { id: 'HASA1', name: 'Ambulans HASA', role: 'External', category: 'Sumber Luar MECC', phone: '' },
            { id: 'HUKM1', name: 'HUKM', role: 'Hospital', category: 'Sumber Luar MECC', phone: '60391455555' },
            { id: 'PPUM1', name: 'PPUM', role: 'Hospital', category: 'Sumber Luar MECC', phone: '60379494422' },
            { id: 'PPUPM', name: 'PPUPM', role: 'Hospital', category: 'Sumber Luar MECC', phone: '60397695500' },
            { id: 'HKL1', name: 'HKL', role: 'Hospital', category: 'Sumber Luar MECC', phone: '60326155555' },
            
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // KAKITANGAN PHCAS HTAR (27 Staff)
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            { id: 'AR', name: 'Abd Rahman Bin Abd. Aziz', role: 'Staff', category: 'Kakitangan PHCAS HTAR', phone: '60122570293' },
            { id: 'AMBI', name: 'Ahmad Muhaiminzee Bin Ismail', role: 'Staff', category: 'Kakitangan PHCAS HTAR', phone: '60199157211' },
            { id: 'AAM', name: 'Aiman Aizuddin Bin Mazlan', role: 'Staff', category: 'Kakitangan PHCAS HTAR', phone: '601123337183' },
            { id: 'AH', name: 'Amri Bin Hamat', role: 'Staff', category: 'Kakitangan PHCAS HTAR', phone: '60129292344' },
            { id: 'CHENOR', name: 'Che Norhisyam Bin Che Husin', role: 'Staff', category: 'Kakitangan PHCAS HTAR', phone: '60199277009' },
            { id: 'FBS', name: 'Faizal Bin Salim', role: 'Staff', category: 'Kakitangan PHCAS HTAR', phone: '60162638814' },
            { id: 'KEBR', name: 'Kamarul Efendi Bin Radzali', role: 'Staff', category: 'Kakitangan PHCAS HTAR', phone: '60145356522' },
            { id: 'MZ', name: 'Mohamad Zafir Bin Isa', role: 'Staff', category: 'Kakitangan PHCAS HTAR', phone: '60146646277' },
            { id: 'MH', name: 'Mohammad Hadi Bin Anuar', role: 'Staff', category: 'Kakitangan PHCAS HTAR', phone: '60147584314' },
            { id: 'MZM', name: 'Mohammad Zulhakimi Bin Maruding', role: 'Staff', category: 'Kakitangan PHCAS HTAR', phone: '60145102058' },
            { id: 'MAH', name: 'Mohd Akmal Hadi Bin Zakaria', role: 'Staff', category: 'Kakitangan PHCAS HTAR', phone: '60183101074' },
            { id: 'MAA', name: 'Mohd Amirun Bin Ahmad', role: 'Staff', category: 'Kakitangan PHCAS HTAR', phone: '60132214273' },
            { id: 'MAAH', name: 'Mohd Ashraf Bin Abdul Halim', role: 'Staff', category: 'Kakitangan PHCAS HTAR', phone: '60162515144' },
            { id: 'MAZA', name: 'Mohd Asrul Bin Zainol Abidin', role: 'Staff', category: 'Kakitangan PHCAS HTAR', phone: '60123416790' },
            { id: 'MF', name: 'Mohd Fakruruzee Bin Jaafar', role: 'Staff', category: 'Kakitangan PHCAS HTAR', phone: '60199962284' },
            { id: 'MHAD', name: 'Mohd Halim Bin Ali Din', role: 'Staff', category: 'Kakitangan PHCAS HTAR', phone: '60143895325' },
            { id: 'MIMN', name: 'Mohd Imran Bin Mohd Nor', role: 'Staff', category: 'Kakitangan PHCAS HTAR', phone: '60129594215' },
            { id: 'MABA', name: 'Muhamad Azri Bin Aziz', role: 'Staff', category: 'Kakitangan PHCAS HTAR', phone: '60145328221' },
            { id: 'MHMN', name: 'Muhamad Hafizuddin Bin Muhamad Noor', role: 'Staff', category: 'Kakitangan PHCAS HTAR', phone: '60139404065' },
            { id: 'MNBO', name: 'Muhamad Nabil Bin Othman', role: 'Staff', category: 'Kakitangan PHCAS HTAR', phone: '60132586709' },
            { id: 'MHBN', name: 'Muhammad Hazim Bin Nasaruddin', role: 'Staff', category: 'Kakitangan PHCAS HTAR', phone: '601110203938' },
            { id: 'MSBA', name: 'Muhammad Samhari Bin Aris', role: 'Staff', category: 'Kakitangan PHCAS HTAR', phone: '60136769636' },
            { id: 'MSABK', name: 'Muhammad Shahrul Azwan Bin Kamaruddin', role: 'Staff', category: 'Kakitangan PHCAS HTAR', phone: '60172737381' },
            { id: 'MSBZ', name: 'Muhammad Syafiq Izzat Bin Zolnaldi', role: 'Staff', category: 'Kakitangan PHCAS HTAR', phone: '60198328266' },
            { id: 'RET', name: 'Revichandran A/L Thangavelu', role: 'Staff', category: 'Kakitangan PHCAS HTAR', phone: '601137962812' },
            { id: 'TGD', name: 'Tg Dasuki Irfan Bin Tengku Kamrulzaman', role: 'Staff', category: 'Kakitangan PHCAS HTAR', phone: '60199047752' },
            { id: 'WMRWB', name: 'Wan Mohd Ridzuan Bin Wan Berahim', role: 'Staff', category: 'Kakitangan PHCAS HTAR', phone: '60183920125' },
            
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // KAKITANGAN JKT (3 Doctors)
            // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            { id: 'DRAT', name: 'Dr Ahmad Tajuddin bin Mohamad Nor', role: 'Doctor', category: 'Kakitangan JKT', phone: '60163119391', password: 'Drat@1231' },
            { id: 'DRK', name: 'Dr Mohd Khairizam bin Mohd Yusof', role: 'Doctor', category: 'Kakitangan JKT', phone: '60129509147', password: 'Drk@1231' },
            { id: 'DRRBAR', name: 'Dr Rafidah binti Abdul Rahim', role: 'Doctor', category: 'Kakitangan JKT', phone: '60137410929', password: 'Drrbar@1231' }
        ];
        
        async function openContactsDirectory() {
            openModal('contactsModal');
            await loadContacts();
        }
        
        async function loadContacts() {
            const container = document.getElementById('contactsList');
            container.innerHTML = '<p style="text-align: center; padding: 30px;">ğŸ”„ Loading contacts...</p>';
            
            // Try to load from backend first
            if (appState.mode === 'live' && BACKEND_CONFIG.RESPONDER_BACKEND_URL) {
                try {
                    const result = await backendRequest('getContacts', {});
                    if (result.success && result.contacts && result.contacts.length > 0) {
                        contactsCache = result.contacts.map(c => ({
                            id: c.ContactID,
                            name: c.Name,
                            role: c.Role,
                            category: c.Category,
                            phone: c.Phone,
                            whatsapp: c.WhatsApp || c.Phone
                        }));
                        renderContacts();
                        return;
                    }
                } catch (e) {
                    console.warn('Failed to load contacts from backend:', e);
                }
            }
            
            // Fallback to built-in contacts
            contactsCache = builtInContacts;
            renderContacts();
        }
        
        function refreshContacts() {
            loadContacts();
            showToast('info', 'ğŸ”„ Refreshing', 'Updating contacts...');
        }
        
        function filterContacts() {
            renderContacts();
        }
        
        function renderContacts() {
            const container = document.getElementById('contactsList');
            const filter = document.getElementById('contactCategoryFilter').value;
            
            let filteredContacts = contactsCache;
            if (filter !== 'all') {
                filteredContacts = contactsCache.filter(c => c.category === filter);
            }
            
            if (filteredContacts.length === 0) {
                container.innerHTML = `
                    <p style="text-align: center; color: var(--muted); padding: 30px;">
                        Tiada kontak dijumpai<br><em>No contacts found</em>
                    </p>
                `;
                return;
            }
            
            // Group by category
            const grouped = {};
            filteredContacts.forEach(c => {
                if (!grouped[c.category]) grouped[c.category] = [];
                grouped[c.category].push(c);
            });
            
            let html = '';
            for (const [category, contacts] of Object.entries(grouped)) {
                html += `<div style="font-weight: 700; color: var(--accent); margin: 15px 0 10px 0; padding-bottom: 5px; border-bottom: 1px solid var(--border);">${category}</div>`;
                
                contacts.forEach(c => {
                    const phoneFormatted = formatPhoneNumber(c.phone);
                    html += `
                        <div style="background: var(--bg); padding: 12px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 600; color: var(--text);">${c.name}</div>
                                <div style="font-size: 0.8rem; color: var(--muted);">${c.role} | ${c.id}</div>
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <a href="tel:${c.phone}" class="btn btn-success btn-sm" style="padding: 6px 10px;">
                                    ğŸ“
                                </a>
                                <a href="https://wa.me/${c.phone}" target="_blank" class="btn btn-info btn-sm" style="padding: 6px 10px; background: #25D366;">
                                    ğŸ’¬
                                </a>
                            </div>
                        </div>
                    `;
                });
            }
            
            container.innerHTML = html;
        }
        
        function formatPhoneNumber(phone) {
            if (!phone) return '';
            // Format: 601162623151 -> +60 11-6262 3151
            const str = String(phone);
            if (str.startsWith('60')) {
                return '+' + str.slice(0, 2) + ' ' + str.slice(2, 4) + '-' + str.slice(4, 8) + ' ' + str.slice(8);
            }
            return phone;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // TEST CASE HANDLING (DEMO MODE)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function openTestCaseSelector() {
            const container = document.getElementById('testCaseList');
            container.innerHTML = testCases.map(tc => {
                // Priority colors
                const priorityBg = tc.priority === 'P1' ? 'var(--danger)' : 
                                   tc.priority === 'P2' ? 'var(--warning)' : 
                                   tc.priority === 'P3' ? 'var(--success)' : 'var(--info)';
                
                // Patient info
                const patientInfo = tc.patientAge 
                    ? `${tc.patientName}, ${tc.patientAge} ${tc.patientGender === 'Male' ? 'â™‚ï¸' : tc.patientGender === 'Female' ? 'â™€ï¸' : ''}`
                    : tc.patientName;
                
                // Patient count badge
                const patientBadge = tc.patientCount && parseInt(tc.patientCount) > 1 
                    ? `<span style="background: var(--danger); color: white; padding: 1px 6px; border-radius: 8px; font-size: 0.7rem; margin-left: 5px;">ğŸ‘¥ ${tc.patientCount}</span>`
                    : '';

                return `
                <div style="background: var(--bg); padding: 15px; border-radius: 10px; margin-bottom: 10px; cursor: pointer; transition: all 0.2s; border: 2px solid transparent;" 
                     onmouseover="this.style.borderColor='var(--accent)'" 
                     onmouseout="this.style.borderColor='transparent'"
                     onclick="loadTestCase('${tc.id}')">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <strong style="color: var(--accent);">${tc.callCardNo}</strong>
                        <span style="background: ${priorityBg}; color: white; padding: 2px 10px; border-radius: 10px; font-size: 0.75rem; font-weight: 700;">${tc.priority}</span>
                    </div>
                    <div style="font-size: 0.9rem; font-weight: 600; margin-bottom: 4px; color: var(--text);">
                        ${tc.dispatchCode} - ${tc.mpdsDisplayText || tc.mpds}
                    </div>
                    <div style="font-size: 0.85rem; color: var(--muted);">
                        ğŸ‘¤ ${patientInfo} ${patientBadge}
                    </div>
                    <div style="font-size: 0.85rem; color: var(--muted); margin-top: 4px;">
                        ğŸ“ ${tc.locationSummary || tc.location}
                    </div>
                    <div style="font-size: 0.8rem; color: #666; margin-top: 4px; font-style: italic;">
                        ğŸš¨ ${tc.chiefComplaint ? tc.chiefComplaint.substring(0, 50) + '...' : 'N/A'}
                    </div>
                </div>
            `}).join('');

            openModal('testCaseSelectorModal');
        }

        function loadTestCase(caseId) {
            const tc = testCases.find(t => t.id === caseId);
            if (!tc) {
                showToast('error', 'Ralat', 'Test case not found');
                return;
            }

            // Set dispatch timestamps
            const now = new Date();
            tc.dispatchedTime = now.toISOString();
            tc.dispatchedBy = 'DEMO Dispatcher';
            tc.dispatcherAckTime = now.toISOString();
            tc.dispatcherAckBy = 'DEMO Dispatcher';
            tc.resourceCallSign = appState.unitId || 'HTAR1';

            // Set as pending dispatch
            appState.pendingDispatch = { ...tc };
            appState.destination = tc.presetDestination;

            closeModal('testCaseSelectorModal');

            // Show pending dispatch alert
            document.getElementById('pendingDispatchAlert').classList.remove('hidden');
            showToast('info', 'ğŸ“¨ Dispatch Diterima', `${tc.callCardNo} - ${tc.priority} | ${tc.mpdsDisplayText || tc.mpds}`);

            // Play notification sound
            playNotificationSound();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // DISPATCH HANDLING
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function viewPendingDispatch() {
            if (!appState.pendingDispatch) {
                showToast('warning', 'Tiada Dispatch', 'No pending dispatch');
                return;
            }

            // Hide menu, show dispatch alert
            document.getElementById('initialMenu').classList.add('hidden');
            document.getElementById('pendingDispatchAlert').classList.add('hidden');

            // This will be fully implemented in Part 2
            // For now, just show the dispatch alert placeholder
            renderDispatchAlert(appState.pendingDispatch);
            document.getElementById('dispatchAlert').classList.remove('hidden');
        }

        function renderDispatchAlert(dispatch) {
            // Priority badge colors
            const priorityColors = {
                'P1': 'background: linear-gradient(135deg, #dc2626, #ef4444);',
                'P2': 'background: linear-gradient(135deg, #f59e0b, #fbbf24);',
                'P3': 'background: linear-gradient(135deg, #16a34a, #22c55e);',
                'P4': 'background: linear-gradient(135deg, #3b82f6, #60a5fa);'
            };
            const priorityStyle = priorityColors[dispatch.priority] || priorityColors['P2'];
            
            // Format patient info
            const patientInfo = dispatch.patientAge 
                ? `${dispatch.patientName}, ${dispatch.patientAge} ${dispatch.patientGender === 'Male' ? 'â™‚ï¸' : dispatch.patientGender === 'Female' ? 'â™€ï¸' : ''}`
                : dispatch.patientName;
            
            // Patient count badge
            const patientCountBadge = dispatch.patientCount && parseInt(dispatch.patientCount) > 1 
                ? `<span class="badge" style="background: var(--danger); color: white; margin-left: 8px;">ğŸ‘¥ ${dispatch.patientCount} pesakit</span>` 
                : '';

            // Map link button
            const mapButton = dispatch.mapLink 
                ? `<a href="${dispatch.mapLink}" target="_blank" class="btn btn-info btn-sm" style="margin-top: 8px;">ğŸ—ºï¸ Buka Peta / Open Map</a>`
                : (dispatch.latitude && dispatch.longitude 
                    ? `<a href="https://maps.google.com/?q=${dispatch.latitude},${dispatch.longitude}" target="_blank" class="btn btn-info btn-sm" style="margin-top: 8px;">ğŸ—ºï¸ Buka Peta / Open Map</a>`
                    : '');

            document.getElementById('dispatchAlert').innerHTML = `
                <div class="card" style="border: 3px solid var(--danger); animation: pulse-border 1s infinite;">
                    <!-- Header -->
                    <div class="section-title" style="${priorityStyle}">
                        <span>ğŸš¨</span>
                        <span>DISPATCH ALERT - ${dispatch.priority} ${dispatch.patientCount > 1 ? '| MULTI-CASUALTY' : ''}</span>
                    </div>
                    
                    <!-- Case Info -->
                    <div class="info-grid" style="margin-bottom: 15px;">
                        <div class="info-item">
                            <div class="info-label">ğŸ“‹ Call Card No</div>
                            <div class="info-value" style="font-weight: 700; font-size: 1.1rem;">${dispatch.callCardNo}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">ğŸ”¢ MPDS Code</div>
                            <div class="info-value">${dispatch.dispatchCode || dispatch.mpdsCode}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">ğŸ“ MPDS Type</div>
                            <div class="info-value">${dispatch.mpdsDisplayText || dispatch.mpds || 'N/A'}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">ğŸ“ Call Taker</div>
                            <div class="info-value">${dispatch.callTaker || 'N/A'}</div>
                        </div>
                    </div>

                    <!-- Patient Info -->
                    <div style="background: #fef3c7; padding: 12px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid var(--warning);">
                        <div class="info-label">ğŸ‘¤ Pesakit / Patient ${patientCountBadge}</div>
                        <div style="font-size: 1rem; font-weight: 600; margin-bottom: 5px;">${patientInfo}</div>
                        <div style="font-size: 0.9rem; color: #92400e;">
                            ${dispatch.conscious ? `ğŸ‘ï¸ ${dispatch.conscious}` : ''} 
                            ${dispatch.breathing ? `| ğŸ’¨ ${dispatch.breathing}` : ''}
                        </div>
                    </div>

                    <!-- Chief Complaint -->
                    <div style="background: #fee2e2; padding: 12px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid var(--danger);">
                        <div class="info-label">ğŸš¨ Aduan Utama / Chief Complaint</div>
                        <div style="font-size: 1rem; font-weight: 600;">${dispatch.chiefComplaint || dispatch.condition || 'N/A'}</div>
                    </div>

                    <!-- Location -->
                    <div style="background: var(--bg); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                        <div class="info-label">ğŸ“ Lokasi / Location</div>
                        <div style="font-size: 1rem; font-weight: 600; margin-bottom: 5px;">${dispatch.location || dispatch.locationSummary}</div>
                        <div style="font-size: 0.9rem; color: var(--muted);">${dispatch.locationDetails || ''}</div>
                        ${dispatch.landmark ? `<div style="font-size: 0.85rem; color: var(--info); margin-top: 5px;">ğŸ·ï¸ ${dispatch.landmark}</div>` : ''}
                        ${dispatch.buildingType ? `<div style="font-size: 0.85rem; color: var(--muted);">ğŸ¢ ${dispatch.buildingType} ${dispatch.floor ? '| ğŸ”¢ ' + dispatch.floor : ''} ${dispatch.lift === 'Rosak' ? '| âš ï¸ Lif Rosak' : ''}</div>` : ''}
                        ${mapButton}
                    </div>

                    <!-- Caller Info -->
                    <div style="background: #e0f2fe; padding: 12px; border-radius: 10px; margin-bottom: 15px;">
                        <div class="info-label">ğŸ“ Pemanggil / Caller</div>
                        <div style="font-size: 0.95rem;">
                            <strong>${dispatch.callerName || 'N/A'}</strong> ${dispatch.callerRelation ? `(${dispatch.callerRelation})` : ''}
                        </div>
                        <div style="font-size: 0.9rem; color: var(--accent);">
                            ğŸ“± ${dispatch.callerPhone || 'N/A'}
                            ${dispatch.callerPhone ? `<a href="tel:${dispatch.callerPhone}" class="btn btn-outline btn-sm" style="margin-left: 10px; padding: 2px 8px;">ğŸ“ Call</a>` : ''}
                        </div>
                    </div>

                    <!-- Medical History (if available) -->
                    ${dispatch.medHistory || dispatch.allergies ? `
                    <div style="background: #fdf4ff; padding: 12px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid #a855f7;">
                        <div class="info-label">ğŸ’Š Maklumat Perubatan / Medical Info</div>
                        ${dispatch.medHistory ? `<div style="font-size: 0.9rem;">ğŸ“‹ ${dispatch.medHistory}</div>` : ''}
                        ${dispatch.allergies && dispatch.allergies !== 'Tiada' ? `<div style="font-size: 0.9rem; color: var(--danger);">âš ï¸ Allergies: ${dispatch.allergies}</div>` : ''}
                    </div>
                    ` : ''}

                    <!-- PAI (if given) -->
                    ${dispatch.paiGiven && dispatch.preArrivalInstructions ? `
                    <div style="background: #ecfdf5; padding: 12px; border-radius: 10px; margin-bottom: 15px; border-left: 4px solid var(--success);">
                        <div class="info-label">ğŸ“‹ PAI Diberikan / Pre-Arrival Instructions</div>
                        <div style="font-size: 0.9rem;">${dispatch.preArrivalInstructions}</div>
                    </div>
                    ` : ''}

                    <!-- Preset Destination -->
                    <div style="background: #ecfdf5; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 2px solid var(--success);">
                        <div class="info-label">ğŸ¥ Destinasi Ditetapkan / Preset Destination</div>
                        <div style="font-size: 1.1rem; font-weight: 700; color: var(--success);">${dispatch.presetDestination || 'Belum ditetapkan'}</div>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-success btn-lg btn-block" onclick="acknowledgeDispatch()" style="font-size: 1.1rem; padding: 15px;">
                            ğŸ“± TERIMA / ACKNOWLEDGE
                        </button>
                    </div>
                    
                    <div style="text-align: center; margin-top: 15px;">
                        <button class="btn btn-outline" onclick="rejectDispatch()">
                            âŒ Tolak Dispatch / Reject
                        </button>
                    </div>

                    <!-- Received Time -->
                    <div style="text-align: center; margin-top: 15px; font-size: 0.8rem; color: var(--muted);">
                        â±ï¸ Diterima: ${dispatch.receivedTime || 'N/A'}
                    </div>
                </div>
                
                <style>
                    @keyframes pulse-border {
                        0%, 100% { border-color: var(--danger); }
                        50% { border-color: #fca5a5; }
                    }
                </style>
            `;
        }

        async function acknowledgeDispatch() {
            if (!appState.pendingDispatch) return;

            // In live mode, accept dispatch with backend first
            if (appState.mode === 'live' && appState.pendingDispatch.dispatchId) {
                showToast('info', 'ğŸ”„ Processing...', 'Accepting dispatch...');
                
                const result = await acceptDispatchBackend(appState.pendingDispatch.dispatchId);
                if (!result.success) {
                    showToast('error', 'âŒ Error', result.error || 'Failed to accept dispatch');
                    return;
                }
            }

            // Set current case
            appState.currentCase = { ...appState.pendingDispatch };
            appState.pendingDispatch = null;
            appState.missionStartTime = new Date().toISOString();
            appState.destination = appState.currentCase.presetDestination || '';

            // Mark Acknowledge phase as complete
            const now = new Date();
            appState.phases[0].completed = true;
            appState.phases[0].time = now.toLocaleString('en-MY', {
                year: 'numeric', month: 'short', day: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
            });
            appState.phases[0].duration = 0;

            // Get GPS if enabled
            if (appState.settings.autoGPS === 'on') {
                captureGPS(0);
            }

            // Update status
            document.getElementById('statusIndicator').textContent = 'ACTIVE';
            document.getElementById('statusIndicator').className = 'status-indicator status-active';

            // Add auto note
            addAutoNote(`ACKNOWLEDGE: Dispatch diterima - ${appState.currentCase.callCardNo}`);

            // Hide dispatch alert, show active mission
            document.getElementById('dispatchAlert').classList.add('hidden');

            // Render the active mission screen
            renderActiveMission();
            document.getElementById('activeMission').classList.remove('hidden');
            
            // Hide the active case badge if showing
            hideActiveCaseBadge();

            // Start timers
            startMissionTimer();
            startOngoingPhaseTimer();

            // Send acknowledgement to backend (phase update)
            sendPhaseUpdateToBackend(0);

            showToast('success', 'âœ… Dispatch Diterima', 'Mission started - proceed to vehicle');
        }

        function renderActiveMission() {
            // Render case summary
            const caseData = appState.currentCase;
            
            // Priority colors
            const priorityBg = caseData.priority === 'P1' ? 'var(--danger)' : 
                               caseData.priority === 'P2' ? 'var(--warning)' : 
                               caseData.priority === 'P3' ? 'var(--success)' : 'var(--info)';
            
            // Patient info
            const patientInfo = caseData.patientAge 
                ? `${caseData.patientName || 'Unknown'}, ${caseData.patientAge} ${caseData.patientGender === 'Male' ? 'â™‚ï¸' : caseData.patientGender === 'Female' ? 'â™€ï¸' : ''}`
                : (caseData.patientName || 'Unknown');
            
            // Patient count badge
            const patientCountBadge = caseData.patientCount && parseInt(caseData.patientCount) > 1 
                ? `<span style="background: var(--danger); color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; margin-left: 8px;">ğŸ‘¥ ${caseData.patientCount}</span>` 
                : '';

            // Map link
            const mapButton = caseData.mapLink 
                ? `<a href="${caseData.mapLink}" target="_blank" class="btn btn-info btn-sm" style="margin-top: 8px; font-size: 0.75rem;">ğŸ—ºï¸ Peta</a>`
                : (caseData.latitude && caseData.longitude 
                    ? `<a href="https://maps.google.com/?q=${caseData.latitude},${caseData.longitude}" target="_blank" class="btn btn-info btn-sm" style="margin-top: 8px; font-size: 0.75rem;">ğŸ—ºï¸ Peta</a>`
                    : '');

            // Call caller button
            const callButton = caseData.callerPhone 
                ? `<a href="tel:${caseData.callerPhone}" class="btn btn-success btn-sm" style="font-size: 0.75rem;">ğŸ“ ${caseData.callerPhone}</a>`
                : '';

            document.getElementById('activeCaseSummary').innerHTML = `
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">ğŸ“‹ Call Card</div>
                        <div class="info-value" style="color: var(--accent); font-weight: 700; font-size: 1rem;">${caseData.callCardNo || 'N/A'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ğŸ”´ Priority</div>
                        <div class="info-value">
                            <span style="background: ${priorityBg}; color: white; padding: 2px 12px; border-radius: 10px; font-size: 0.9rem; font-weight: 700;">${caseData.priority || 'N/A'}</span>
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ğŸ”¢ MPDS</div>
                        <div class="info-value">${caseData.dispatchCode || caseData.mpdsCode || 'N/A'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ğŸ“ Type</div>
                        <div class="info-value" style="font-size: 0.85rem;">${caseData.mpdsDisplayText || caseData.mpds || 'N/A'}</div>
                    </div>
                </div>

                <!-- Patient Info -->
                <div style="background: #fef3c7; padding: 12px; border-radius: 8px; margin-top: 12px; border-left: 4px solid var(--warning);">
                    <div class="info-label">ğŸ‘¤ Pesakit / Patient ${patientCountBadge}</div>
                    <div style="font-weight: 600;">${patientInfo}</div>
                    ${caseData.conscious || caseData.breathing ? `
                    <div style="font-size: 0.85rem; color: #92400e; margin-top: 4px;">
                        ${caseData.conscious ? `ğŸ‘ï¸ ${caseData.conscious}` : ''} 
                        ${caseData.breathing ? `| ğŸ’¨ ${caseData.breathing}` : ''}
                    </div>
                    ` : ''}
                </div>

                <!-- Chief Complaint -->
                <div style="background: #fee2e2; padding: 12px; border-radius: 8px; margin-top: 10px; border-left: 4px solid var(--danger);">
                    <div class="info-label">ğŸš¨ Aduan / Complaint</div>
                    <div style="font-weight: 600;">${caseData.chiefComplaint || caseData.condition || 'N/A'}</div>
                </div>

                <!-- Location -->
                <div style="background: var(--bg); padding: 12px; border-radius: 8px; margin-top: 10px;">
                    <div class="info-label">ğŸ“ Lokasi / Location</div>
                    <div style="font-weight: 600;">${caseData.location || caseData.locationSummary || 'N/A'}</div>
                    <div style="font-size: 0.85rem; color: var(--muted);">${caseData.locationDetails || ''}</div>
                    ${caseData.landmark ? `<div style="font-size: 0.85rem; color: var(--info);">ğŸ·ï¸ ${caseData.landmark}</div>` : ''}
                    ${caseData.buildingType ? `<div style="font-size: 0.8rem; color: var(--muted);">ğŸ¢ ${caseData.buildingType} ${caseData.floor ? '| ğŸ”¢ ' + caseData.floor : ''}</div>` : ''}
                    ${mapButton}
                </div>

                <!-- Caller Info -->
                ${caseData.callerName ? `
                <div style="background: #e0f2fe; padding: 10px; border-radius: 8px; margin-top: 10px;">
                    <div class="info-label">ğŸ“ Pemanggil / Caller</div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <span style="font-weight: 600;">${caseData.callerName}</span>
                            ${caseData.callerRelation ? `<span style="font-size: 0.85rem; color: var(--muted);"> (${caseData.callerRelation})</span>` : ''}
                        </div>
                        ${callButton}
                    </div>
                </div>
                ` : ''}

                <!-- Medical History (if critical) -->
                ${caseData.medHistory && caseData.medHistory !== 'Tiada' ? `
                <div style="background: #fdf4ff; padding: 10px; border-radius: 8px; margin-top: 10px; border-left: 4px solid #a855f7;">
                    <div class="info-label">ğŸ’Š Sejarah Perubatan</div>
                    <div style="font-size: 0.9rem;">${caseData.medHistory}</div>
                    ${caseData.allergies && caseData.allergies !== 'Tiada' ? `<div style="font-size: 0.85rem; color: var(--danger);">âš ï¸ Allergies: ${caseData.allergies}</div>` : ''}
                </div>
                ` : ''}
            `;

            // Update destination display
            document.getElementById('currentDestination').textContent = appState.destination || 'Not set';

            // Render phase tracker
            renderPhaseTracker();
        }

        async function rejectDispatch() {
            if (!confirm('Adakah anda pasti untuk menolak dispatch ini?\nAre you sure you want to reject this dispatch?')) {
                return;
            }

            const reason = prompt('Sebab penolakan / Rejection reason:');
            if (!reason) {
                showToast('warning', 'Sebab Diperlukan', 'Please provide a rejection reason');
                return;
            }

            // Log rejection
            addAutoNote(`REJECT: Dispatch ditolak - ${appState.pendingDispatch?.callCardNo} - Sebab: ${reason}`);

            // Send rejection to backend (Live Mode)
            if (appState.mode === 'live' && appState.pendingDispatch?.dispatchId) {
                const result = await rejectDispatchBackend(appState.pendingDispatch.dispatchId, reason);
                if (!result.success) {
                    showToast('warning', 'âš ï¸ Warning', 'Rejection saved locally but backend sync failed');
                }
            }

            // Clear pending dispatch
            appState.pendingDispatch = null;

            // Hide dispatch alert, show menu
            document.getElementById('dispatchAlert').classList.add('hidden');
            document.getElementById('initialMenu').classList.remove('hidden');

            showToast('info', 'Dispatch Ditolak', 'Rejection sent to Dispatcher');
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // OVERRIDE SYSTEM (6-STEP WORKFLOW) - PART 3
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        let overrideWorkflow = {
            currentPhaseAtOverride: null,
            reason: null,
            destinationPhaseIndex: null,
            skippedPhases: []
        };

        function openOverrideModal() {
            // Reset workflow state
            overrideWorkflow = {
                currentPhaseAtOverride: null,
                reason: null,
                destinationPhaseIndex: null,
                skippedPhases: []
            };

            // Get current phase
            const currentIndex = getNextPhaseIndex();
            if (currentIndex < 0) {
                showToast('info', 'Mission Complete', 'No phases to override');
                return;
            }

            const currentPhase = appState.phases[currentIndex];
            overrideWorkflow.currentPhaseAtOverride = currentPhase.name;

            // Update display
            document.getElementById('overrideCurrentPhase').textContent = 
                `${currentPhase.icon} ${currentPhase.name}`;

            // Clear previous selections
            document.querySelectorAll('input[name="overrideReason"]').forEach(r => r.checked = false);
            document.getElementById('overrideOtherReasonField').classList.add('hidden');
            document.getElementById('overrideOtherReasonInput').value = '';

            openModal('overrideStep1Modal');
        }

        function closeOverrideWorkflow() {
            closeModal('overrideStep1Modal');
            closeModal('overrideStep2Modal');
            closeModal('overrideStep3Modal');
            closeModal('overrideStep4Modal');
            overrideWorkflow = {
                currentPhaseAtOverride: null,
                reason: null,
                destinationPhaseIndex: null,
                skippedPhases: []
            };
        }

        function overrideGoBack(toStep) {
            closeModal(`overrideStep${toStep + 1}Modal`);
            openModal(`overrideStep${toStep}Modal`);
        }

        // Step 2: Reason selection
        function overrideStep2() {
            closeModal('overrideStep1Modal');
            openModal('overrideStep2Modal');
        }

        function selectOverrideReason(reason) {
            if (reason === 'Other') {
                document.getElementById('overrideOtherReasonField').classList.remove('hidden');
            } else {
                document.getElementById('overrideOtherReasonField').classList.add('hidden');
            }
        }

        // Step 3: Destination phase selection
        function overrideStep3() {
            // Get selected reason
            const selectedReason = document.querySelector('input[name="overrideReason"]:checked');
            if (!selectedReason) {
                showToast('warning', 'Required', 'Please select a reason');
                return;
            }

            let reason = selectedReason.value;
            if (reason === 'Other') {
                reason = document.getElementById('overrideOtherReasonInput').value.trim();
                if (!reason) {
                    showToast('warning', 'Required', 'Please specify the reason');
                    return;
                }
            }

            overrideWorkflow.reason = reason;

            // Populate destination phases dropdown
            const currentIndex = getNextPhaseIndex();
            const select = document.getElementById('overrideDestinationPhase');
            select.innerHTML = '';

            // Add remaining phases including current
            for (let i = currentIndex; i < appState.phases.length; i++) {
                const phase = appState.phases[i];
                const option = document.createElement('option');
                option.value = i;
                option.textContent = `${phase.icon} ${phase.name}`;
                select.appendChild(option);
            }

            // Also add "End Mission" option (jumps to Clear)
            const endOption = document.createElement('option');
            endOption.value = appState.phases.length - 1;
            endOption.textContent = 'âœ… End Mission (Clear)';
            if (currentIndex < appState.phases.length - 1) {
                select.appendChild(endOption);
            }

            closeModal('overrideStep2Modal');
            openModal('overrideStep3Modal');

            // Initial update of skipped phases
            updateSkippedPhasesList();
        }

        function updateSkippedPhasesList() {
            const currentIndex = getNextPhaseIndex();
            const destIndex = parseInt(document.getElementById('overrideDestinationPhase').value);

            if (destIndex <= currentIndex) {
                document.getElementById('skippedPhasesPreview').classList.add('hidden');
                overrideWorkflow.skippedPhases = [];
                return;
            }

            // Build list of skipped phases
            const skipped = [];
            for (let i = currentIndex; i < destIndex; i++) {
                skipped.push(appState.phases[i]);
            }

            overrideWorkflow.skippedPhases = skipped;
            overrideWorkflow.destinationPhaseIndex = destIndex;

            if (skipped.length > 0) {
                document.getElementById('skippedPhasesPreview').classList.remove('hidden');
                document.getElementById('skippedPhasesList').innerHTML = skipped.map(p => 
                    `<div style="padding: 4px 0;">â€¢ ${p.icon} ${p.name}</div>`
                ).join('');
            } else {
                document.getElementById('skippedPhasesPreview').classList.add('hidden');
            }
        }

        // Step 4: Preview and confirm
        function overrideStep4() {
            const destIndex = parseInt(document.getElementById('overrideDestinationPhase').value);
            const currentIndex = getNextPhaseIndex();

            if (destIndex <= currentIndex && destIndex !== currentIndex) {
                showToast('warning', 'Invalid', 'Please select a valid destination phase');
                return;
            }

            overrideWorkflow.destinationPhaseIndex = destIndex;

            // Update preview
            document.getElementById('previewOverrideReason').textContent = overrideWorkflow.reason;
            document.getElementById('previewDestinationPhase').textContent = 
                `${appState.phases[destIndex].icon} ${appState.phases[destIndex].name}`;

            // Update final skipped phases list
            document.getElementById('finalSkippedPhasesList').innerHTML = 
                overrideWorkflow.skippedPhases.length > 0 
                    ? overrideWorkflow.skippedPhases.map(p => 
                        `<div style="padding: 4px 0;">â€¢ ${p.icon} ${p.name}</div>`
                      ).join('')
                    : '<em>No phases will be skipped (direct completion)</em>';

            closeModal('overrideStep3Modal');
            openModal('overrideStep4Modal');
        }

        // Execute Override
        function executeOverride() {
            const currentIndex = getNextPhaseIndex();
            const destIndex = overrideWorkflow.destinationPhaseIndex;
            const now = new Date();
            const timeStr = now.toLocaleString('en-MY', {
                year: 'numeric', month: 'short', day: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
            });

            // Mark skipped phases as overridden
            for (let i = currentIndex; i < destIndex; i++) {
                appState.phases[i].completed = true;
                appState.phases[i].time = timeStr + ' (OVERRIDE)';
                appState.phases[i].duration = 0;
                appState.phases[i].overridden = true;
            }

            // Mark destination phase as complete
            appState.phases[destIndex].completed = true;
            appState.phases[destIndex].time = timeStr;
            appState.phases[destIndex].duration = 0;

            // Update app state
            appState.overrideUsed = true;
            appState.overrideReason = overrideWorkflow.reason;
            appState.skippedPhases = overrideWorkflow.skippedPhases.map(p => p.name);

            // Auto GPS capture
            if (appState.settings.autoGPS === 'on') {
                captureGPS(destIndex);
            }

            // Add auto note
            const skippedNames = overrideWorkflow.skippedPhases.map(p => p.name).join(', ');
            addAutoNote(`OVERRIDE: Reason: ${overrideWorkflow.reason}`);
            if (skippedNames) {
                addAutoNote(`OVERRIDE: Skipped phases: ${skippedNames}`);
            }
            addAutoNote(`OVERRIDE: Jumped to ${appState.phases[destIndex].name}`);

            closeOverrideWorkflow();

            // Render updated tracker
            renderPhaseTracker();
            startOngoingPhaseTimer();

            showToast('warning', 'âš¡ Override Executed', `Jumped to ${appState.phases[destIndex].name}`);

            // Check if mission complete
            if (destIndex === appState.phases.length - 1) {
                completeMission();
            }

            // Send to backend
            sendOverrideToBackend();
        }

        function sendOverrideToBackend() {
            // TODO: Send override info to backend
            console.log('ğŸ“¡ Sending override to backend:', {
                reason: appState.overrideReason,
                skippedPhases: appState.skippedPhases
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PERFORMANCE REVIEW
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function viewPerformanceReview() {
            const lastCase = appState.completedCases[appState.completedCases.length - 1];
            if (!lastCase) {
                showToast('info', 'No Data', 'No completed cases to review');
                return;
            }

            renderPerformanceReview(lastCase);
            openModal('performanceReviewModal');
        }

        function renderPerformanceReview(caseData) {
            const phases = caseData.phases || appState.phases;
            let totalOnTarget = 0;
            let totalPhases = 0;

            const phaseRows = phases.map((phase, idx) => {
                if (!phase.completed) return '';
                totalPhases++;

                const isOnTarget = phase.duration !== null && phase.duration <= phase.target;
                if (isOnTarget) totalOnTarget++;

                const statusClass = phase.overridden ? 'background: #fee2e2;' : 
                                   (isOnTarget ? 'background: #ecfdf5;' : 'background: #fef3c7;');
                const statusIcon = phase.overridden ? 'âš¡' : (isOnTarget ? 'âœ…' : 'â°');

                const durationStr = phase.duration !== null 
                    ? (phase.duration >= 60 ? `${Math.floor(phase.duration/60)}m ${phase.duration%60}s` : `${phase.duration}s`)
                    : '-';

                return `
                    <tr style="${statusClass}">
                        <td style="padding: 10px; border-bottom: 1px solid var(--border);">${phase.icon} ${phase.name}</td>
                        <td style="padding: 10px; border-bottom: 1px solid var(--border); text-align: center;">${formatTarget(phase.target)}</td>
                        <td style="padding: 10px; border-bottom: 1px solid var(--border); text-align: center;">${durationStr}</td>
                        <td style="padding: 10px; border-bottom: 1px solid var(--border); text-align: center;">${statusIcon}</td>
                    </tr>
                `;
            }).join('');

            const score = totalPhases > 0 ? Math.round((totalOnTarget / totalPhases) * 100) : 0;
            const scoreColor = score >= 80 ? 'var(--success)' : score >= 60 ? 'var(--warning)' : 'var(--danger)';

            document.getElementById('performanceReviewContent').innerHTML = `
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 48px; font-weight: 700; color: ${scoreColor};">${score}%</div>
                    <div style="color: var(--muted);">Performance Score</div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div style="background: var(--bg); padding: 12px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700;">${caseData.totalTime || '-'}</div>
                        <div style="font-size: 0.8rem; color: var(--muted);">Total Time</div>
                    </div>
                    <div style="background: var(--bg); padding: 12px; border-radius: 8px; text-align: center;">
                        <div style="font-size: 1.5rem; font-weight: 700;">${totalOnTarget}/${totalPhases}</div>
                        <div style="font-size: 0.8rem; color: var(--muted);">Phases On Target</div>
                    </div>
                </div>

                ${caseData.overrideUsed ? `
                    <div style="background: #fee2e2; padding: 12px; border-radius: 8px; margin-bottom: 15px;">
                        <strong>âš¡ Override Used:</strong> ${caseData.overrideReason || 'N/A'}
                    </div>
                ` : ''}

                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: var(--accent); color: white;">
                            <th style="padding: 10px; text-align: left;">Phase</th>
                            <th style="padding: 10px; text-align: center;">Target</th>
                            <th style="padding: 10px; text-align: center;">Actual</th>
                            <th style="padding: 10px; text-align: center;">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${phaseRows}
                    </tbody>
                </table>
            `;
        }

        function exportPerformanceReport() {
            const lastCase = appState.completedCases[appState.completedCases.length - 1];
            if (!lastCase) return;

            let report = '=== MECCHTAR PERFORMANCE REPORT ===\n\n';
            report += `Case: ${lastCase.callCardNo}\n`;
            report += `Unit: ${appState.unitId}\n`;
            report += `Crew: ${appState.crewName}\n`;
            report += `Date: ${lastCase.completedAt}\n`;
            report += `Total Time: ${lastCase.totalTime}\n\n`;

            report += '--- PHASE PERFORMANCE ---\n';
            (lastCase.phases || []).forEach((phase, idx) => {
                if (phase.completed) {
                    const duration = phase.duration !== null ? `${phase.duration}s` : '-';
                    const status = phase.overridden ? 'OVERRIDE' : (phase.duration <= phase.target ? 'ON TARGET' : 'OVER');
                    report += `${idx + 1}. ${phase.name}: ${duration} (Target: ${phase.target}s) - ${status}\n`;
                }
            });

            if (lastCase.overrideUsed) {
                report += `\n--- OVERRIDE INFO ---\nReason: ${lastCase.overrideReason}\n`;
            }

            navigator.clipboard.writeText(report).then(() => {
                showToast('success', 'ğŸ“‹ Copied', 'Report copied to clipboard');
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // DESTINATION HANDLING
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function openDestinationModal() {
            document.getElementById('modalCurrentDestination').textContent = appState.destination || 'Not set';
            document.getElementById('changeDestinationFields').classList.add('hidden');
            document.querySelector('input[name="destOption"][value="follow"]').checked = true;
            openModal('destinationModal');
        }

        function selectDestinationOption(option) {
            if (option === 'change') {
                document.getElementById('changeDestinationFields').classList.remove('hidden');
            } else {
                document.getElementById('changeDestinationFields').classList.add('hidden');
            }
        }

        // Event listeners for "Other" options in destination modal
        document.getElementById('newDestinationSelect').addEventListener('change', function() {
            const otherGroup = document.getElementById('otherDestinationGroup');
            if (this.value === 'Other') {
                otherGroup.style.display = 'block';
                document.getElementById('otherDestinationInput').focus();
            } else {
                otherGroup.style.display = 'none';
                document.getElementById('otherDestinationInput').value = '';
            }
        });

        document.getElementById('destChangeReason').addEventListener('change', function() {
            const otherGroup = document.getElementById('otherReasonGroup');
            if (this.value === 'Other') {
                otherGroup.style.display = 'block';
                document.getElementById('otherReasonInput').focus();
            } else {
                otherGroup.style.display = 'none';
                document.getElementById('otherReasonInput').value = '';
            }
        });

        function confirmDestination() {
            const option = document.querySelector('input[name="destOption"]:checked')?.value;

            if (option === 'follow') {
                // Follow preset destination
                appState.destinationConfirmed = true;
                closeModal('destinationModal');
                updateDestinationDisplay();
                addAutoNote(`DESTINATION CONFIRMED: ${appState.destination} (preset)`);
                showToast('success', 'âœ… Destination Confirmed', appState.destination);
            } else {
                // Change destination
                let newDest = document.getElementById('newDestinationSelect').value;
                if (newDest === 'Other') {
                    newDest = document.getElementById('otherDestinationInput').value.trim();
                }

                let reason = document.getElementById('destChangeReason').value;
                if (reason === 'Other') {
                    reason = document.getElementById('otherReasonInput').value.trim();
                }

                if (!newDest) {
                    showToast('warning', 'Required', 'Please select a destination');
                    return;
                }

                if (!reason) {
                    showToast('warning', 'Required', 'Please provide a reason for change');
                    return;
                }

                const oldDest = appState.destination;
                appState.destination = newDest;
                appState.destinationConfirmed = true;
                appState.destinationChangeReason = reason;

                closeModal('destinationModal');
                updateDestinationDisplay();
                addAutoNote(`DESTINATION CHANGED: ${oldDest} â†’ ${newDest} (Reason: ${reason})`);
                showToast('success', 'âœ… Destination Changed', newDest);

                // Send to backend
                sendDestinationChangeToBackend(oldDest, newDest, reason);
            }

            // Re-render phase tracker (Transporting button might now be enabled)
            renderPhaseTracker();
        }

        function updateDestinationDisplay() {
            const destEl = document.getElementById('currentDestination');
            const statusEl = document.getElementById('destinationStatus');

            if (destEl) destEl.textContent = appState.destination || 'Not set';
            if (statusEl) {
                if (appState.destinationConfirmed) {
                    statusEl.innerHTML = 'âœ… Confirmed';
                    statusEl.style.color = 'var(--success)';
                } else {
                    statusEl.innerHTML = 'â³ Pending confirmation before transport';
                    statusEl.style.color = 'var(--muted)';
                }
            }
        }

        function sendDestinationChangeToBackend(oldDest, newDest, reason) {
            // TODO: Send destination change to backend
            console.log('ğŸ“¡ Sending destination change to backend:', { oldDest, newDest, reason });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // NOTES HANDLING
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        function openNotesModal() {
            // Populate auto notes
            const autoNotesEl = document.getElementById('autoNotesDisplay');
            if (autoNotesEl) {
                if (appState.autoNotes.length > 0) {
                    autoNotesEl.innerHTML = appState.autoNotes.map(note => 
                        `<div style="padding: 4px 0; border-bottom: 1px solid var(--border);">${note}</div>`
                    ).join('');
                } else {
                    autoNotesEl.innerHTML = '<em style="color: var(--muted);">No auto notes yet</em>';
                }
            }

            // Populate free text
            const freeTextEl = document.getElementById('freeTextNotes');
            if (freeTextEl) {
                freeTextEl.value = appState.freeTextNotes || '';
            }

            openModal('notesModal');
        }

        function viewCurrentNotes() {
            openNotesModal();
        }

        function saveNotes() {
            const freeTextEl = document.getElementById('freeTextNotes');
            if (freeTextEl) {
                appState.freeTextNotes = freeTextEl.value.trim();
            }
            closeModal('notesModal');
            showToast('success', 'ğŸ’¾ Saved', 'Notes saved successfully');
        }

        function copyNotesToClipboard() {
            let allNotes = '=== MECCHTAR MISSION NOTES ===\n\n';
            allNotes += `Case: ${appState.currentCase?.callCardNo || 'N/A'}\n`;
            allNotes += `Unit: ${appState.unitId}\n`;
            allNotes += `Crew: ${appState.crewName}\n`;
            allNotes += `Date: ${new Date().toLocaleString('en-MY')}\n\n`;
            
            allNotes += '--- AUTO NOTES ---\n';
            allNotes += appState.autoNotes.join('\n') || 'None';
            allNotes += '\n\n--- FREE TEXT NOTES ---\n';
            allNotes += document.getElementById('freeTextNotes')?.value || appState.freeTextNotes || 'None';

            navigator.clipboard.writeText(allNotes).then(() => {
                showToast('success', 'ğŸ“‹ Copied', 'Notes copied to clipboard');
            }).catch(err => {
                showToast('error', 'Error', 'Failed to copy to clipboard');
            });
        }

        function downloadNotes() {
            let allNotes = '=== MECCHTAR MISSION NOTES ===\n\n';
            allNotes += `Case: ${appState.currentCase?.callCardNo || 'N/A'}\n`;
            allNotes += `Unit: ${appState.unitId}\n`;
            allNotes += `Crew: ${appState.crewName}\n`;
            allNotes += `Date: ${new Date().toLocaleString('en-MY')}\n\n`;
            
            allNotes += '--- AUTO NOTES ---\n';
            allNotes += appState.autoNotes.join('\n') || 'None';
            allNotes += '\n\n--- FREE TEXT NOTES ---\n';
            allNotes += document.getElementById('freeTextNotes')?.value || appState.freeTextNotes || 'None';

            const blob = new Blob([allNotes], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mission_notes_${appState.currentCase?.callCardNo || 'unknown'}_${Date.now()}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showToast('success', 'ğŸ’¾ Downloaded', 'Notes file downloaded');
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // TIMERS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function startMissionTimer() {
            if (missionTimerInterval) clearInterval(missionTimerInterval);

            const startTime = new Date(appState.missionStartTime);

            missionTimerInterval = setInterval(() => {
                const now = new Date();
                const diff = now - startTime;
                const hours = Math.floor(diff / 3600000);
                const minutes = Math.floor((diff % 3600000) / 60000);
                const seconds = Math.floor((diff % 60000) / 1000);

                const timerEl = document.getElementById('missionTimer');
                if (timerEl) {
                    timerEl.textContent = 
                        String(hours).padStart(2, '0') + ':' +
                        String(minutes).padStart(2, '0') + ':' +
                        String(seconds).padStart(2, '0');
                }
            }, 1000);
        }

        function startWaitingTimer() {
            waitingStartTime = new Date();

            if (waitingTimerInterval) clearInterval(waitingTimerInterval);

            waitingTimerInterval = setInterval(() => {
                const now = new Date();
                const diff = now - waitingStartTime;
                const hours = Math.floor(diff / 3600000);
                const minutes = Math.floor((diff % 3600000) / 60000);
                const seconds = Math.floor((diff % 60000) / 1000);

                const timerEl = document.getElementById('waitingTimer');
                if (timerEl) {
                    timerEl.textContent = 
                        String(hours).padStart(2, '0') + ':' +
                        String(minutes).padStart(2, '0') + ':' +
                        String(seconds).padStart(2, '0');
                }
            }, 1000);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // GPS FUNCTIONS (PART 4 - ENHANCED)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CONTACT NUMBERS - Master Directory Reference
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const CONTACT_NUMBERS = {
            // MECC Dispatchers
            dispatcher: '601162621386',      // MECC Dispatcher 1
            dispatcherAlt: '601162621390',   // MECC Dispatcher 2
            meccDirectLine: '60333717989',   // MECC Direct Line
            // Supervisors
            supervisorPHCAS: '60109219391',  // Supervisor PHCAS
            supervisorED: '60109209391',     // Supervisor ED
            ep: '60162619393',               // Emergency Physician
            sisterED: '60163599391',         // Sister ED
            // Hospital HTAR
            cpert: '60109229391',            // CPERT Team
            telephonist: '60333757000',      // HTAR Telephonist
            // JKT Doctors
            drTajuddin: '60163119391',       // Dr Ahmad Tajuddin
            drKhairizam: '60129509147',      // Dr Mohd Khairizam
            drRafidah: '60137410929'         // Dr Rafidah
        };
        
        // Quick contact list for dropdown - frequently used contacts
        const QUICK_CONTACTS = [
            // MECC Dispatchers
            { id: 'MECC1', name: 'MECC Dispatcher 1', icon: 'ğŸ“¡', phone: '601162621386', category: 'MECC' },
            { id: 'MECC2', name: 'MECC Dispatcher 2', icon: 'ğŸ“¡', phone: '601162621390', category: 'MECC' },
            { id: 'MECC3', name: 'MECC Dispatcher 3', icon: 'ğŸ“¡', phone: '601162621423', category: 'MECC' },
            { id: 'MECCDL', name: 'MECC Direct Line', icon: 'ğŸ“', phone: '60333717989', category: 'MECC' },
            // Supervisors
            { id: 'SuperPHCAS', name: 'Supervisor PHCAS', icon: 'ğŸ‘”', phone: '60109219391', category: 'Supervisor' },
            { id: 'SuperED', name: 'Supervisor ED', icon: 'ğŸ‘”', phone: '60109209391', category: 'Supervisor' },
            { id: 'EP', name: 'Emergency Physician', icon: 'ğŸ‘¨â€âš•ï¸', phone: '60162619393', category: 'Supervisor' },
            { id: 'SisED', name: 'Sister ED', icon: 'ğŸ‘©â€âš•ï¸', phone: '60163599391', category: 'Supervisor' },
            // Hospital HTAR Key
            { id: 'CPERT', name: 'CPERT Team', icon: 'â­', phone: '60109229391', category: 'Hospital HTAR' },
            { id: 'Telephonist', name: 'HTAR Telephonist', icon: 'â˜ï¸', phone: '60333757000', category: 'Hospital HTAR' },
            // JKT Doctors
            { id: 'DRAT', name: 'Dr Ahmad Tajuddin', icon: 'ğŸ‘¨â€âš•ï¸', phone: '60163119391', category: 'JKT' },
            { id: 'DRK', name: 'Dr Mohd Khairizam', icon: 'ğŸ‘¨â€âš•ï¸', phone: '60129509147', category: 'JKT' }
        ];

        function captureGPS(phaseIndex) {
            if (!navigator.geolocation) {
                console.warn('Geolocation not supported');
                addAutoNote(`GPS: Not available for phase ${phaseIndex}`);
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const coords = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        timestamp: new Date().toISOString()
                    };

                    if (phaseIndex !== null && phaseIndex < appState.phases.length) {
                        appState.phases[phaseIndex].gps = coords;
                        const phaseName = appState.phases[phaseIndex].name;
                        addAutoNote(`GPS [${phaseName}]: ${coords.lat.toFixed(6)}, ${coords.lng.toFixed(6)} (Â±${Math.round(coords.accuracy)}m)`);
                    }
                    appState.currentGPS = coords;

                    // Send auto-ping to backend
                    sendLocationPingToBackend(coords, phaseIndex);

                    console.log(`ğŸ“ GPS captured for phase ${phaseIndex}:`, coords);
                },
                (error) => {
                    console.error('GPS error:', error);
                    addAutoNote(`GPS ERROR: ${error.message}`);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 0
                }
            );
        }

        function manualPingLocation() {
            closeMessagingMenu();

            if (!navigator.geolocation) {
                showToast('error', 'GPS Tidak Disokong', 'Your device does not support GPS');
                return;
            }

            showToast('info', 'ğŸ“ Mendapatkan Lokasi...', 'Getting your location...');

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const coords = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy,
                        timestamp: new Date().toISOString()
                    };

                    appState.currentGPS = coords;

                    // Send to backend
                    sendLocationPingToBackend(coords, null, true); // true = manual ping

                    showToast('success', 'ğŸ“ Lokasi Dihantar', `Lat: ${coords.lat.toFixed(6)}, Lng: ${coords.lng.toFixed(6)}`);
                    addAutoNote(`MANUAL PING: ${coords.lat.toFixed(6)}, ${coords.lng.toFixed(6)} (Â±${Math.round(coords.accuracy)}m)`);

                    // Ask if user wants to share via WhatsApp
                    if (confirm('Kongsi lokasi melalui WhatsApp?\nShare location via WhatsApp?')) {
                        shareLocationWhatsApp(coords);
                    }
                },
                (error) => {
                    showToast('error', 'GPS Gagal', 'Unable to get your location: ' + error.message);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 0
                }
            );
        }

        /**
         * Share location using Web Share API (native sharing) or fallback to WhatsApp
         */
        async function shareLocationNative(coords) {
            const googleMapsUrl = `https://www.google.com/maps?q=${coords.lat},${coords.lng}`;
            const shareText = `ğŸ“ Lokasi Semasa / Current Location
Unit: ${appState.unitId}
Crew: ${appState.crewName}
Case: ${appState.currentCase?.callCardNo || 'N/A'}
Lat: ${coords.lat.toFixed(6)}
Lng: ${coords.lng.toFixed(6)}
Map: ${googleMapsUrl}`;
            
            // Try Web Share API first (works on iOS and modern Android)
            if (navigator.share && navigator.canShare) {
                try {
                    await navigator.share({
                        title: 'ğŸ“ MECCHTAR Location',
                        text: shareText,
                        url: googleMapsUrl
                    });
                    showToast('success', 'âœ… Shared', 'Location shared successfully');
                    return;
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        console.log('Web Share failed, falling back to WhatsApp');
                    } else {
                        return; // User cancelled
                    }
                }
            }
            
            // Fallback to WhatsApp
            shareLocationWhatsApp(coords);
        }

        function shareLocationWhatsApp(coords) {
            const googleMapsUrl = `https://www.google.com/maps?q=${coords.lat},${coords.lng}`;
            const message = encodeURIComponent(
                `ğŸ“ Lokasi Semasa / Current Location\n` +
                `Unit: ${appState.unitId}\n` +
                `Crew: ${appState.crewName}\n` +
                `Case: ${appState.currentCase?.callCardNo || 'N/A'}\n` +
                `Lat: ${coords.lat.toFixed(6)}\n` +
                `Lng: ${coords.lng.toFixed(6)}\n` +
                `Map: ${googleMapsUrl}`
            );
            
            // Use wa.me for better cross-platform support
            const whatsappUrl = `https://wa.me/?text=${message}`;
            window.open(whatsappUrl, '_blank');
        }

        function shareLocationTelegram(coords) {
            const googleMapsUrl = `https://www.google.com/maps?q=${coords.lat},${coords.lng}`;
            const message = encodeURIComponent(
                `ğŸ“ Lokasi Semasa / Current Location\n` +
                `Unit: ${appState.unitId}\n` +
                `Crew: ${appState.crewName}\n` +
                `Case: ${appState.currentCase?.callCardNo || 'N/A'}\n` +
                `Lat: ${coords.lat.toFixed(6)}\n` +
                `Lng: ${coords.lng.toFixed(6)}\n` +
                `Map: ${googleMapsUrl}`
            );
            
            // Telegram share URL
            const telegramUrl = `https://t.me/share/url?url=${encodeURIComponent(googleMapsUrl)}&text=${message}`;
            window.open(telegramUrl, '_blank');
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ACTIVE MISSION NAVIGATION FUNCTIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        /**
         * Open messaging dropdown from active mission screen
         */
        function openMesejDropdown() {
            openMessagingMenu();
        }
        
        /**
         * Check pending dispatches from active mission navigation
         */
        function checkPendingDispatchesNav() {
            const pendingCount = (appState.pendingDispatches?.length || 0);
            
            if (pendingCount > 0) {
                // Show dispatch list modal
                openDispatchListModal(appState.pendingDispatches);
            } else if (appState.pendingDispatch) {
                // Single pending dispatch
                if (confirm(`ğŸš¨ 1 Pending Dispatch: ${appState.pendingDispatch.callCardNo || 'Unknown'}\n\nView dispatch details?`)) {
                    showDispatchAlert(appState.pendingDispatch);
                }
            } else {
                // No pending - trigger a check
                showToast('info', 'ğŸ” Checking...', 'Checking for new dispatches...');
                checkForNewDispatches().then(() => {
                    const newCount = (appState.pendingDispatches?.length || 0) + (appState.pendingDispatch ? 1 : 0);
                    if (newCount === 0) {
                        showToast('success', 'ğŸ“­ No Pending', 'No pending dispatches');
                    }
                });
            }
        }
        
        /**
         * Return to main menu temporarily without ending the case
         */
        function returnToMenuTemporary() {
            if (!appState.currentCase) {
                showToast('info', 'â„¹ï¸ No Active Case', 'No active mission to return from');
                document.getElementById('initialMenu').classList.remove('hidden');
                return;
            }
            
            // Hide active mission, show menu
            document.getElementById('activeMission').classList.add('hidden');
            document.getElementById('initialMenu').classList.remove('hidden');
            
            // Show indicator that there's an active case
            showActiveCaseBadge();
            
            showToast('info', 'ğŸ  Menu', 'Case still active - tap to return');
        }
        
        /**
         * Show badge indicating active case when at menu
         */
        function showActiveCaseBadge() {
            // Check if badge already exists
            let badge = document.getElementById('activeCaseBadge');
            if (!badge) {
                badge = document.createElement('div');
                badge.id = 'activeCaseBadge';
                badge.style.cssText = `
                    position: fixed;
                    bottom: 80px;
                    left: 50%;
                    transform: translateX(-50%);
                    background: linear-gradient(135deg, var(--warning), #fbbf24);
                    color: #000;
                    padding: 12px 20px;
                    border-radius: 25px;
                    font-weight: 600;
                    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
                    cursor: pointer;
                    z-index: 1000;
                    animation: pulse 2s infinite;
                `;
                badge.onclick = returnToActiveMission;
                document.body.appendChild(badge);
            }
            
            badge.innerHTML = `ğŸš‘ Active Case: ${appState.currentCase?.callCardNo || 'Unknown'} - Tap to Return`;
            badge.style.display = 'block';
        }
        
        /**
         * Return to active mission from menu
         */
        function returnToActiveMission() {
            if (!appState.currentCase) {
                hideActiveCaseBadge();
                showToast('warning', 'âš ï¸ No Case', 'No active mission found');
                return;
            }
            
            document.getElementById('initialMenu').classList.add('hidden');
            document.getElementById('activeMission').classList.remove('hidden');
            hideActiveCaseBadge();
            
            showToast('success', 'ğŸš‘ Returned', 'Back to active mission');
        }
        
        /**
         * Hide the active case badge
         */
        function hideActiveCaseBadge() {
            const badge = document.getElementById('activeCaseBadge');
            if (badge) {
                badge.style.display = 'none';
            }
        }
        
        /**
         * Update pending dispatch count badge
         */
        function updatePendingDispatchBadge() {
            const count = (appState.pendingDispatches?.length || 0) + (appState.pendingDispatch ? 1 : 0);
            const badge = document.getElementById('pendingDispatchCount');
            if (badge) {
                if (count > 0) {
                    badge.textContent = count;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        function sendLocationPingToBackend(coords, phaseIndex = null, isManual = false) {
            // TODO: Send location ping to backend
            console.log('ğŸ“¡ Sending location ping to backend:', {
                coords,
                phaseIndex,
                isManual,
                unitId: appState.unitId,
                caseId: appState.currentCase?.callCardNo
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // MESSAGING FUNCTIONS (PART 4 - ENHANCED)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function toggleMessagingMenu() {
            const dropdown = document.getElementById('messagingDropdown');
            dropdown.classList.toggle('active');
        }

        function closeMessagingMenu() {
            document.getElementById('messagingDropdown').classList.remove('active');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.messaging-container')) {
                closeMessagingMenu();
            }
        });

        function openMessaging(recipient) {
            closeMessagingMenu();

            const recipientInfo = {
                'dispatcher': { name: 'Dispatcher / MECC', icon: 'ğŸ“¡', phone: CONTACT_NUMBERS.dispatcher },
                'supervisor': { name: 'Supervisor', icon: 'ğŸ‘¨â€ğŸ’¼', phone: CONTACT_NUMBERS.supervisor },
                'hospital': { name: 'Hospital', icon: 'ğŸ¥', phone: CONTACT_NUMBERS.hospital },
                'physician': { name: 'Physician On-Call', icon: 'ğŸ‘¨â€âš•ï¸', phone: CONTACT_NUMBERS.physician }
            };

            const info = recipientInfo[recipient] || { name: 'Unknown', icon: 'â“', phone: '' };

            // Build case context for message
            let caseContext = '';
            if (appState.currentCase) {
                caseContext = `Unit: ${appState.unitId}\nCase: ${appState.currentCase.callCardNo}\nPatient: ${appState.currentCase.patientName || 'N/A'}`;
            } else {
                caseContext = `Unit: ${appState.unitId}`;
            }

            document.getElementById('messagingModalHeader').innerHTML = `ğŸ’¬ Hantar Mesej ke ${info.icon} ${info.name}`;
            document.getElementById('messagingRecipientInfo').innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="font-size: 28px;">${info.icon}</span>
                    <div style="flex: 1;">
                        <div style="font-weight: 600;">${info.name}</div>
                        <div style="font-size: 0.85rem; color: var(--muted);">${info.phone || 'No phone number set'}</div>
                    </div>
                </div>
                <div style="margin-top: 10px; padding: 8px; background: white; border-radius: 6px; font-size: 0.8rem; font-family: monospace;">
                    ${caseContext.replace(/\n/g, '<br>')}
                </div>
            `;
            document.getElementById('messagingContent').value = '';
            document.getElementById('messagingContent').dataset.recipient = recipient;
            document.getElementById('messagingContent').dataset.phone = info.phone;

            openModal('messagingModal');
        }
        
        /**
         * Quick WhatsApp message with case context
         * Opens WhatsApp directly with pre-filled message
         */
        function quickWhatsApp(phone, recipientName) {
            closeMessagingMenu();
            
            if (!phone) {
                showToast('warning', 'âš ï¸ No Number', 'Phone number not configured');
                return;
            }
            
            // Build context message
            let message = `ğŸš‘ MECCHTAR Responder\n`;
            message += `Unit: ${appState.unitId}\n`;
            message += `Crew: ${appState.crewName || 'N/A'}\n`;
            
            if (appState.currentCase) {
                message += `\nğŸ“‹ Case: ${appState.currentCase.callCardNo}\n`;
                message += `ğŸ‘¤ Patient: ${appState.currentCase.patientName || 'N/A'}\n`;
                message += `ğŸ“ Location: ${appState.currentCase.locationSummary || appState.currentCase.location || 'N/A'}\n`;
                
                // Add current phase if available
                if (appState.currentPhase >= 0 && appState.currentPhase < appState.phases.length) {
                    message += `â±ï¸ Phase: ${appState.phases[appState.currentPhase].name}\n`;
                }
            }
            
            message += `\n--- Message ---\n`;
            
            // Clean phone number
            const cleanPhone = phone.replace(/\D/g, '');
            
            // Open WhatsApp with pre-filled message
            const whatsappUrl = `https://wa.me/${cleanPhone}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            
            showToast('success', 'ğŸ“± WhatsApp', `Opening chat with ${recipientName}...`);
            
            // Log the action
            if (appState.currentCase) {
                addAutoNote(`QUICK MSG: WhatsApp to ${recipientName}`);
            }
        }
        
        /**
         * Quick call function
         */
        function quickCall(phone, recipientName) {
            closeMessagingMenu();
            
            if (!phone) {
                showToast('warning', 'âš ï¸ No Number', 'Phone number not configured');
                return;
            }
            
            window.open(`tel:${phone}`, '_self');
            showToast('info', 'ğŸ“ Calling', `Dialing ${recipientName}...`);
            
            if (appState.currentCase) {
                addAutoNote(`CALL: Dialed ${recipientName}`);
            }
        }

        function sendViaWhatsApp() {
            const messageInput = document.getElementById('messagingContent');
            const message = messageInput.value.trim();
            const phone = messageInput.dataset.phone || '';
            const recipient = messageInput.dataset.recipient;

            if (!message) {
                showToast('warning', 'Mesej Kosong', 'Please enter a message');
                return;
            }

            // Build full message with context
            let fullMessage = `ğŸš‘ MECCHTAR Responder\n`;
            fullMessage += `Unit: ${appState.unitId}\n`;
            if (appState.currentCase) {
                fullMessage += `Case: ${appState.currentCase.callCardNo}\n`;
            }
            fullMessage += `\n${message}`;

            const encodedMessage = encodeURIComponent(fullMessage);

            // WhatsApp deep link with optional phone number
            let whatsappUrl;
            if (phone) {
                // Remove non-digits and add country code if needed
                const cleanPhone = phone.replace(/\D/g, '');
                whatsappUrl = `whatsapp://send?phone=${cleanPhone}&text=${encodedMessage}`;
            } else {
                whatsappUrl = `whatsapp://send?text=${encodedMessage}`;
            }

            window.open(whatsappUrl, '_blank');
            closeModal('messagingModal');

            showToast('success', 'ğŸ“± WhatsApp', 'Opening WhatsApp...');
            addAutoNote(`MESEJ (WhatsApp to ${recipient}): ${message.substring(0, 50)}${message.length > 50 ? '...' : ''}`);
        }

        function sendViaTelegram() {
            const messageInput = document.getElementById('messagingContent');
            const message = messageInput.value.trim();
            const recipient = messageInput.dataset.recipient;

            if (!message) {
                showToast('warning', 'Mesej Kosong', 'Please enter a message');
                return;
            }

            // Build full message with context
            let fullMessage = `ğŸš‘ MECCHTAR Responder\n`;
            fullMessage += `Unit: ${appState.unitId}\n`;
            if (appState.currentCase) {
                fullMessage += `Case: ${appState.currentCase.callCardNo}\n`;
            }
            fullMessage += `\n${message}`;

            const encodedMessage = encodeURIComponent(fullMessage);

            // Telegram deep link
            const telegramUrl = `tg://msg?text=${encodedMessage}`;

            window.open(telegramUrl, '_blank');
            closeModal('messagingModal');

            showToast('success', 'âœˆï¸ Telegram', 'Opening Telegram...');
            addAutoNote(`MESEJ (Telegram to ${recipient}): ${message.substring(0, 50)}${message.length > 50 ? '...' : ''}`);
        }

        function sendInApp() {
            const messageInput = document.getElementById('messagingContent');
            const message = messageInput.value.trim();
            const recipient = messageInput.dataset.recipient;

            if (!message) {
                showToast('warning', 'Mesej Kosong', 'Please enter a message');
                return;
            }

            // Build message payload
            const payload = {
                from: appState.unitId,
                fromName: appState.crewName,
                to: recipient,
                message: message,
                caseId: appState.currentCase?.callCardNo || null,
                timestamp: new Date().toISOString()
            };

            // TODO: Send via backend API
            sendMessageToBackend(payload);

            closeModal('messagingModal');
            showToast('success', 'ğŸ“¡ In-App', 'Message sent to Dispatcher');
            addAutoNote(`MESEJ (In-App to ${recipient}): ${message.substring(0, 50)}${message.length > 50 ? '...' : ''}`);
        }

        function sendMessageToBackend(payload) {
            // TODO: Implement backend API call
            console.log('ğŸ“¡ Sending message to backend:', payload);
        }

        // Quick message templates
        function insertQuickMessage(template) {
            const templates = {
                'arrived': 'âœ… Telah tiba di lokasi / Arrived at location',
                'enroute': 'ğŸš¨ Sedang menuju ke lokasi / Enroute to location',
                'transport': 'ğŸš— Memulakan pengangkutan ke hospital / Starting transport to hospital',
                'handover': 'ğŸ¤ Serah terima pesakit selesai / Patient handover complete',
                'delay': 'â° Kemungkinan kelewatan / Possible delay',
                'assistance': 'ğŸ†˜ Memerlukan bantuan tambahan / Need additional assistance'
            };

            const messageInput = document.getElementById('messagingContent');
            if (messageInput && templates[template]) {
                messageInput.value = templates[template];
            }
        }

        // Share current location with message via WhatsApp
        function shareCurrentLocationWhatsApp() {
            if (!navigator.geolocation) {
                showToast('error', 'GPS Error', 'Geolocation not supported');
                return;
            }

            showToast('info', 'ğŸ“ Getting Location...', 'Please wait...');

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const coords = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    appState.currentGPS = coords;

                    const message = document.getElementById('messagingContent').value.trim();
                    const googleMapsUrl = `https://www.google.com/maps?q=${coords.lat},${coords.lng}`;

                    let fullMessage = `ğŸš‘ MECCHTAR Responder\n`;
                    fullMessage += `Unit: ${appState.unitId}\n`;
                    if (appState.currentCase) {
                        fullMessage += `Case: ${appState.currentCase.callCardNo}\n`;
                    }
                    if (message) {
                        fullMessage += `\n${message}\n`;
                    }
                    fullMessage += `\nğŸ“ Lokasi / Location:\n`;
                    fullMessage += `Lat: ${coords.lat.toFixed(6)}\n`;
                    fullMessage += `Lng: ${coords.lng.toFixed(6)}\n`;
                    fullMessage += `Map: ${googleMapsUrl}`;

                    const encodedMessage = encodeURIComponent(fullMessage);
                    const whatsappUrl = `whatsapp://send?text=${encodedMessage}`;

                    window.open(whatsappUrl, '_blank');
                    closeModal('messagingModal');

                    addAutoNote(`LOKASI DIKONGSI (WhatsApp): ${coords.lat.toFixed(6)}, ${coords.lng.toFixed(6)}`);
                    showToast('success', 'ğŸ“ Location Shared', 'Opening WhatsApp with location...');
                },
                (error) => {
                    showToast('error', 'GPS Error', error.message);
                },
                { enableHighAccuracy: true, timeout: 15000 }
            );
        }

        // Share current location with message via Telegram
        function shareCurrentLocationTelegram() {
            if (!navigator.geolocation) {
                showToast('error', 'GPS Error', 'Geolocation not supported');
                return;
            }

            showToast('info', 'ğŸ“ Getting Location...', 'Please wait...');

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const coords = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    appState.currentGPS = coords;

                    const message = document.getElementById('messagingContent').value.trim();
                    const googleMapsUrl = `https://www.google.com/maps?q=${coords.lat},${coords.lng}`;

                    let fullMessage = `ğŸš‘ MECCHTAR Responder\n`;
                    fullMessage += `Unit: ${appState.unitId}\n`;
                    if (appState.currentCase) {
                        fullMessage += `Case: ${appState.currentCase.callCardNo}\n`;
                    }
                    if (message) {
                        fullMessage += `\n${message}\n`;
                    }
                    fullMessage += `\nğŸ“ Lokasi / Location:\n`;
                    fullMessage += `Lat: ${coords.lat.toFixed(6)}\n`;
                    fullMessage += `Lng: ${coords.lng.toFixed(6)}\n`;
                    fullMessage += `Map: ${googleMapsUrl}`;

                    const encodedMessage = encodeURIComponent(fullMessage);
                    const telegramUrl = `tg://msg?text=${encodedMessage}`;

                    window.open(telegramUrl, '_blank');
                    closeModal('messagingModal');

                    addAutoNote(`LOKASI DIKONGSI (Telegram): ${coords.lat.toFixed(6)}, ${coords.lng.toFixed(6)}`);
                    showToast('success', 'ğŸ“ Location Shared', 'Opening Telegram with location...');
                },
                (error) => {
                    showToast('error', 'GPS Error', error.message);
                },
                { enableHighAccuracy: true, timeout: 15000 }
            );
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // AUTO NOTES
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function addAutoNote(note) {
            const timestamp = new Date().toLocaleString('en-MY');
            appState.autoNotes.push(`[${timestamp}] ${note}`);
            console.log('ğŸ“ Auto Note:', note);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // BACKEND COMMUNICATION - REAL IMPLEMENTATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        /**
         * Make API request to backend
         */
        async function backendRequest(action, data = {}) {
            const backendUrl = BACKEND_CONFIG.RESPONDER_BACKEND_URL || appState.settings.backendUrl;
            
            if (!backendUrl) {
                console.warn('âš ï¸ Backend URL not configured');
                return { success: false, error: 'Backend URL not configured' };
            }

            try {
                const response = await fetch(backendUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                    body: JSON.stringify({ action, ...data })
                });

                const result = await response.json();
                console.log(`ğŸ“¡ Backend [${action}]:`, result);
                return result;
            } catch (error) {
                console.error(`âŒ Backend [${action}] Error:`, error);
                return { success: false, error: error.message };
            }
        }

        /**
         * Validate credentials against backend (Live Mode)
         */
        async function validateCredentialsBackend() {
            const result = await backendRequest('validateCredentials', {
                unitId: document.getElementById('loginUnitId').value,
                staffId: document.getElementById('loginStaffId').value,
                password: document.getElementById('loginPassword').value
            });

            return result;
        }

        /**
         * Login to backend
         */
        async function loginToBackend() {
            const result = await backendRequest('login', {
                unitId: appState.unitId,
                staffId: appState.staffId,
                password: document.getElementById('loginPassword').value,
                crewName: appState.crewName,
                shift: appState.shift,
                mode: appState.mode
            });

            if (result.success) {
                appState.sessionId = result.sessionId;
                backendConnected = true;
                console.log('âœ… Backend login successful. Session:', result.sessionId);
            }

            return result;
        }

        /**
         * Logout from backend
         */
        async function logoutFromBackend() {
            if (!appState.sessionId) return;

            await backendRequest('logout', {
                sessionId: appState.sessionId,
                unitId: appState.unitId
            });

            appState.sessionId = null;
            backendConnected = false;
        }

        /**
         * Start polling for new dispatches (Live Mode)
         */
        function startDispatchPolling() {
            if (appState.mode !== 'live') {
                console.log('ğŸ“¡ Demo mode - polling disabled');
                return;
            }

            if (dispatchPollInterval) {
                clearInterval(dispatchPollInterval);
            }

            console.log('ğŸ“¡ Starting dispatch polling...');

            // Initial check
            checkForNewDispatches();

            // Poll at configured interval
            dispatchPollInterval = setInterval(() => {
                checkForNewDispatches();
            }, BACKEND_CONFIG.POLL_INTERVAL);
        }

        /**
         * Stop dispatch polling
         */
        function stopDispatchPolling() {
            if (dispatchPollInterval) {
                clearInterval(dispatchPollInterval);
                dispatchPollInterval = null;
                console.log('ğŸ“¡ Dispatch polling stopped');
            }
        }

        /**
         * Check for new dispatches from backend
         */
        async function checkForNewDispatches() {
            if (!backendConnected && appState.mode === 'live') {
                console.log('ğŸ“¡ Not connected to backend, skipping poll');
                return;
            }

            try {
                const result = await backendRequest('checkDispatches', {
                    resourceCallSign: appState.unitId
                });

                if (result.success && result.dispatches && result.dispatches.length > 0) {
                    console.log(`ğŸš¨ ${result.dispatches.length} new dispatch(es) received!`);
                    
                    // Store all pending dispatches
                    appState.pendingDispatches = result.dispatches.map(d => ({
                        dispatchId: d.DispatchID,
                        ...d.dispatchData,
                        ...d
                    }));
                    
                    // Play notification sound
                    playNotificationSound();
                    
                    if (result.dispatches.length > 1) {
                        // Multiple dispatches - show list for selection
                        showMultipleDispatchesAlert(appState.pendingDispatches);
                    } else {
                        // Single dispatch - show directly
                        appState.pendingDispatch = appState.pendingDispatches[0];
                        if (!appState.currentCase) {
                            showDispatchAlert(appState.pendingDispatch);
                        } else {
                            document.getElementById('pendingDispatchAlert').classList.remove('hidden');
                        }
                    }
                    
                    showToast('warning', 'ğŸš¨ New Dispatch!', `${result.dispatches.length} case(s) pending`);
                    
                    // Update pending dispatch badge
                    updatePendingDispatchBadge();
                }
            } catch (error) {
                console.error('âŒ Error checking dispatches:', error);
            }
        }
        
        /**
         * Show alert when multiple dispatches are pending
         */
        function showMultipleDispatchesAlert(dispatches) {
            if (!appState.currentCase) {
                // Not on mission - show dispatch list modal
                openDispatchListModal(dispatches);
            } else {
                // Already on mission - show badge with count
                const badge = document.getElementById('pendingDispatchAlert');
                badge.classList.remove('hidden');
                badge.innerHTML = `
                    <div style="background: var(--danger); color: white; padding: 8px 12px; border-radius: 8px; cursor: pointer;" onclick="openDispatchListModal()">
                        ğŸš¨ ${dispatches.length} Pending Dispatches - Tap to view
                    </div>
                `;
            }
        }
        
        /**
         * Open modal showing list of pending dispatches
         */
        function openDispatchListModal(dispatches = null) {
            const dispatchList = dispatches || appState.pendingDispatches || [];
            
            if (dispatchList.length === 0) {
                showToast('info', 'ğŸ“­ No Pending', 'No pending dispatches');
                return;
            }
            
            let listHtml = dispatchList.map((d, idx) => `
                <div class="card" style="margin-bottom: 10px; border-left: 4px solid ${d.priority === 'P1' ? 'var(--danger)' : d.priority === 'P2' ? 'var(--warning)' : 'var(--info)'};">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                        <div>
                            <span class="badge" style="background: ${d.priority === 'P1' ? 'var(--danger)' : d.priority === 'P2' ? 'var(--warning)' : 'var(--info)'}; color: white;">
                                ${d.priority || 'P2'}
                            </span>
                            <strong style="margin-left: 8px;">${d.callCardNo || 'Unknown'}</strong>
                        </div>
                        <span style="font-size: 0.8rem; color: var(--muted);">${d.mpdsCode || ''}</span>
                    </div>
                    <div style="font-size: 0.85rem; margin-bottom: 5px;">
                        <strong>ğŸ“</strong> ${d.locationSummary || d.location || 'No location'}
                    </div>
                    <div style="font-size: 0.85rem; color: var(--muted); margin-bottom: 10px;">
                        ${d.mpdsDisplayText || d.chiefComplaint || 'No details'}
                    </div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="btn btn-success btn-sm" onclick="selectDispatchFromList(${idx})">
                            âœ… Select
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="holdDispatchFromList(${idx})">
                            â¸ï¸ Hold
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="rejectDispatchFromList(${idx})">
                            âŒ Reject
                        </button>
                    </div>
                </div>
            `).join('');
            
            document.getElementById('dispatchListContent').innerHTML = listHtml;
            document.getElementById('dispatchListCount').textContent = `${dispatchList.length} Pending Dispatch(es)`;
            openModal('dispatchListModal');
        }
        
        /**
         * Select a dispatch from the list
         */
        function selectDispatchFromList(index) {
            const dispatch = appState.pendingDispatches[index];
            appState.pendingDispatch = dispatch;
            closeModal('dispatchListModal');
            showDispatchAlert(dispatch);
        }
        
        /**
         * Hold/Delay a dispatch with reason
         */
        function holdDispatchFromList(index) {
            const dispatch = appState.pendingDispatches[index];
            const reason = prompt(`â¸ï¸ Hold Case: ${dispatch.callCardNo}\n\nEnter reason for holding this dispatch:`);
            
            if (reason !== null) {
                // Mark as held locally
                dispatch.held = true;
                dispatch.holdReason = reason || 'No reason provided';
                dispatch.holdTime = new Date().toISOString();
                
                showToast('info', 'â¸ï¸ Dispatch Held', `${dispatch.callCardNo} - ${reason || 'Held'}`);
                
                // Log to backend
                if (backendConnected) {
                    backendRequest('holdDispatch', {
                        dispatchId: dispatch.dispatchId || dispatch.DispatchID,
                        callCardNo: dispatch.callCardNo,
                        reason: reason,
                        resourceCallSign: appState.unitId
                    }).catch(e => console.warn('Hold dispatch log failed:', e));
                }
                
                // Refresh the list
                openDispatchListModal();
            }
        }
        
        /**
         * Reject a dispatch with reason
         */
        function rejectDispatchFromList(index) {
            const dispatch = appState.pendingDispatches[index];
            const reason = prompt(`âŒ Reject Case: ${dispatch.callCardNo}\n\nEnter reason for rejecting this dispatch:`);
            
            if (reason !== null && reason.trim() !== '') {
                // Remove from pending list
                appState.pendingDispatches.splice(index, 1);
                
                showToast('warning', 'âŒ Dispatch Rejected', `${dispatch.callCardNo} rejected`);
                
                // Log to backend
                if (backendConnected) {
                    backendRequest('rejectDispatch', {
                        dispatchId: dispatch.dispatchId || dispatch.DispatchID,
                        callCardNo: dispatch.callCardNo,
                        reason: reason,
                        resourceCallSign: appState.unitId
                    }).catch(e => console.warn('Reject dispatch log failed:', e));
                }
                
                // Refresh the list or close if empty
                if (appState.pendingDispatches.length > 0) {
                    openDispatchListModal();
                } else {
                    closeModal('dispatchListModal');
                    showToast('info', 'ğŸ“­ No More Dispatches', 'All dispatches handled');
                }
            } else if (reason === '') {
                showToast('error', 'âŒ Required', 'Please provide a reason for rejection');
            }
        }

        /**
         * Handle incoming dispatch
         */
        function handleIncomingDispatch(dispatch) {
            // Parse dispatch data
            const dispatchData = dispatch.dispatchData || dispatch;
            
            appState.pendingDispatch = {
                dispatchId: dispatch.DispatchID,
                ...dispatchData
            };

            // Play notification sound
            playNotificationSound();

            // Show pending dispatch alert if on menu
            if (!appState.currentCase) {
                showDispatchAlert(appState.pendingDispatch);
            } else {
                // Show pending badge if already on a mission
                document.getElementById('pendingDispatchAlert').classList.remove('hidden');
            }

            showToast('warning', 'ğŸš¨ New Dispatch!', `Case: ${dispatchData.callCardNo || 'N/A'}`);
        }
        
        /**
         * Show the dispatch alert modal/screen
         */
        function showDispatchAlert(dispatch) {
            console.log('ğŸš¨ Showing dispatch alert for:', dispatch.callCardNo);
            
            // Render the dispatch alert content
            renderDispatchAlert(dispatch);
            
            // Show the dispatch alert section
            document.getElementById('dispatchAlert').classList.remove('hidden');
            
            // Hide the initial menu
            document.getElementById('initialMenu').classList.add('hidden');
            
            // Play notification sound again for emphasis
            playNotificationSound();
            
            // Vibrate if supported (mobile)
            if (navigator.vibrate) {
                navigator.vibrate([200, 100, 200, 100, 200]);
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // MANUAL IMPORT DISPATCH (Fallback when system is down)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        /**
         * Open the manual import dispatch modal
         */
        function openImportDispatch() {
            // Clear previous entries - using safe access
            const fieldsToReset = [
                { id: 'manualQuickPaste', value: '' },
                { id: 'manualCallCard', value: '' },
                { id: 'manualPriority', value: 'P2' },
                { id: 'manualMpdsCode', value: '' },
                { id: 'manualChiefComplaint', value: '' },
                { id: 'manualPatientName', value: '' },
                { id: 'manualPatientAge', value: '' },
                { id: 'manualPatientGender', value: '' },
                { id: 'manualLocation', value: '' },
                { id: 'manualLandmark', value: '' },
                { id: 'manualMapsLink', value: '' },
                { id: 'manualCallerName', value: '' },
                { id: 'manualCallerPhone', value: '' },
                { id: 'manualCondition', value: '' },
                { id: 'manualCallTaker', value: '' },
                { id: 'manualDispatcher', value: '' },
                { id: 'manualDestination', value: 'Hospital Tengku Ampuan Rahimah' },
                { id: 'manualPdfLink', value: '' }
            ];
            
            fieldsToReset.forEach(field => {
                const el = document.getElementById(field.id);
                if (el) el.value = field.value;
            });
            
            openModal('importDispatchModal');
        }
        
        /**
         * Parse WhatsApp/SMS message and auto-fill fields
         * Supports MECCHTAR CallTaking and Dispatching message formats
         */
        function parseQuickPaste() {
            const text = document.getElementById('manualQuickPaste').value;
            
            if (!text.trim()) {
                showToast('warning', 'âš ï¸ Empty', 'Please paste a message first');
                return;
            }
            
            console.log('ğŸ” Parsing MECCHTAR message:', text);
            
            let fieldsFound = 0;
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // CALL CARD NUMBER
            // Patterns: "ğŸš¨ MECCHTAR CALL: XXX" or "ğŸ“‹ Call Card: XXX"
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            const callCardPatterns = [
                /ğŸš¨\s*MECCHTAR\s*CALL:\s*([A-Za-z0-9\-:]+)/i,
                /ğŸ“‹\s*Call\s*Card:\s*([A-Za-z0-9\-:]+)/i,
                /Call\s*Card:\s*([A-Za-z0-9\-:]+)/i
            ];
            for (const pattern of callCardPatterns) {
                const match = text.match(pattern);
                if (match) {
                    const callCardEl = document.getElementById('manualCallCard');
                    if (callCardEl) callCardEl.value = match[1].trim();
                    fieldsFound++;
                    break;
                }
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // CALLER NAME & PHONE
            // Patterns: "ğŸ“ Name | Phone" or "ğŸ“ Caller: Name (Phone)"
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            const callerPatterns = [
                /ğŸ“\s*Caller:\s*([^(]+)\s*\(([0-9\s\-]+)\)/i,  // Caller: name (phone)
                /ğŸ“\s*([^|]+)\s*\|\s*([0-9\s\-]+)/i            // name | phone
            ];
            for (const pattern of callerPatterns) {
                const match = text.match(pattern);
                if (match) {
                    const callerNameEl = document.getElementById('manualCallerName');
                    const callerPhoneEl = document.getElementById('manualCallerPhone');
                    if (callerNameEl) callerNameEl.value = match[1].trim();
                    if (callerPhoneEl) callerPhoneEl.value = match[2].replace(/[\s\-]/g, '').trim();
                    fieldsFound++;
                    break;
                }
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // LOCATION / ADDRESS
            // Patterns: "ğŸ“ ALAMAT:" or "ğŸ“ Location:"
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            const locationPatterns = [
                /ğŸ“\s*(?:ğŸ“\s*)?(?:Location:\s*)?(?:ğŸ“\s*)?ALAMAT:\s*([^ğŸ—ºï¸\n]+)/i,
                /ğŸ“\s*Location:\s*([^ğŸ—ºï¸\n]+)/i,
                /ALAMAT:\s*([^ğŸ—ºï¸\n]+)/i
            ];
            for (const pattern of locationPatterns) {
                const match = text.match(pattern);
                if (match) {
                    let locationText = match[1].trim();
                    
                    // Extract landmark if embedded (after "Landmark:")
                    const landmarkInLocation = locationText.match(/Landmark:\s*([^â€¢|]+)/i);
                    if (landmarkInLocation) {
                        const landmarkEl = document.getElementById('manualLandmark');
                        if (landmarkEl) landmarkEl.value = landmarkInLocation[1].trim();
                        // Remove landmark from location string
                        locationText = locationText.replace(/\s*â€¢?\s*Landmark:[^â€¢|]+/i, '');
                    }
                    
                    // Extract access info if present
                    locationText = locationText.replace(/\s*â€¢?\s*Access:[^â€¢|]+/i, '');
                    locationText = locationText.replace(/\s*â€¢?\s*Info:[^â€¢|]+/i, '');
                    
                    // Clean up bullet separators
                    locationText = locationText.replace(/\s*â€¢\s*/g, ', ').replace(/\s*\|\s*/g, ', ');
                    locationText = locationText.replace(/,\s*,/g, ',').replace(/,\s*$/,'').trim();
                    
                    const locationEl = document.getElementById('manualLocation');
                    if (locationEl) locationEl.value = locationText;
                    fieldsFound++;
                    break;
                }
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // PATIENT INFO
            // Patterns: "ğŸ¥ Name | Age | Gender" or "ğŸ¥ Patient: Name, Age, Gender"
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            const patientPatterns = [
                /ğŸ¥\s*Patient:\s*([^,]+),\s*(\d+),\s*([^\n]+)/i,  // Patient: name, age, gender
                /ğŸ¥\s*([^|]+)\s*\|\s*(\d+)\s*\|\s*([^\n]+)/i      // name | age | gender
            ];
            for (const pattern of patientPatterns) {
                const match = text.match(pattern);
                if (match) {
                    const patientNameEl = document.getElementById('manualPatientName');
                    const patientAgeEl = document.getElementById('manualPatientAge');
                    const patientGenderEl = document.getElementById('manualPatientGender');
                    
                    if (patientNameEl) patientNameEl.value = match[1].trim();
                    if (patientAgeEl) patientAgeEl.value = match[2].trim();
                    
                    if (patientGenderEl) {
                        const genderText = match[3].toLowerCase();
                        if (genderText.includes('lelaki') || genderText.includes('male')) {
                            patientGenderEl.value = 'Male';
                        } else if (genderText.includes('perempuan') || genderText.includes('female')) {
                            patientGenderEl.value = 'Female';
                        }
                    }
                    fieldsFound++;
                    break;
                }
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // CHIEF COMPLAINT
            // Patterns: "âš ï¸ Complaint: text" or just "âš ï¸ text"
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            const complaintPatterns = [
                /âš ï¸\s*Complaint:\s*([^\n]+)/i,
                /âš ï¸\s*([^\nğŸš‘ğŸ”]+)/i
            ];
            for (const pattern of complaintPatterns) {
                const match = text.match(pattern);
                if (match) {
                    const complaintEl = document.getElementById('manualChiefComplaint');
                    if (complaintEl) {
                        let complaint = match[1].trim();
                        // Capitalize first letter
                        complaint = complaint.charAt(0).toUpperCase() + complaint.slice(1);
                        complaintEl.value = complaint;
                    }
                    fieldsFound++;
                    break;
                }
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // PRIORITY
            // Patterns: "Priority: P1-P4" or "ğŸ”´ Priority: P1-P4"
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            const priorityPatterns = [
                /Priority:\s*(P[1-4])/i,
                /ğŸ”´\s*Priority:\s*(P[1-4])/i,
                /\b(P[1-4])\b/
            ];
            for (const pattern of priorityPatterns) {
                const match = text.match(pattern);
                if (match) {
                    const priorityEl = document.getElementById('manualPriority');
                    if (priorityEl) priorityEl.value = match[1].toUpperCase();
                    fieldsFound++;
                    break;
                }
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // MPDS CODE
            // Patterns: "Code: XX-X-X" or "Dispatch Code: XX-X-X" or "ğŸ”¢ MPDS: XX"
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            const mpdsPatterns = [
                /(?:Dispatch\s*)?Code:\s*(\d{1,2}-[A-E]-?\d?)/i,
                /ğŸš‘\s*(?:Dispatch\s*)?Code:\s*(\d{1,2}-[A-E]-?\d?)/i,
                /ğŸ”¢\s*MPDS:\s*(\d{1,2})/i,
                /\b(\d{1,2}-[A-E]-\d{1,2})\b/i
            ];
            for (const pattern of mpdsPatterns) {
                const match = text.match(pattern);
                if (match) {
                    const mpdsEl = document.getElementById('manualMpdsCode');
                    if (mpdsEl) mpdsEl.value = match[1].toUpperCase();
                    fieldsFound++;
                    break;
                }
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // GOOGLE MAPS LINK
            // Extract coordinates or full URL
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            const mapsPatterns = [
                /ğŸ—ºï¸\s*(?:Maps:\s*)?(https:\/\/[^\s\n]+)/i,
                /(https:\/\/(?:www\.)?google\.com\/maps[^\s\n]+)/i,
                /(https:\/\/maps\.google\.com[^\s\n]+)/i,
                /(https:\/\/goo\.gl\/maps[^\s\n]+)/i
            ];
            for (const pattern of mapsPatterns) {
                const match = text.match(pattern);
                if (match) {
                    const mapsEl = document.getElementById('manualMapsLink');
                    if (mapsEl) mapsEl.value = match[1].trim();
                    fieldsFound++;
                    break;
                }
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // DISPATCHER INFO
            // Pattern: "DISPATCHER\nName: XXX\nID: XXX"
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            const dispatcherMatch = text.match(/DISPATCHER[\s\S]*?Name:\s*([^\n]+)/i);
            if (dispatcherMatch) {
                const dispatcherEl = document.getElementById('manualDispatcher');
                if (dispatcherEl) dispatcherEl.value = dispatcherMatch[1].trim();
                fieldsFound++;
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // CALL TAKER INFO
            // Pattern: "ğŸ‘¤ Call Taker: XXX (ID: XXX)"
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            const callTakerPatterns = [
                /ğŸ‘¤\s*Call\s*Taker:\s*([^(]+)\s*\(ID:/i,
                /Call\s*Taker:\s*([^(]+)\s*\(ID:/i
            ];
            for (const pattern of callTakerPatterns) {
                const match = text.match(pattern);
                if (match) {
                    const callTakerEl = document.getElementById('manualCallTaker');
                    if (callTakerEl) callTakerEl.value = match[1].trim();
                    fieldsFound++;
                    break;
                }
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // PDF LINK (Dispatch Record PDF)
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            const pdfPatterns = [
                /(https:\/\/[^\s\n]*\.pdf[^\s\n]*)/i,
                /(https:\/\/drive\.google\.com\/[^\s\n]+)/i
            ];
            for (const pattern of pdfPatterns) {
                const match = text.match(pattern);
                if (match) {
                    const pdfEl = document.getElementById('manualPdfLink');
                    if (pdfEl) pdfEl.value = match[1].trim();
                    fieldsFound++;
                    break;
                }
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // CONSCIOUS & BREATHING STATUS
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            const consciousMatch = text.match(/ğŸ‘ï¸\s*Conscious:\s*([^\nâ€¢]+)/i);
            if (consciousMatch) {
                const statusEl = document.getElementById('manualConsciousStatus');
                if (statusEl) statusEl.value = consciousMatch[1].trim();
            }
            
            const breathingMatch = text.match(/ğŸ«\s*Breathing:\s*([^\n]+)/i);
            if (breathingMatch) {
                const statusEl = document.getElementById('manualBreathingStatus');
                if (statusEl) statusEl.value = breathingMatch[1].trim();
            }
            
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            // ADDITIONAL FALLBACK PATTERNS
            // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
            
            // If no structured location, try generic patterns
            if (!document.getElementById('manualLocation')?.value) {
                const fallbackLocation = text.match(/(?:jalan|lorong|taman|kampung|kg\.|no\.?\s*\d+)[^\nâ€¢|]+/i);
                if (fallbackLocation) {
                    document.getElementById('manualLocation').value = fallbackLocation[0].trim();
                    fieldsFound++;
                }
            }
            
            // If no landmark found yet, try standalone pattern
            if (!document.getElementById('manualLandmark')?.value) {
                const landmarkMatch = text.match(/Landmark:\s*([^â€¢|\n]+)/i);
                if (landmarkMatch) {
                    document.getElementById('manualLandmark').value = landmarkMatch[1].trim();
                    fieldsFound++;
                }
            }
            
            // Show result
            if (fieldsFound > 0) {
                showToast('success', 'âœ… Parsed', `${fieldsFound} fields auto-filled from message`);
            } else {
                showToast('warning', 'âš ï¸ No Match', 'Could not parse message format. Please fill manually.');
            }
        }
        
        /**
         * Submit manual dispatch and start mission
         */
        function submitManualDispatch() {
            // Validate required fields
            const chiefComplaint = document.getElementById('manualChiefComplaint').value.trim();
            const location = document.getElementById('manualLocation').value.trim();
            
            if (!chiefComplaint) {
                showToast('error', 'âŒ Required', 'Please enter Chief Complaint / MPDS');
                return;
            }
            
            if (!location) {
                showToast('error', 'âŒ Required', 'Please enter Location / Address');
                return;
            }
            
            // Use provided call card or generate one
            const now = new Date();
            let callCardNo = document.getElementById('manualCallCard')?.value?.trim();
            if (!callCardNo) {
                callCardNo = 'MANUAL-' + now.getFullYear() + 
                    String(now.getMonth() + 1).padStart(2, '0') + 
                    String(now.getDate()).padStart(2, '0') + '-' +
                    String(now.getHours()).padStart(2, '0') + 
                    String(now.getMinutes()).padStart(2, '0') + 
                    String(now.getSeconds()).padStart(2, '0');
            }
            
            // Get values from form
            const priority = document.getElementById('manualPriority').value;
            const mpdsCode = document.getElementById('manualMpdsCode').value || 'MANUAL';
            const patientName = document.getElementById('manualPatientName').value || 'Tidak Diketahui';
            const patientAge = document.getElementById('manualPatientAge').value || '';
            const patientGender = document.getElementById('manualPatientGender').value || '';
            const landmark = document.getElementById('manualLandmark').value || '';
            const mapsLink = document.getElementById('manualMapsLink')?.value || '';
            const callerName = document.getElementById('manualCallerName')?.value || '';
            const callerPhone = document.getElementById('manualCallerPhone').value || '';
            const condition = document.getElementById('manualCondition').value || chiefComplaint;
            const dispatcher = document.getElementById('manualDispatcher').value || 'Manual Entry';
            const destination = document.getElementById('manualDestination').value;
            
            // Build dispatch object
            const manualDispatch = {
                dispatchId: 'MAN-' + Date.now(),
                callCardNo: callCardNo,
                priority: priority,
                mpdsCode: mpdsCode,
                mpdsDisplayText: chiefComplaint,
                dispatchCode: mpdsCode,
                
                patientName: patientName,
                patientAge: patientAge,
                patientGender: patientGender,
                patientCount: '1',
                
                location: location,
                locationSummary: location.substring(0, 50) + (location.length > 50 ? '...' : ''),
                landmark: landmark,
                mapsLink: mapsLink,
                
                callerName: callerName,
                callerPhone: callerPhone,
                callerRelation: callerName ? 'Caller' : '',
                
                chiefComplaint: chiefComplaint,
                condition: condition,
                
                dispatcherName: dispatcher,
                presetDestination: destination,
                
                receivedTime: now.toISOString(),
                dispatchedTime: now.toISOString(),
                
                isManualImport: true,
                isTestCase: false,
                
                fullCallSummary: `ğŸ“¥ MANUAL IMPORT - ${callCardNo}

ğŸš¨ Priority: ${priority}
ğŸ“‹ MPDS: ${mpdsCode} - ${chiefComplaint}

ğŸ‘¤ Patient: ${patientName}
   Age: ${patientAge || 'N/A'} | Gender: ${patientGender || 'N/A'}

ğŸ“ Location: ${location}
   Landmark: ${landmark || 'N/A'}
${mapsLink ? `ğŸ—ºï¸ Maps: ${mapsLink}` : ''}

ğŸ“ Caller: ${callerName || 'N/A'} | ${callerPhone || 'N/A'}

ğŸ¥ Condition: ${condition}

ğŸ“¡ Dispatched by: ${dispatcher}
ğŸ¥ Destination: ${destination}

âš ï¸ This case was manually imported (fallback mode)`
            };
            
            console.log('ğŸ“¥ Manual dispatch created:', manualDispatch);
            
            // Close the modal
            closeModal('importDispatchModal');
            
            // Store as pending dispatch
            appState.pendingDispatch = manualDispatch;
            
            // Show the dispatch alert
            showDispatchAlert(manualDispatch);
            
            // Play notification
            playNotificationSound();
            
            showToast('success', 'âœ… Dispatch Created', `Case: ${callCardNo}`);
            
            // Log the manual import
            addAutoNote(`MANUAL IMPORT: ${callCardNo} - ${chiefComplaint}`);
        }

        /**
         * Accept dispatch and create mission
         */
        async function acceptDispatchBackend(dispatchId) {
            // Get current GPS if available
            let gpsLat = null, gpsLng = null;
            if (appState.currentGPS) {
                gpsLat = appState.currentGPS.lat;
                gpsLng = appState.currentGPS.lng;
            }

            const result = await backendRequest('acceptDispatch', {
                dispatchId: dispatchId,
                crewName: appState.crewName,
                staffId: appState.staffId,
                presetDestination: appState.destination,
                gpsLat: gpsLat,
                gpsLng: gpsLng
            });

            if (result.success) {
                appState.missionId = result.missionId;
                console.log('âœ… Dispatch accepted. Mission ID:', result.missionId);
            }

            return result;
        }

        /**
         * Reject dispatch
         */
        async function rejectDispatchBackend(dispatchId, reason) {
            const result = await backendRequest('rejectDispatch', {
                dispatchId: dispatchId,
                crewName: appState.crewName,
                staffId: appState.staffId,
                reason: reason
            });

            return result;
        }

        /**
         * Send phase update to backend
         */
        async function sendPhaseUpdateToBackend(phaseIndex) {
            if (appState.mode !== 'live' || !appState.missionId) {
                console.log('ğŸ“¡ Phase update (local only):', phaseIndex);
                return;
            }

            const phase = appState.phases[phaseIndex];
            
            const result = await backendRequest('updatePhase', {
                missionId: appState.missionId,
                callCardNo: appState.currentCase?.callCardNo,
                resourceCallSign: appState.unitId,
                phaseIndex: phaseIndex,
                phaseName: phase.name,
                startTime: phase.startTime || null,
                duration: phase.duration,
                targetTime: phase.target,
                onTarget: phase.duration <= phase.target,
                gpsLat: phase.gps?.lat || null,
                gpsLng: phase.gps?.lng || null,
                gpsAccuracy: phase.gps?.accuracy || null,
                isOverride: phase.overridden || false,
                notes: ''
            });

            return result;
        }

        /**
         * Send override info to backend
         */
        async function sendOverrideToBackend() {
            if (appState.mode !== 'live' || !appState.missionId) {
                console.log('ğŸ“¡ Override logged (local only)');
                return;
            }

            const result = await backendRequest('logOverride', {
                missionId: appState.missionId,
                callCardNo: appState.currentCase?.callCardNo,
                resourceCallSign: appState.unitId,
                reason: appState.overrideReason,
                skippedPhases: appState.skippedPhases.map(idx => ({
                    index: idx,
                    name: appState.phases[idx].name,
                    targetTime: appState.phases[idx].target
                }))
            });

            return result;
        }

        /**
         * Send destination change to backend
         */
        async function sendDestinationChangeToBackend(oldDest, newDest, reason) {
            if (appState.mode !== 'live' || !appState.missionId) {
                console.log('ğŸ“¡ Destination change (local only)');
                return;
            }

            const result = await backendRequest('updateDestination', {
                missionId: appState.missionId,
                oldDestination: oldDest,
                newDestination: newDest,
                reason: reason
            });

            return result;
        }

        /**
         * Send location ping to backend
         */
        async function sendLocationPingToBackend(coords, phaseIndex = null, isManual = false) {
            if (appState.mode !== 'live') {
                console.log('ğŸ“¡ Location ping (local only):', coords);
                return;
            }

            const result = await backendRequest('sendLocationPing', {
                missionId: appState.missionId,
                resourceCallSign: appState.unitId,
                callCardNo: appState.currentCase?.callCardNo,
                lat: coords.lat,
                lng: coords.lng,
                accuracy: coords.accuracy || null,
                phaseIndex: phaseIndex,
                isManual: isManual
            });

            return result;
        }

        /**
         * Send message to backend
         */
        async function sendMessageToBackend(payload) {
            if (appState.mode !== 'live') {
                console.log('ğŸ“¡ Message (local only):', payload);
                return;
            }

            const result = await backendRequest('sendMessage', payload);
            return result;
        }

        /**
         * Complete mission and send summary to backend
         */
        async function completeMissionBackend() {
            if (appState.mode !== 'live' || !appState.missionId) {
                console.log('ğŸ“¡ Mission complete (local only)');
                return { success: true };
            }

            // Calculate performance metrics
            const phasesOnTarget = appState.phases.filter((p, i) => 
                p.completed && !p.overridden && p.duration <= p.target
            ).length;
            const performanceScore = Math.round((phasesOnTarget / 10) * 100);

            // Calculate total duration
            let totalDuration = '00:00:00';
            if (appState.missionStartTime && appState.missionEndTime) {
                const diffMs = appState.missionEndTime - appState.missionStartTime;
                totalDuration = formatDuration(Math.floor(diffMs / 1000));
            }

            const result = await backendRequest('completeMission', {
                missionId: appState.missionId,
                crewName: appState.crewName,
                shift: appState.shift,
                totalDuration: totalDuration,
                phasesCompleted: appState.phases.filter(p => p.completed).length,
                phasesOnTarget: phasesOnTarget,
                performanceScore: performanceScore,
                overrideUsed: appState.overrideUsed,
                overrideReason: appState.overrideReason,
                skippedPhases: appState.skippedPhases.join(', '),
                finalDestination: appState.destination,
                notes: appState.freeTextNotes,
                autoNotes: appState.autoNotes.join('\n'),
                dispatchData: appState.currentCase
            });

            return result;
        }

        /**
         * Test backend connection
         */
        async function testBackendConnection() {
            const backendUrl = BACKEND_CONFIG.RESPONDER_BACKEND_URL || appState.settings.backendUrl;
            
            if (!backendUrl) {
                return { success: false, error: 'Backend URL not configured' };
            }

            try {
                const response = await fetch(`${backendUrl}?action=ping`);
                const result = await response.json();
                
                if (result.success) {
                    backendConnected = true;
                    showToast('success', 'âœ… Connected', result.message || 'Backend connected');
                } else {
                    backendConnected = false;
                    showToast('error', 'âŒ Error', result.error || 'Connection failed');
                }
                
                return result;
            } catch (error) {
                backendConnected = false;
                showToast('error', 'âŒ Error', error.message);
                return { success: false, error: error.message };
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // NOTIFICATION SOUND
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function playNotificationSound() {
            if (appState.settings.notificationSound === 'none') return;

            // Create audio context for notification
            try {
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);

                oscillator.frequency.value = 880; // A5
                oscillator.type = 'sine';
                gainNode.gain.value = 0.3;

                oscillator.start();
                setTimeout(() => {
                    oscillator.frequency.value = 1046.5; // C6
                }, 200);
                setTimeout(() => {
                    oscillator.stop();
                }, 400);
            } catch (e) {
                console.warn('Audio not available:', e);
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // TOAST NOTIFICATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function showToast(type, title, message) {
            const container = document.getElementById('toastContainer');
            const icons = {
                success: 'âœ…',
                warning: 'âš ï¸',
                error: 'âŒ',
                info: 'â„¹ï¸'
            };

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <span class="toast-icon">${icons[type] || 'â„¹ï¸'}</span>
                <div class="toast-content">
                    <div class="toast-title">${title}</div>
                    <div class="toast-message">${message}</div>
                </div>
            `;

            container.appendChild(toast);

            // Remove after 3 seconds
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 3000);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // MODAL FUNCTIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Close modal when clicking overlay
        document.querySelectorAll('.modal-overlay').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('active');
                }
            });
        });

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // NAVIGATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function backToMenu() {
            // Hide all content sections
            document.getElementById('dispatchAlert').classList.add('hidden');
            document.getElementById('activeMission').classList.add('hidden');
            document.getElementById('missionComplete').classList.add('hidden');

            // Show initial menu
            document.getElementById('initialMenu').classList.remove('hidden');

            // Check if there's a pending dispatch
            if (appState.pendingDispatch) {
                document.getElementById('pendingDispatchAlert').classList.remove('hidden');
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // END OF PART 1 - FOUNDATION
        // Parts 2-7 will add:
        // - Part 2: Phase tracking system
        // - Part 3: Override system (6-step workflow)
        // - Part 4: Destination & Notes
        // - Part 5: Communication & GPS enhancements
        // - Part 6: Test mode & History
        // - Part 7: Backend integration
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PHASE TRACKING SYSTEM (PART 2)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        let pendingPhaseIndex = null;

        function getNextPhaseIndex() {
            return appState.phases.findIndex(p => !p.completed);
        }

        function renderPhaseTracker() {
            const container = document.getElementById('phaseTrackerContainer');
            if (!container) return;

            container.innerHTML = appState.phases.map((phase, index) => {
                const isCompleted = phase.completed;
                const isActive = !isCompleted && index === getNextPhaseIndex();
                const isPending = !isCompleted && !isActive;

                let statusClass = 'pending';
                if (isCompleted) statusClass = phase.overridden ? 'overridden' : 'completed';
                if (isActive) statusClass = 'active';

                // Duration display
                let durationDisplay = '';
                if (phase.duration !== null) {
                    const mins = Math.floor(phase.duration / 60);
                    const secs = phase.duration % 60;
                    const durationStr = mins > 0 ? `${mins}m ${secs}s` : `${secs}s`;
                    const targetSecs = phase.target;
                    const isOverTarget = phase.duration > targetSecs;
                    durationDisplay = `<span class="phase-duration ${isOverTarget ? 'over-target' : 'on-target'}">${durationStr}</span>`;
                }

                // Override badge
                const overrideBadge = phase.overridden ? '<span class="override-badge">OVERRIDE</span>' : '';

                // Action button
                let actionBtn = '';
                if (isActive) {
                    // Check if this is Transporting and destination not confirmed
                    const isTransporting = phase.name === 'Transporting';
                    const needsDestConfirm = isTransporting && !appState.destinationConfirmed;

                    if (needsDestConfirm) {
                        actionBtn = `<button class="btn btn-warning btn-sm" onclick="promptDestinationConfirmation()">ğŸ¥ Confirm Dest First</button>`;
                    } else {
                        actionBtn = `<button class="btn btn-success btn-sm" onclick="requestPhaseUpdate(${index})">âœ… Mark Done</button>`;
                    }
                }

                return `
                    <div class="phase-item ${statusClass}">
                        <div class="phase-icon">${phase.icon}</div>
                        <div class="phase-info">
                            <div class="phase-name">
                                ${index + 1}. ${phase.name}
                                ${overrideBadge}
                            </div>
                            <div class="phase-time">
                                ${phase.time || (isActive ? 'â³ In progress...' : 'Pending')}
                            </div>
                            <div class="target-indicator">Target: ${formatTarget(phase.target)}</div>
                        </div>
                        ${durationDisplay}
                        <div class="phase-action">${actionBtn}</div>
                    </div>
                `;
            }).join('');

            // Update current phase display
            const nextIdx = getNextPhaseIndex();
            const currentPhaseEl = document.getElementById('currentPhaseDisplay');
            if (currentPhaseEl && nextIdx >= 0 && nextIdx < appState.phases.length) {
                const phase = appState.phases[nextIdx];
                currentPhaseEl.textContent = `${phase.icon} ${phase.name}`;
            } else if (currentPhaseEl && nextIdx === -1) {
                currentPhaseEl.textContent = 'âœ… Mission Complete';
            }
        }

        function formatTarget(seconds) {
            if (seconds >= 60) {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return secs > 0 ? `${mins}m ${secs}s` : `${mins}m`;
            }
            return `${seconds}s`;
        }

        function requestPhaseUpdate(index) {
            const phase = appState.phases[index];

            // Check if we should skip confirmation (global flag or phase-specific)
            if (appState.skipAllConfirmations || appState.skipConfirmations[phase.name]) {
                updatePhase(index);
                return;
            }

            pendingPhaseIndex = index;
            openPhaseConfirmModal(phase);
        }

        function openPhaseConfirmModal(phase) {
            document.getElementById('phaseConfirmTitle').innerHTML = `âœ… Confirm: ${phase.icon} ${phase.name}`;
            document.getElementById('phaseConfirmMessage').textContent = `Mark "${phase.name}" as completed?`;
            openModal('phaseConfirmModal');
        }

        function closePhaseConfirmModal() {
            closeModal('phaseConfirmModal');
            pendingPhaseIndex = null;
        }

        function confirmPhaseUpdate(skipSubsequent = false) {
            if (pendingPhaseIndex === null) return;

            if (skipSubsequent) {
                // Set global flag to skip ALL remaining confirmations (including Transporting)
                appState.skipAllConfirmations = true;
                console.log('â­ï¸ Skipping ALL remaining phase confirmations');
            }

            updatePhase(pendingPhaseIndex);
            closePhaseConfirmModal();
        }

        function updatePhase(index) {
            const phase = appState.phases[index];
            if (phase.completed) return;

            const now = new Date();
            phase.completed = true;
            phase.time = now.toLocaleString('en-MY', {
                year: 'numeric', month: 'short', day: 'numeric',
                hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false
            });

            // Calculate duration from previous phase
            if (index > 0) {
                const prevPhase = appState.phases[index - 1];
                if (prevPhase.time) {
                    const prevTime = new Date(prevPhase.time);
                    phase.duration = Math.floor((now - prevTime) / 1000);
                }
            } else {
                phase.duration = 0;
            }

            // Auto GPS capture
            if (appState.settings.autoGPS === 'on') {
                captureGPS(index);
            }

            // Add auto note
            addAutoNote(`PHASE: ${phase.name} completed`);

            // Send update to backend
            sendPhaseUpdateToBackend(index);

            // Render updated tracker
            renderPhaseTracker();
            showToast('success', 'Phase Complete', `${phase.icon} ${phase.name}`);

            // Check if mission complete
            if (index === appState.phases.length - 1) {
                completeMission();
            }

            // Reset ongoing timer for next phase
            startOngoingPhaseTimer();
        }

        function startOngoingPhaseTimer() {
            if (ongoingPhaseTimerInterval) clearInterval(ongoingPhaseTimerInterval);

            const nextIndex = getNextPhaseIndex();
            if (nextIndex < 0 || nextIndex >= appState.phases.length) return;

            // Get the time the current phase started (when previous phase completed)
            let phaseStartTime;
            if (nextIndex === 0) {
                phaseStartTime = new Date(appState.missionStartTime);
            } else {
                const prevPhase = appState.phases[nextIndex - 1];
                phaseStartTime = prevPhase.time ? new Date(prevPhase.time) : new Date();
            }

            ongoingPhaseTimerInterval = setInterval(() => {
                const now = new Date();
                const diff = Math.floor((now - phaseStartTime) / 1000);
                const mins = Math.floor(diff / 60);
                const secs = diff % 60;

                const timerEl = document.getElementById('ongoingPhaseTimer');
                if (timerEl) {
                    timerEl.textContent = 
                        String(mins).padStart(2, '0') + ':' +
                        String(secs).padStart(2, '0');

                    // Color based on target
                    const target = appState.phases[nextIndex].target;
                    if (diff > target * 1.5) {
                        timerEl.style.background = 'linear-gradient(135deg, #fee2e2, #fecaca)';
                        timerEl.style.color = '#dc2626';
                    } else if (diff > target) {
                        timerEl.style.background = 'linear-gradient(135deg, #fef3c7, #fde68a)';
                        timerEl.style.color = '#92400e';
                    } else {
                        timerEl.style.background = 'linear-gradient(135deg, #dbeafe, #bfdbfe)';
                        timerEl.style.color = '#1e40af';
                    }
                }
            }, 1000);
        }

        function promptDestinationConfirmation() {
            if (appState.destinationConfirmed) {
                showToast('info', 'Destination Confirmed', 'Destination already confirmed');
                return;
            }

            openDestinationModal();
        }

        async function completeMission() {
            console.log('ğŸ completeMission() called');
            
            try {
                appState.missionEndTime = new Date().toISOString();

                // Calculate total time
                const startTime = new Date(appState.missionStartTime || new Date());
                const endTime = new Date(appState.missionEndTime);
                const totalSeconds = Math.max(0, Math.floor((endTime - startTime) / 1000));
                const hours = Math.floor(totalSeconds / 3600);
                const minutes = Math.floor((totalSeconds % 3600) / 60);
                const seconds = totalSeconds % 60;
                const totalTimeStr = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;

                console.log('â±ï¸ Total time:', totalTimeStr);

                // Update status
                document.getElementById('statusIndicator').textContent = 'AVAILABLE';
                document.getElementById('statusIndicator').className = 'status-indicator status-available';

                // Stop timers
                if (missionTimerInterval) clearInterval(missionTimerInterval);
                if (ongoingPhaseTimerInterval) clearInterval(ongoingPhaseTimerInterval);

                // Add to history
                const completedCase = {
                    ...(appState.currentCase || {}),
                    callCardNo: appState.currentCase?.callCardNo || 'UNKNOWN',
                    priority: appState.currentCase?.priority || 'N/A',
                    completedAt: new Date().toLocaleString('en-MY'),
                    totalTime: totalTimeStr,
                    phases: [...appState.phases],
                    autoNotes: [...appState.autoNotes],
                    freeTextNotes: appState.freeTextNotes,
                    overrideUsed: appState.overrideUsed,
                    overrideReason: appState.overrideReason
                };
                appState.completedCases.push(completedCase);
                saveCaseHistory();

                // Add auto note
                addAutoNote(`MISSION COMPLETE: Total time ${totalTimeStr}`);

                // Send completion to backend (Live Mode)
                if (appState.mode === 'live' && appState.missionId) {
                    showToast('info', 'ğŸ”„ Syncing...', 'Sending completion to backend...');
                    try {
                        const result = await completeMissionBackend();
                        if (result.success) {
                            showToast('success', 'âœ… Synced', 'Mission data saved to backend');
                        } else {
                            showToast('warning', 'âš ï¸ Warning', 'Mission complete but backend sync failed');
                        }
                    } catch (backendError) {
                        console.error('Backend sync error:', backendError);
                        showToast('warning', 'âš ï¸ Warning', 'Backend sync failed');
                    }
                }

                // Show completion screen
                console.log('ğŸ“º Showing completion screen...');
                renderMissionComplete(completedCase, totalTimeStr);
                document.getElementById('activeMission').classList.add('hidden');
                document.getElementById('missionComplete').classList.remove('hidden');
                
                // Scroll to top to ensure button is visible
                document.getElementById('missionComplete').scrollTop = 0;
                window.scrollTo(0, 0);

                showToast('success', 'ğŸ‰ Misi Selesai!', `Total time: ${totalTimeStr}`);
                console.log('âœ… completeMission() finished successfully');
                
            } catch (error) {
                console.error('âŒ Error in completeMission:', error);
                
                // Still try to show completion screen even on error
                try {
                    document.getElementById('missionComplete').innerHTML = `
                        <div class="card" style="text-align: center; padding: 20px;">
                            <div style="font-size: 64px; margin-bottom: 15px;">ğŸ‰</div>
                            <h2 style="color: var(--success); margin-bottom: 15px;">Misi Selesai!</h2>
                            <p style="color: var(--muted); margin-bottom: 20px;">Mission completed successfully</p>
                            <button class="btn btn-primary" onclick="returnToReadyState()" style="width: 100%; padding: 12px;">
                                ğŸ  Kembali ke Menu Utama
                            </button>
                        </div>
                    `;
                    document.getElementById('activeMission').classList.add('hidden');
                    document.getElementById('missionComplete').classList.remove('hidden');
                } catch (e) {
                    console.error('Failed to show fallback completion screen:', e);
                }
                
                showToast('error', 'âŒ Error', 'Mission completed with errors');
            }
        }

        function renderMissionComplete(completedCase, totalTimeStr) {
            console.log('ğŸ‰ Rendering mission complete screen', { completedCase, totalTimeStr });
            
            // Safety checks
            const callCardNo = completedCase?.callCardNo || 'Unknown';
            const priority = completedCase?.priority || 'N/A';
            
            // Check for pending dispatches
            const pendingCount = (appState.pendingDispatches?.length || 0) + (appState.pendingDispatch ? 1 : 0);
            const pendingAlert = pendingCount > 0 ? `
                <div style="background: #fef3c7; border: 2px solid var(--warning); border-radius: 10px; padding: 15px; margin-bottom: 20px;">
                    <div style="font-size: 1.1rem; font-weight: 600; color: #92400e;">
                        ğŸš¨ ${pendingCount} Pending Dispatch${pendingCount > 1 ? 'es' : ''} Waiting!
                    </div>
                    <p style="font-size: 0.85rem; color: #a16207; margin-top: 5px;">
                        New case${pendingCount > 1 ? 's' : ''} assigned while you were on mission
                    </p>
                </div>
            ` : '';
            
            document.getElementById('missionComplete').innerHTML = `
                <div class="card" style="text-align: center;">
                    <div style="font-size: 64px; margin-bottom: 15px;">ğŸ‰</div>
                    <h2 style="color: var(--success); margin-bottom: 10px;">Misi Selesai!</h2>
                    <p style="font-size: 1.1rem; color: var(--muted); margin-bottom: 10px;">
                        ${callCardNo} - ${priority}
                    </p>
                    <div class="timer-display" style="font-size: 1.8rem; margin-bottom: 15px;">${totalTimeStr}</div>
                    
                    ${pendingAlert}
                    
                    <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-bottom: 15px;">
                        <button class="btn btn-success btn-sm" onclick="viewPerformanceReview()">ğŸ“Š Review</button>
                        <button class="btn btn-info btn-sm" onclick="viewAllNotes()">ğŸ“ Notes</button>
                    </div>
                    
                    <!-- Main Navigation - ALWAYS VISIBLE -->
                    <div style="border-top: 2px solid var(--border); padding-top: 15px; margin-top: 10px;">
                        <button class="btn btn-primary" onclick="returnToReadyState()" style="width: 100%; padding: 12px; font-size: 1rem;">
                            ğŸ  Kembali ke Menu Utama
                        </button>
                        ${pendingCount > 0 ? `
                            <button class="btn btn-warning" onclick="returnToReadyState()" style="width: 100%; padding: 12px; font-size: 1rem; margin-top: 10px;">
                                ğŸš¨ Lihat ${pendingCount} Dispatch Menunggu
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
            
            console.log('âœ… Mission complete screen rendered');
        }

        function startNewMission() {
            // Reset mission state
            appState.currentCase = null;
            appState.destination = '';
            appState.destinationConfirmed = false;
            appState.destinationChangeReason = '';
            appState.missionStartTime = null;
            appState.missionEndTime = null;
            appState.autoNotes = [];
            appState.freeTextNotes = '';
            appState.overrideUsed = false;
            appState.overrideReason = null;
            appState.skippedPhases = [];
            appState.skipConfirmations = {};
            appState.skipAllConfirmations = false; // Reset global skip flag

            // Reset phases
            appState.phases.forEach(phase => {
                phase.completed = false;
                phase.time = null;
                phase.duration = null;
                phase.overridden = false;
                phase.gps = null;
            });

            // Hide completion screen, show menu
            document.getElementById('missionComplete').classList.add('hidden');
            document.getElementById('initialMenu').classList.remove('hidden');

            // Check for pending dispatches (multiple or single)
            if (appState.pendingDispatches && appState.pendingDispatches.length > 1) {
                // Multiple pending - show list
                showMultipleDispatchesAlert(appState.pendingDispatches);
            } else if (appState.pendingDispatch) {
                // Single pending - show badge
                document.getElementById('pendingDispatchAlert').classList.remove('hidden');
            }
            
            showToast('success', 'âœ… Ready', 'Ready to receive new dispatch');
        }
        
        /**
         * Return to menu/ready state from completion screen
         */
        function returnToReadyState() {
            startNewMission();
        }

        function viewPerformanceReview() {
            // Will be implemented in Part 6
            showToast('info', 'Performance Review', 'Will be implemented in Part 6');
        }

        function viewAllNotes() {
            openNotesModal();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PWA INSTALL PROMPT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        
        let deferredPrompt = null;
        
        // Listen for install prompt
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showInstallButton();
        });
        
        function showInstallButton() {
            // Show install option in menu if available
            const installBtn = document.getElementById('installAppBtn');
            if (installBtn) {
                installBtn.classList.remove('hidden');
            }
        }
        
        async function installApp() {
            if (!deferredPrompt) {
                // Show manual instructions
                showInstallInstructions();
                return;
            }
            
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            
            if (outcome === 'accepted') {
                showToast('success', 'âœ… App Installed', 'MECCHTAR Responder installed!');
            }
            
            deferredPrompt = null;
        }
        
        function showInstallInstructions() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
            const isAndroid = /Android/.test(navigator.userAgent);
            
            let instructions = '';
            
            if (isIOS) {
                instructions = `
                    <div style="text-align: left; padding: 10px;">
                        <h3 style="margin-bottom: 15px;">ğŸ“± Install on iPhone/iPad</h3>
                        <ol style="padding-left: 20px; line-height: 2;">
                            <li>Tap the <strong>Share</strong> button <span style="font-size: 1.2em;">â¬†ï¸</span> at the bottom</li>
                            <li>Scroll down and tap <strong>"Add to Home Screen"</strong></li>
                            <li>Tap <strong>"Add"</strong> in the top right</li>
                        </ol>
                        <p style="margin-top: 15px; color: var(--muted); font-size: 0.85rem;">
                            The app will appear on your home screen like a regular app!
                        </p>
                    </div>
                `;
            } else if (isAndroid) {
                instructions = `
                    <div style="text-align: left; padding: 10px;">
                        <h3 style="margin-bottom: 15px;">ğŸ“± Install on Android</h3>
                        <ol style="padding-left: 20px; line-height: 2;">
                            <li>Tap the <strong>Menu</strong> button <span style="font-size: 1.2em;">â‹®</span> (3 dots)</li>
                            <li>Tap <strong>"Add to Home screen"</strong> or <strong>"Install app"</strong></li>
                            <li>Tap <strong>"Add"</strong> or <strong>"Install"</strong></li>
                        </ol>
                        <p style="margin-top: 15px; color: var(--muted); font-size: 0.85rem;">
                            The app will appear on your home screen like a regular app!
                        </p>
                    </div>
                `;
            } else {
                instructions = `
                    <div style="text-align: left; padding: 10px;">
                        <h3 style="margin-bottom: 15px;">ğŸ’» Install on Desktop</h3>
                        <ol style="padding-left: 20px; line-height: 2;">
                            <li>Look for the <strong>Install</strong> icon in the address bar</li>
                            <li>Or click the menu and select <strong>"Install MECCHTAR Responder"</strong></li>
                        </ol>
                    </div>
                `;
            }
            
            // Show in a modal
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.id = 'installModal';
            modal.style.display = 'flex';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 400px;">
                    <div class="modal-header" style="background: linear-gradient(135deg, #16a34a, #22c55e);">
                        ğŸ“² Install App
                    </div>
                    <div class="modal-body">
                        ${instructions}
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-primary" onclick="this.closest('.modal-overlay').remove()">
                            âœ“ Got it!
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }
        
        // Check if app is already installed
        window.addEventListener('appinstalled', () => {
            showToast('success', 'âœ… Installed', 'App installed successfully!');
            deferredPrompt = null;
        });
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // END OF MECCHTAR RESPONDER APP
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        console.log('ğŸš‘ MECCHTAR Responder App - Part 1 (Foundation) loaded');
        
        // Log PWA status
        if (isInstalledPWA()) {
            console.log('ğŸ“± Running as installed PWA');
        } else {
            console.log('ğŸŒ Running in browser - can be installed as app');
        }
    </script>
</body>
</html>